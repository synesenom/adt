(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("lodash"),exports)}else if(typeof define==="function"&&define.amd){define(["d3","_","exports"],e)}else{t.du=t.du||{};t.du.Widget=e(t.d3,t._)}})(this,function(t,e){"use strict";var r=["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999","#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9"];function n(n,o,a,i){var s;var l="du-widget-"+o+"-"+n;try{if(i){s=t.select(i).append(a).attr("id",l).attr("class","du-widget").style("display","none").style("position","absolute").style("pointer-events","none")}else{s=t.select("body").append(a).attr("id",l).attr("class","du-widget").style("display","none").style("position","absolute").style("pointer-events","none")}}catch(t){console.error("MissingDOMException: there is no DOM, could not add widget")}var u={xDim:"px",yDim:"px",fontWeight:"normal",_categories:{dim:[]},add:function(t,e,r,n,o){u[e]=r;t[e]=function(r){if(o){o(r)}else{u[e]=r}return t};if(typeof n==="string"&&u._categories.hasOwnProperty(n)){u._categories[n].push(e)}}};u.add(this,"relative",false);u.add(this,"x",0,"dim",function(t,e){u.x=t;if(typeof e==="string"&&["px","%"].indexOf(e)>-1)u.xDim=e});u.add(this,"y",0,"dim",function(t,e){u.y=t;if(typeof e==="string"&&["px","%"].indexOf(e)>-1)u.yDim=e});u.add(this,"width",200,"dim");u.add(this,"height",150,"dim");u.add(this,"margins",{left:0,right:0,top:0,bottom:0},"dim",function(t){if(typeof t==="number"){["top","left","bottom","right"].forEach(function(e){u.margins[e]=t})}else{e.forOwn(t,function(e,r){u.margins[r]=t[r]})}});u.add(this,"borders",{left:null,right:null,top:null,bottom:null},null,function(t){if(typeof t==="string"){["top","left","bottom","right"].forEach(function(e){u.borders[e]=t})}e.forOwn(t,function(e,r){u.borders[r]=t[r]})});u.add(this,"fontColor","black");u.add(this,"fontSize",10,"dim");u.add(this,"fontWeight","normal");u.add(this,"label",null);u.add(this,"xLabel",null);u.add(this,"yLabel",null);u.add(this,"tickFormat",function(e){return e>1?t.format(".2s")(e):e});u.add(this,"yTickFormat",function(e){return e>1?t.format(".2s")(e):e});u.add(this,"xTickAngle",null);u.add(this,"yMin",0);u.add(this,"mouseover",null);u.add(this,"mouseleave",null);u.add(this,"click",null);u.add(this,"colors",null);u.add(this,"tooltip",false);var c=function(){function n(t){if(typeof t!=="number"&&typeof t!=="string")return"";return(""+t).replace(/ /g,"__")}function o(r,n){if(r===null||r===undefined||r.length<1){return{x:{min:0,max:1,domain:[.5]},y:{min:0,max:1,domain:[]}}}var o=[t.min(r,function(t){return t.x}),t.max(r,function(t){return t.x})];var a={};var i=[];r.forEach(function(t){if(!a.hasOwnProperty(t.x)){a[t.x]=1;i.push(t.x)}});var s=[];if(typeof r[0].y==="number"){s=[t.min(r,function(t){return t.y}),t.max(r,function(t){return t.y})]}else{var l=[],u=[];e.forOwn(r[0].y,function(e,n){l.push(t.min(r,function(t){return t.y[n]}));u.push(t.max(r,function(t){return t.y[n]}))});s=[t.min(l),t.max(u)]}var c={x:[null,null],y:[null,null]};if(n){e.forOwn(c,function(t,e){[0,1].forEach(function(r){t[r]=n.hasOwnProperty(e)&&n[e][r]!==null?n[e][r]:t[r]})})}return{x:{min:c.x[0]!==null?c.x[0]:o[0],max:c.x[1]!==null?c.x[1]:o[1],domain:i.filter(function(t){return(!c.x[0]||t>=c.x[0])&&(!c.x[1]||t<=c.x[1])})},y:{min:c.y[0]!==null?c.y[0]:s[0],max:c.y[1]!==null?c.y[1]:s[1],domain:[]}}}function a(e,r,n,o){function a(e,r){var n=null;if(typeof e){switch(e){case"number":default:n=t.scaleLinear().domain([r.min,r.max]);break;case"time":n=t.scaleTime().domain([r.min,r.max]);break;case"string":n=t.scaleBand().domain(r.domain).padding(.1);break}}return n}return{x:a(o&&o.x?o.x.type:"number",e.x).range(o&&o.x&&o.x.reverse?[r,0]:[0,r]),y:a(o&&o.y?o.y.type:"number",e.y).range(o&&o.y&&o.y.reverse?[0,n]:[n,0])}}function i(e,r,o,a,i){if(r!==null){if(typeof a==="string"){r.g.selectAll(o).transition();r.g.selectAll(o).transition().duration(i?i:0).style("opacity",function(){return t.select(this).classed(n(a))?1:.1})}else{r.g.selectAll(o).transition();r.g.selectAll(o).transition().duration(i?i:0).style("opacity",1)}}return e}function s(e){if(e===null||e===undefined){return{}}if(e.length>0){if(u.colors===null||u.colors===undefined){return e.sort(function(t,e){return t.localeCompare(e)}).reduce(function(t,e,n){t[e]=r[n%18];return t},{})}if(typeof u.colors==="string"){var n=t.scaleLinear().domain([0,e.length]).range([u.colors,"#fff"]).interpolate(t.interpolateRgb);return e.reduce(function(t,e,r){t[e]=n(r);return t},{})}return u.colors}}return{encode:n,boundary:o,scale:a,highlight:i,colors:s}}();function f(){var e="du-widgets-plot-tooltip";var r=t.mouse(s.node());var n=t.event.pageX;var o=t.event.pageY;var a=s.node().getBoundingClientRect();if(n<a.left+u.margins.left||n>a.right-u.margins.right||o<a.top+u.margins.top||o>a.bottom-u.margins.bottom){t.select("#"+e).style("opacity",0).html("");c.tooltip();return}var i=t.select("#"+e);if(t.select("#"+e).empty()){var l=t.color(u.fontColor);l.opacity=.3;i=t.select("body").append("div").attr("id",e).style("position","absolute").style("background-color","rgba(255, 255, 255, 0.95)").style("border-radius","2px").style("border","solid 1px "+l).style("padding","5px").style("font-family","'Courier', monospace").style("font-size","0.7em").style("color",u.fontColor).style("pointer-events","none").style("left",(a.left+a.right)/2+"px").style("top",(a.top+a.bottom)/2+"px")}var f=c.tooltip([r[0]-u.margins.left,r[1]-u.margins.top]);if(!f){t.select("#"+e).style("opacity",0).html("");c.tooltip();return}i.html("").append("div").style("position","relative").style("width","calc(100% - 10px)").style("line-height","11px").style("margin","5px").style("margin-bottom","10px").style("border-bottom","solid 1px "+u.fontColor).text(f.title);f.plots.sort(function(t,e){return t.id.localeCompare(e.id)}).forEach(function(t){var e=i.append("div").style("position","relative").style("max-width","150px").style("height","10px").style("margin","5px").style("padding-right","10px");e.append("div").style("position","relative").style("width","10px").style("height","10px").style("float","left").style("background-color",t.color);e.append("span").style("position","relative").style("width","calc(100% - 20px)").style("height","10px").style("float","right").style("line-height","11px").html(t.value)});var d=i.node().getBoundingClientRect();var h=d.width;var p=d.height;var y=n+20;var m=o+20;if(y<a.left+u.margins.left+10){y+=u.margins.left+10}else if(y+h>a.right-u.margins.right){y-=h+30}if(m<a.top+u.margins.top+10){m+=u.margins.top+10}else if(m+p>a.bottom-u.margins.bottom){m-=p+30}i.style("opacity",1).transition();i.transition().duration(200).ease(t.easeLinear).style("left",y+"px").style("top",m+"px")}this.id=function(){return l};this.describe=function(e){var r=null;s.on("contextmenu",function(){t.event.preventDefault();if(r===null){r=t.select("body").append("div").style("position","absolute").style("left",t.event.pageX+20+"px").style("top",t.event.pageY-20+"px").style("width","auto").style("max-width","500px").style("padding","10px").style("background","white").style("box-shadow","0 0 1px black").style("border-radius","3px").style("color","black").style("font-size","0.8em").style("line-height","1.35em").html(e)}}).on("mouseleave",function(){if(r!==null){r.remove();r=null}});return this};this.placeholder=function(e){var r=300;var o="du-widget-placeholder-"+n;if(e){s.transition().duration(r).style("opacity",0);if(t.select("#"+o).empty()){var a=i?i:"body";t.select(a).append("div").attr("id",o).style("position","absolute").style("width",u.width+"px").style("height",u.height+"px").style("line-height",u.height+"px").style(u.x>=0?"left":"right",Math.abs(u.x)+u.xDim).style(u.y>=0?"top":"bottom",Math.abs(u.y)+u.yDim).style("text-align","center").style("pointer-events","none").append("span").style("display","inline-block").style("vertical-align","middle").style("line-height","normal").style("font-weight",u.fontWeight).style("font-size",u.fontSize).style("color",u.fontColor).style("opacity",0).html(e).transition().duration(r).style("opacity",1)}}else{s.transition().duration();s.transition().duration(r).style("opacity",1);var l=t.select("#"+o);if(!l.empty()){l.remove()}}return this};var d={build:null,update:null,style:null};this.render=function(t){var e=typeof t==="number"?t:500;if(!this._isBuilt){d.build&&d.build(e);this._isBuilt=true}d.update&&d.update(e);if(u.relative){s.style("position","relative").style("top",null).style("bottom",null).style("left",null).style("right",null)}else{s.style("position","absolute").style(u.x>=0?"left":"right",Math.abs(u.x)+u.xDim).style(u.y>=0?"top":"bottom",Math.abs(u.y)+u.yDim)}s.style("width",u.width+"px").style("height",u.height+"px");s.style("pointer-events",u.tooltip&&c.tooltip?"all":null).on("mousemove",function(){u.tooltip&&c.tooltip&&f()});s.selectAll(".axis path").style("fill","none").style("stroke",u.fontColor).style("stroke-width","1px").style("shape-rendering","crispEdges");s.selectAll(".tick > line").style("stroke",u.fontColor).style("stroke-width","1px").style("shape-rendering","crispEdges");s.selectAll(".tick > text").attr("stroke-width",0).attr("font-family","inherit").style("font-size",u.fontSize+"px").style("fill",u.fontColor);s.style("font-family","inherit");s.selectAll("g").attr("font-family","inherit");d.style&&d.style();s.style("display","block");return this};this.remove=function(){s.remove()};return{widget:s,attr:u,utils:c,render:d}}return n});(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("lodash"),require("topojson"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","_","topojson","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.Map=e(t.d3,t._,t.topojson,t.du.Widget)}})(this,function(t,e,r,n){"use strict";var o=function(t){var e=t||[1,0];this.x=function(){return e[0]};this.y=function(){return e[1]};this.length=function(t){var r=Math.sqrt(e[0]*e[0]+e[1]*e[1]);if(typeof t==="number"){var n=t/r;return new o(e.map(function(t){return t*n}))}return r};this.angle=function(t){var r=Math.atan2(e[1],e[0]);if(typeof t==="number"){var n=Math.sqrt(e[0]*e[0]+e[1]*e[1]);return new o([n*Math.cos(t),n*Math.sin(t)])}return r};this.toArray=function(){return[e[0],e[1]]};this.map=function(t){return new o(t(e))};this.add=function(t){return new o([e[0]+t.x(),e[1]+t.y()])};this.sub=function(t){return new o([e[0]-t.x(),e[1]-t.y()])};this.mult=function(t){return new o(e.map(function(e){return e*t}))}};var a=function(t){var e=t||[1,0,0];this.x=function(){return e[0]};this.y=function(){return e[1]};this.z=function(){return e[2]};this.length=function(t){var r=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);if(typeof t==="number"){return new a(e.map(function(e){return e*t/r}))}return r};this.toLatLon=function(){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return new i([Math.asin(e[2]/t),Math.atan2(e[1],e[0])].map(function(t){return t*180/Math.PI}))};this.add=function(t){return new a([e[0]+t.x(),e[1]+t.y(),e[2]+t.z()])};this.mult=function(t){return new a(e.map(function(e){return e*t}))};this.dot=function(t){return e[0]*t.x()+e[1]*t.y()+e[2]*t.z()};this.cross=function(t){return new a([e[1]*t.z()-e[2]*t.y(),e[2]*t.x()-e[0]*t.z(),e[0]*t.y()-e[1]*t.x()])}};var i=function(t){var e=t||[0,0];this.toArray=function(){return[e[0],e[1]]};this.toVec=function(){var t=e[0]*Math.PI/180,r=e[1]*Math.PI/180;var n=Math.cos(t);return new a([n*Math.cos(r),n*Math.sin(r),Math.sin(t)])}};function s(a,s){var l="du-widgets-map";var u=n.call(this,a,"map","div",s);var c=this;u.attr.add(this,"resource",null);u.attr.add(this,"centerX",0);u.attr.add(this,"centerY",0);u.attr.add(this,"backgroundColor","white");u.attr.add(this,"foregroundColor","black");u.attr.add(this,"borderColor","white");u.attr.add(this,"outClick",null);u.attr.add(this,"noZoom",false);u.attr.add(this,"ready",null);var f=function(){var e=null;var n=null;var o=t.map();function a(){t.json(u.attr.resource,function(a,i){e=r.feature(i.paths,i.paths["objects"]["countries"]).features;e.filter(function(t){return i.info.some(function(e){if(t.id===e.id)return t.name=e.name})}).sort(function(t,e){return t.name.localeCompare(e.name)});n=t.map();i.info.forEach(function(t){n.set(t.name,{name:t.name,capital:t.capital,population:t.population})});e.forEach(function(t,e){o.set(t.name,e)});p._build();u.attr.ready&&u.attr.ready()})}function i(t){return o.has(t)?o.get(t):null}function s(){return e.map(function(t){return{id:t.id,name:t.name}})}function l(t){return t&&n.has(t)?n.get(t).capital:n.values().map(function(t){return{name:t.name,capital:t.capital}})}function c(t){return t&&n.has(t)?n.get(t).population:n.values().map(function(t){return{name:t.name,population:t.population}})}function d(t,e){var r,n,o,a,i,s=t[0],l=t[1],u=false;for(var c=0,f=e.length-1;c<e.length;f=c++){r=e[c][0];o=e[c][1];n=e[f][0];a=e[f][1];i=o>l!==a>l&&s<(n-r)*(l-o)/(a-o)+r;if(i)u=!u}return u}function h(t,e){var r=f._id(t);if(r){var n=p._project(e);var o=f._paths()[r].svg.areas;for(var a=0;a<o.length;a++){if(d(n,o[a])){return true}}}return false}return{_paths:function(){return e},_id:i,_build:a,get:s,capital:l,population:c,containsGeoLoc:h}}();this.countries={get:f.get,capital:f.capital,population:f.population,containsGeoLoc:f.containsGeoLoc};var d=function(){var t={};function r(t,e){return u.utils.encode(t)+"__"+u.utils.encode(e)}function n(e){if(e&&t.hasOwnProperty(e)){return Object.keys(t[e])}else{return Object.keys(t)}}function o(e,r){if(!t.hasOwnProperty(e)){t[e]=r;return true}else{return false}}function a(n){if(t.hasOwnProperty(n)){e.forOwn(t[n],function(t,e){var o=r(n,e);t.forEach(function(t){if(typeof f._id(t)==="number"){p._select(t).classed(o,false)}})});return true}else{return false}}function i(){e.forOwn(t,function(t,n){e.forOwn(t,function(t,e){var o=r(n,e);t.forEach(function(t){if(typeof f._id(t)==="number"){p._select(t).classed(o,true)}})})})}return{get:n,add:o,remove:a,selector:r,_mark:i}}();this.clustering={get:d.get,add:d.add,remove:d.remove,selector:d.selector};var h=function(){var e=128;var r=.3;var n={};var o=t.zoomIdentity;var a=1;var i=t.zoom().scaleExtent([1,e]).on("zoom",h);function s(t){return o.apply(t)}function l(t){return o.invert(t)}function c(){return a}function f(){i.translateExtent([[-r*u.attr.width,-r*u.attr.height],[(1+r)*u.attr.width,(1+r)*u.attr.height]])}function d(t,e){n[t]=e}function h(){if(u.attr.noZoom){return}var e=t.event.transform.k;n.map.paths.style("stroke-width",.5/e+"px");n.map.paths.attr("transform",t.event.transform);y._zoom(t.event.transform);m._zoom(t.event.transform);g._zoom(t.event.transform);if(t.event&&t.event.transform){o=t.zoomIdentity.translate(t.event.transform.x,t.event.transform.y).scale(t.event.transform.k);a=t.event.transform.k}}function p(){n.map.svg.transition().duration(1e3).call(i.transform,t.zoomIdentity)}function v(r){var o=r[1][0]-r[0][0],a=r[1][1]-r[0][1],s=(r[0][0]+r[1][0])/2,l=(r[0][1]+r[1][1])/2,c=Math.max(1,Math.min(e,.8/Math.max(o/u.attr.width,a/u.attr.height))),f=[u.attr.width/2-c*s,u.attr.height/2-c*l];n.map.svg.transition().duration(1e3).call(i.transform,t.zoomIdentity.translate(f[0],f[1]).scale(c))}function x(){return o}return{init:f,setLayer:d,zoom:i,reset:p,click:v,transform:s,invert:l,level:c,current:x}}();var p=function(){var e=u.widget.append("svg").attr("id",l+"-map-layer").style("position","absolute").call(h.zoom);var r=e.append("rect").attr("id","water").style("position","absolute").style("width","100%").style("height","100%").style("fill","transparent").style("top",0).style("left",0);var n=e.append("g").attr("id","land");var o=null;var a=t.geoMercator().precision(.1);var i=t.geoPath().projection(a);var s=null;function d(t){return a([t[1],t[0]])}function p(){f._paths().forEach(function(t){t.svg.center=i.centroid(t)})}function y(){f._paths().forEach(function(e){var r=[];var n=[];var o=e.geometry.coordinates;if(o.length===1){o[0].forEach(function(t){var o=a(t);r.push(Math.abs(o[0]-e.svg.center[0]));n.push(Math.abs(o[1]-e.svg.center[1]))})}else{o.forEach(function(t){t[0].forEach(function(t){var o=a(t);r.push(Math.abs(o[0]-e.svg.center[0]));n.push(Math.abs(o[1]-e.svg.center[1]))});if(t.length>1){t.forEach(function(t){var o=a(t);r.push(Math.abs(o[0]-e.svg.center[0]));n.push(Math.abs(o[1]-e.svg.center[1]))})}})}e.svg.width=t.max(r)*2;e.svg.height=t.max(n)*2})}function m(){f._paths().forEach(function(t){t.svg.areas=null;if(t.geometry.coordinates.length===1){var e=[];t.geometry.coordinates[0].forEach(function(t){e.push(a(t))});t.svg.areas=[e]}else{t.svg.areas=[];t.geometry.coordinates.forEach(function(e){var r=[];if(e.length>1){e.forEach(function(t){r.push(a(t))})}else{e[0].forEach(function(t){r.push(a(t))})}t.svg.areas.push(r)})}})}function g(t){if(t.geometry.coordinates.length===1){return i.centroid(t)}else{var e={type:"Feature",geometry:{type:"Polygon",coordinates:t.geometry.coordinates[0]}};for(var r=1;r<t.geometry.coordinates.length;r++){var n={type:"Feature",geometry:{type:"Polygon",coordinates:t.geometry.coordinates[r]}};if(i.area(n)>i.area(e)){e=n}}var o=i.centroid(e);if(isNaN(o[0])||isNaN(o[1]))return i.centroid(t);else return o}}function v(){o=n.selectAll("path").data(f._paths()).enter().append("path").attr("class",function(t){return"country-"+f._id(t.name)}).style("stroke-width","0.5px").style("cursor","pointer");x();b()}function x(){if(o===null){return}a.scale(u.attr.width/(2*Math.PI)).translate([u.attr.width/2+u.attr.centerX,u.attr.height/2+u.attr.centerY]);i=t.geoPath().projection(a);f._paths().forEach(function(t){t.svg={}});p();y();m()}function b(){if(o===null){return}e.attr("width",u.attr.width+"px").attr("height",u.attr.height+"px");r.style("fill",u.attr.backgroundColor).style("width",u.attr.width+"px").style("height",u.attr.height+"px").on("click",function(){console.log("clicked!");h.reset();o.classed("focus",false).style("fill",function(t){return u.attr.colors&&u.attr.colors[t.name]?u.attr.colors[t.name]:u.attr.foregroundColor});if(u.attr.outClick)u.attr.outClick()});o.attr("d",i).style("fill",function(t){return u.attr.colors&&u.attr.colors[t.name]?u.attr.colors[t.name]:u.attr.foregroundColor}).style("stroke",u.attr.borderColor).style("cursor","pointer").on("mouseover",function(e,r){t.select(this).style("fill",t.color(u.attr.colors&&u.attr.colors[e.name]?u.attr.colors[e.name]:u.attr.foregroundColor).brighter());u.attr.mouseover&&u.attr.mouseover(e.name)}).on("mouseleave",function(e,r){var n=t.select(this);var o=t.color(u.attr.colors&&u.attr.colors[e.name]?u.attr.colors[e.name]:u.attr.foregroundColor);n.style("fill",n.classed("focus")?o.brighter():o);u.attr.mouseleave&&u.attr.mouseleave(e.name)}).on("click",function(e,r){var n=t.select(this);var a=n.classed("focus");if(a)h.reset();else{h.click(i.bounds(e))}o.classed("focus",function(t){return t===e?!a:false}).style("fill",function(t){return u.attr.colors&&u.attr.colors[t.name]?u.attr.colors[t.name]:u.attr.foregroundColor});var s=t.color(u.attr.colors&&u.attr.colors[e.name]?u.attr.colors[e.name]:u.attr.foregroundColor);n.style("fill",!a?s.brighter():s);u.attr.click&&u.attr.click(e.name)});h.setLayer("map",{svg:e,paths:o,labels:s})}function w(t){if(typeof t==="string"){return f._id(t)?n.select("path.country-"+f._id(t)):n.selectAll("path."+u.utils.encode(t))}else{return o}}function _(t){o.style("opacity",t?t:1);return c}function k(e,r,n){w(e).transition().duration(n?n:0).style("fill",function(n){var o=u.attr.colors&&u.attr.colors[n.name]?u.attr.colors[n.name]:u.attr.foregroundColor;return typeof r==="string"?r:typeof e==="string"?t.color(o).brighter():o});return c}return{_select:w,_project:d,_build:v,_update:x,_style:b,dim:_,highlight:k}}();this.dim=p.dim;this.highlight=p.highlight;var y=function(){var t=u.widget.append("div").attr("id",l+"-static-layers").style("position","absolute").style("pointer-events","none").style("width",u.attr.width+"px").style("height",u.attr.height+"px");var r={};function n(t,e,r){return[e[0]*t[0]+r[0],e[1]*t[1]+r[1]]}function a(){return Object.keys(r)}function s(e){var a=u.utils.encode(e);if(!r.hasOwnProperty(a)){r[a]=function(){var e=t.append("canvas").attr("id",l+"-static-layer-"+a).attr("width",u.attr.width+"px").attr("height",u.attr.height+"px").style("position","absolute").style("pointer-events","none");var r=e.node().getContext("2d");var i=[];function s(t,e){d[t](e);i.push({type:t,params:e});return true}function c(t,e){var r=[1/t,1/t],a=[u.attr.centerX*(t-1)/t,(u.attr.height*(t-e)/2+u.attr.centerY*(t-1))/t];i.forEach(function(t){switch(t.type){case"dot":case"circle":t.params.pos=n(t.params.pos,r,a);break;case"arrow":for(var e=0;e<t.params.segments.length;e++){t.params.segments[e]=new o(n(t.params.segments[e].toArray(),r,a))}break}})}function f(){i=[]}var d={dot:function(t,e){if(t.color)r.fillStyle=t.color;var n=t.size/(e?h.level():1);var o=!e?h.transform(t.pos):t.pos;r.fillRect(o[0]-n/2,o[1]-n/2,n,n)},circle:function(t,e){if(t.color)r.fillStyle=t.color;var n=t.radius/(e?h.level():1);var o=!e?h.transform(t.pos):t.pos;r.beginPath();r.arc(o[0],o[1],n,0,2*Math.PI,false);r.fill()},arrow:function(t,e){if(t.color)r.strokeStyle=t.color;var n=t.width/(e?h.level():1);var o=[];t.segments.forEach(function(t){o.push(!e?t.map(h.transform):t)});var a=n*2;var i=n*5;var s=o[o.length-2];var l=o[o.length-1];var c=l.sub(s).length(i);r.beginPath();r.lineWidth=n;r.lineJoin="round";r.moveTo(o[0].x(),o[0].y());for(var f=1;f<o.length-1;f++){if(o[f].sub(o[f-1]).length()<.6*u.attr.width)r.lineTo(o[f].x(),o[f].y());else r.moveTo(o[f].x(),o[f].y())}var d=l.sub(c.length(.5*i));r.lineTo(d.x(),d.y());r.stroke();var p=c.angle(c.angle()+Math.PI/2).length(a);var y=l.sub(c).sub(p);var m=l.sub(c).add(p);r.beginPath();r.moveTo(y.x(),y.y());r.lineTo(m.x(),m.y());r.lineTo(l.x(),l.y());r.closePath();r.fillStyle=t.color;r.fill()}};function p(){var t=h.invert([0,0]);var e=h.invert([u.attr.width,u.attr.height]);var r={xMin:t[0],xMax:e[0],yMin:t[1],yMax:e[1]};i.forEach(function(t){if(t.params.pos&&(t.params.pos[0]<r.xMin||t.params.pos[0]>r.xMax||t.params.pos[1]<r.yMin||t.params.pos[1]>r.yMax)){return}d[t.type](t.params,true)})}return{g:e,canvas:r,rescaleContent:c,clearContent:f,append:s,render:p}}();return true}else{return false}}function f(){var n=parseFloat(t.style("width"))/u.attr.width;var o=parseFloat(t.style("height"))/u.attr.height;t.style("width",u.attr.width+"px").style("height",u.attr.height+"px");e.forOwn(r,function(t){t.g.attr("width",u.attr.width+"px").attr("height",u.attr.height+"px");t.rescaleContent(n,o);t.render()});w(h.current())}function d(t){var e=u.utils.encode(t);if(r.hasOwnProperty(e)){r[e].canvas.clearRect(0,0,u.attr.width,u.attr.height);r[e].clearContent();return true}else{return false}}function m(){e.forOwn(r,function(t){t.canvas.save();t.canvas.clearRect(0,0,u.attr.width,u.attr.height)})}function g(t){var n=u.utils.encode(t);if(n&&r.hasOwnProperty(n)){e.forOwn(r,function(t,e){t.g.transition().duration(100).style("opacity",n===e?1:0)})}else{e.forOwn(r,function(t){t.g.transition().duration(100).style("opacity",1)})}return c}function v(t){e.forOwn(r,function(e){e.render(t)})}function x(){e.forOwn(r,function(t){t.canvas.restore()})}var b={dot:function(t,e,n,o){if(!e||e.length<2||typeof e[0]!=="number"||typeof e[1]!=="number")return false;var a=u.utils.encode(t);return r.hasOwnProperty(a)&&r[a].append("dot",{pos:p._project(e),size:n,color:o})},circle:function(t,e,n,o){if(!e||e.length<2||typeof e[0]!=="number"||typeof e[1]!=="number")return false;if(typeof n!=="number"||isNaN(n)||n<=0)return false;var a=u.utils.encode(t);return r.hasOwnProperty(a)&&r[a].append("circle",{pos:p._project(e),radius:n,color:o})},arrow:function(t,e,n,a,s){if(!e||e.length<2||typeof e[0]!=="number"||typeof e[1]!=="number")return false;if(!n||n.length<2||typeof n[0]!=="number"||typeof n[1]!=="number")return false;if(typeof a!=="number")return false;var l=u.utils.encode(t);if(r.hasOwnProperty(l)){var c=new i(e).toVec(),f=new i(n).toVec(),d=c.cross(f).cross(c).length(1),h=Math.acos(c.dot(f));var y=1,m=100,g=a*5,v=new o(p._project(e)),x=new o(p._project(n)),b=v,w=[b];do{var _=new o(p._project(c.mult(Math.cos((y+1)*h/m)).add(d.mult(Math.sin((y+1)*h/m))).toLatLon().toArray()));y++;b=_;w.push(_)}while(y<m&&_.sub(x).length()>g);w.push(x);r[l].append("arrow",{segments:w,width:a,color:s});return true}else{return false}}};function w(t){y._clear();e.forOwn(r,function(e){e.canvas.translate(t.x,t.y);e.canvas.scale(t.k,t.k)});y._render(t.k);y._restore()}return{_style:f,_zoom:w,_clear:m,_restore:x,_render:v,get:a,add:s,highlight:g,erase:d,draw:b}}();this.staticLayer={get:y.get,add:y.add,erase:y.erase,highlight:y.highlight,draw:y.draw};var m=function(){var r=u.widget.append("div").attr("id",l+"-dynamic-layers").style("position","absolute").style("pointer-events","none");var n={};function a(){return Object.keys(n)}function s(e){var o=u.utils.encode(e);if(!n.hasOwnProperty(o)){n[o]=function(){var e=r.append("svg").attr("id",l+"-dynamic-layer-"+o).attr("width",u.attr.width+"px").attr("height",u.attr.height+"px").style("position","absolute").style("pointer-events","none").append("g");var n=[];function a(t){n.push({elem:t,birth:(new Date).getTime()/1e3})}setInterval(function(){var e=(new Date).getTime()/1e3;var r=[];n.forEach(function(n){if(e-n.birth>10){n.elem.transition().duration(700).style("opacity",0).on("end",function(){t.select(this).remove()})}else{r.push(n)}});n=r},2e3);return{g:e,append:a}}();return true}else{return false}}function f(){r.style("width",u.attr.width+"px").style("height",u.attr.height+"px");e.forOwn(n,function(t){t.g.attr("width",u.attr.width+"px").attr("height",u.attr.height+"px")})}function d(t){var e=u.utils.encode(t);if(n.hasOwnProperty(e)){n[e].g.html("");return true}else{return false}}function y(t){var r=u.utils.encode(t);if(r&&n.hasOwnProperty(r)){e.forOwn(n,function(t,e){t.g.transition().duration(200).style("opacity",r===e?1:0)})}else{e.forOwn(n,function(t){t.g.transition().duration(200).style("opacity",1)})}return c}var m={circle:function(e,r,o,a,i,s){if(!r||r.length<2||typeof r[0]!=="number"||typeof r[1]!=="number")return false;if(typeof o!=="number"||isNaN(o)||o<=0)return false;var l=u.utils.encode(e);if(n.hasOwnProperty(l)){var c=o/h.level();var f=p._project(r);var d=n[l].g.append("circle").attr("class","circle").attr("cx",f[0]).attr("cy",f[1]).attr("r",c).style("fill",a);n[l].append(d);d.transition().duration(i?i:700).ease(t.easeExp).attr("r",0).on("end",function(){s&&s();t.select(this).remove()});return true}else{return false}},arrow:function(e,r,a,s,l,c,f){if(!r||r.length<2||typeof r[0]!=="number"||typeof r[1]!=="number")return false;if(!a||a.length<2||typeof a[0]!=="number"||typeof a[1]!=="number")return false;if(typeof s!=="number")return false;var d=u.utils.encode(e);if(n.hasOwnProperty(d)){var y=100;var m=null;var g=null;var v=new o(p._project(r));var x=new o(p._project(a));var b=s/h.level();var w=b*2;var _=b*5;m=n[d].g.append("path").style("fill","none").style("stroke",l).style("stroke-width",b).attr("d","M"+v.x()+","+v.y());g=n[d].g.append("path").style("fill",l).style("stroke","none");var k=new i(r).toVec();var M=new i(a).toVec();var O=k.cross(M).cross(k).length(1);var C=Math.acos(k.dot(M));var P=1;var E=v;var z=(typeof c==="number"?c:700)/y;var j=setInterval(function(){var e=new o(p._project(k.mult(Math.cos((P+1)*C/y)).add(O.mult(Math.sin((P+1)*C/y))).toLatLon().toArray()));m.attr("d",m.attr("d")+(e.sub(E).length()<.5*u.attr.width?"L":"M")+e.x()+","+e.y());if(e.sub(E).length()<.5*u.attr.width){var r=e.sub(E).length(1);var n=r.angle(r.angle()+Math.PI/2).mult(w);var a=e.sub(n);var i=e.add(n);var s=e.add(r.mult(_));g.attr("d","M"+a.x()+","+a.y()+"L"+i.x()+","+i.y()+"L"+s.x()+","+s.y()+"Z")}if(e.sub(x).length()>_){P++;E=e}else{clearInterval(j);r=x.sub(e).length(1);n=r.angle(r.angle()+Math.PI/2).mult(w);a=x.sub(r.mult(_)).sub(n);i=x.sub(r.mult(_)).add(n);g.transition().duration(z).attr("d","M"+a.x()+","+a.y()+"L"+i.x()+","+i.y()+"L"+x.x()+","+x.y()+"Z").on("end",function(){f&&f();m.transition().duration(1e3).style("opacity",0).on("end",function(){t.select(this).remove()});t.select(this).transition().duration(1e3).style("opacity",0).on("end",function(){t.select(this).remove()})})}},z);return true}else{return false}}};function g(t){e.forOwn(n,function(e){e.g.attr("transform",t)})}return{_style:f,_zoom:g,get:a,add:s,highlight:y,erase:d,draw:m}}();this.dynamicLayer={get:m.get,add:m.add,highlight:m.highlight,erase:m.erase,draw:m.draw};var g=function(){var t=u.widget.append("svg").attr("id",l+"-touch-layer").attr("width",u.attr.width+"px").attr("height",u.attr.height+"px").style("position","absolute").style("pointer-events","none");var e=t.append("g");function r(t,r,n,o,a,i){if(!r||r.length<2||typeof r[0]!=="number"||typeof r[1]!=="number")return false;var s=n/h.level();var u=p._project(r);e.append("circle").attr("id",l+"-touch-layer-"+t).attr("cx",u[0]).attr("cy",u[1]).attr("r",s).style("fill",null).style("opacity",0).style("pointer-events","all").on("mouseover",function(t,e){if(o)o(t,e)}).on("mouseleave",function(t,e){if(a)a(t,e)}).on("click",function(t,e){if(i)i(t,e)});return true}function n(t){var r=e.select("#"+t);if(r.empty())return false;else{r.remove();return true}}function o(){t.style("width",u.attr.width+"px").style("height",u.attr.height+"px");e.style("width",u.attr.width+"px").style("height",u.attr.height+"px")}function a(t){e.attr("transform",t)}function i(){e.html("")}return{_style:o,_zoom:a,add:r,remove:n,erase:i}}();this.touchLayer={add:g.add,remove:g.remove,erase:g.erase};u.render.build=function(){f._build()};u.render.update=function(){p._update()};u.render.style=function(){u.widget.style("background-color",u.attr.backgroundColor).style("pointer-events",null);h.init();p._style();y._style();m._style();g._style();d._mark()}}s.prototype=Object.create(n.prototype);return s});