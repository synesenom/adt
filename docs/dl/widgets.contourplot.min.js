(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","d3-contour","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.ContourPlot=e(t.d3,t.du.Widget)}})(this,function(p,a){"use strict";function t(t,e){var s=a.call(this,t,"contourplot","svg",e);s.attr.add(this,"opacity",.5);s.attr.add(this,"layers",20);var u={};var c=[];var f=null;var d=null;var o=false;var x=50,y=25;this.data=function(t){c={xDomain:p.extent(t,function(t){return t.x}),yDomain:p.extent(t,function(t){return t.y}),values:new Array(x*y).fill(0)};var a=(c.xDomain[1]-c.xDomain[0])/x,n=(c.yDomain[1]-c.yDomain[0])/y;t.forEach(function(t){var e=Math.floor((t.x-c.xDomain[0])/a),r=Math.floor((t.y-c.yDomain[0])/n);c.values[e+r*x]+=t.value||1});return this};s.utils.tooltip=function(t){if(d===null||!t){return null}var e=u.scale.x.invert(t[0]),r=u.scale.y.invert(t[1]);var a=(c.xDomain[1]-c.xDomain[0])/x,n=(c.yDomain[1]-c.yDomain[0])/y;var o=Math.floor((e-c.xDomain[0])/a),i=y-Math.floor((r-c.yDomain[0])/n);var l=c.values[o+x*i];if(typeof l==="undefined"){return null}return{title:"Value: "+l.toPrecision(3),stripe:f(d.value),content:{type:"metrics",data:[{label:s.attr.xLabel+":",value:s.attr.tooltipXFormat(e)},{label:s.attr.yLabel+":",value:s.attr.tooltipYFormat(r)}]}}};function r(s,u){return function(){var a=this,n=a.cloneNode(),o=a.getTotalLength(),i=(n.setAttribute("d",s),n).getTotalLength();var t=[0],e=0,r=u/Math.max(o,i);while((e+=r)<e){t.push(e)}t.push(1);var l=t.map(function(t){var e=a.getPointAtLength(t*o),r=n.getPointAtLength(t*i);return p.interpolate([e.x,e.y],[r.x,r.y])});return function(e){return e<1?"M"+l.map(function(t){return t(e)}).join("L"):s}}}s.render.build=function(){u=s.utils.standardAxis();u.plots={}};s.render.update=function(t){u.scale={x:s.utils.scale(c.xDomain,[0,s.attr.innerWidth]),y:s.utils.scale(c.yDomain,[s.attr.innerHeight,0])};var e=p.interpolateHsl(s.attr.colors?s.attr.colors[0]:"transparent",s.attr.colors?s.attr.colors[1]:"grey"),r=p.interpolateHsl(s.attr.colors?s.attr.colors[1]:"grey",s.attr.colors?s.attr.colors[2]:"black"),a=function(t){return t<.5?e(t*2):r((t-.5)*2)};f=p.scaleSequential(a).domain(p.extent(c.values));var n=p.contours().size([x,y]).thresholds(s.attr.layers)(c.values);u.axes.x.transition().duration(t).call(u.axisFn.x.tickValues(s.attr.xTicks).scale(u.scale.x));u.axes.y.transition().duration(t).call(u.axisFn.y.tickValues(s.attr.yTicks).scale(u.scale.y));u.plots.contours=u.g.selectAll(".contour").data(n);u.plots.contours.exit().transition().duration(t).style("opacity",0).remove();u.plots.contours.enter().append("path").attr("class","contour").attr("d",p.geoPath()).attr("transform","translate(1, 0) scale("+s.attr.innerWidth/x+","+s.attr.innerHeight/y+")").attr("fill",function(t){return f(t.value)}).style("stroke","none").style("opacity",0).merge(u.plots.contours).each(function(){o=true}).on("mouseover",function(t){d=t}).on("mouseleave",function(t){d=null}).transition().duration(t).style("opacity",1).attr("d",p.geoPath()).style("fill",function(t){return f(t.value)}).on("end",function(){o=false})};s.render.style=function(){u.g.attr("width",s.attr.innerWidth+"px").attr("height",s.attr.innerHeight+"px").attr("transform","translate("+s.attr.margins.left+","+s.attr.margins.top+")").style("pointer-events","all");u.axisFn.x.tickFormat(s.attr.xTickFormat);u.axes.x.attr("transform","translate(0,"+s.attr.innerHeight+")");u.axisFn.y.tickFormat(s.attr.yTickFormat);u.axes.y.attr("transform","translate(0,"+1+")");u.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");u.labels.x.attr("x",s.attr.innerWidth+"px").attr("y",s.attr.innerHeight+2.2*s.attr.fontSize+"px").attr("fill",s.attr.fontColor).style("font-size",s.attr.fontSize+"px").text(s.attr.xLabel);u.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",s.attr.fontColor).style("font-size",s.attr.fontSize+"px").text(s.attr.yLabel)}}t.prototype=Object.create(a.prototype);return t});