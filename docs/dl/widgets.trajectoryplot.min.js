(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","d3-contour","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.TrajectoryPlot=e(t.d3,t.du.Widget)}})(this,function(t,l){"use strict";function e(t,e){var r=l.call(this,t,"trajectoryplot","svg",e);r.attr.add(this,"boundary",[0,1,0,1]);r.attr.add(this,"maxLength",10);r.attr.add(this,"background",{});r.attr.add(this,"animate",false);var a={};var n=[];var o=null;var i=null;var s=false;this.data=function(t){n=t.map(function(a){return{name:a.name,values:a.values.sort(function(t,e){return t.t-e.t}).filter(function(t,e){return e>=a.values.length-r.attr.maxLength}).map(function(t,e,r){return{name:a.name,t:t.t,x:t.x,y:t.y,r:Math.min(1,e/r.length),last:e===r.length-1}})}});return this};this.highlight=function(t,e){if(!s)r.utils.highlight(this,a,".trajectory",t,e);return this};r.utils.tooltip=function(t){if(!t||o===null){this.pm&&this.pm.remove();this.pm=null;this.mm&&this.mm.remove();this.mm=null;o=null;return null}switch(o.type){case"movement":this.mm=this.mm||a.g.append("line");this.mm.attr("x1",a.scale.x(o.data[0].x)).attr("y1",a.scale.y(o.data[0].y)).attr("x2",a.scale.x(o.data[1].x)).attr("y2",a.scale.y(o.data[1].y)).style("pointer-events","none").style("stroke-width","2px").style("stroke","black").style("fill","none").style("display",null);this.pm&&this.pm.remove();this.pm=null;return{title:r.attr.tooltipTitleFormat(o.name+" (movement)"),stripe:i[o.name],content:{type:"metrics",data:[{label:"from: "+r.attr.tooltipZFormat(o.data[0].t)+", ("+r.attr.tooltipXFormat(o.data[0].x)+", "+r.attr.tooltipYFormat(o.data[0].y)+")"},{label:"to: &nbsp;&nbsp;"+r.attr.tooltipZFormat(o.data[1].t)+", ("+r.attr.tooltipXFormat(o.data[1].x)+", "+r.attr.tooltipYFormat(o.data[1].y)+")"}]}};case"position":this.pm=this.pm||a.g.append("circle");this.pm.attr("r",6).attr("cx",a.scale.x(o.data.x)).attr("cy",a.scale.y(o.data.y)).style("pointer-events","none").style("stroke-width","2px").style("stroke","white").style("fill","black").style("display",null);this.mm&&this.mm.remove();this.mm=null;return{title:r.attr.tooltipTitleFormat(o.name+" (position)"),stripe:i[o.name],content:{type:"metrics",data:[{label:"location: ("+r.attr.tooltipXFormat(o.data.x)+", "+r.attr.tooltipYFormat(o.data.y)+")"},{label:"time: &nbsp;&nbsp;&nbsp;&nbsp;"+r.attr.tooltipZFormat(o.data.t)}]}};default:return null}};r.render.build=function(){a=r.utils.standardAxis();a.plots={};a.backgroundPattern=a.g.append("defs").append("pattern").attr("id","trajectory-background-"+r.utils.encode(t)).attr("patternUnits","userSpaceOnUse").attr("width",r.attr.innerWidth).attr("height",r.attr.innerHeight);a.backgroundImage=a.backgroundPattern.append("image").attr("xlink:href",r.attr.background.path?r.attr.background.path:null).attr("preserveAspectRatio","none").attr("x",1).attr("y",0).attr("width",r.attr.innerWidth+"px").attr("height",r.attr.innerHeight+"px");a.background=a.g.append("rect").attr("x",1).attr("y",0).attr("width",r.attr.innerWidth+"px").attr("height",r.attr.innerHeight+"px").attr("stroke","none").attr("fill",r.attr.background.path?"url(#"+"trajectory-background-"+r.utils.encode(t)+")":"none").style("opacity",r.attr.background.opacity?r.attr.background.opacity:null)};r.render.update=function(t){a.scale={x:r.utils.scale([r.attr.boundary[0],r.attr.boundary[1]],[0,r.attr.innerWidth]),y:r.utils.scale([r.attr.boundary[2],r.attr.boundary[3]],[r.attr.innerHeight,0])};a.axes.x.transition().duration(t).call(a.axisFn.x.tickValues(r.attr.xTicks).scale(a.scale.x));a.axes.y.transition().duration(t).call(a.axisFn.y.tickValues(r.attr.yTicks).scale(a.scale.y));i=r.utils.colors(n?n.map(function(t){return t.name}):null);a.plots.trajectories=a.g.selectAll(".trajectory").data(n,function(t){return t.name});a.plots.trajectories.exit().transition().duration(t).style("opacity",0).remove();var e=a.plots.trajectories.enter().append("g").attr("class",function(t){return"trajectory "+r.utils.encode(t.name)}).style("shape-rendering","geometricPrecision").style("color",function(t){return i[t.name]});a.plots.trajectories=e.merge(a.plots.trajectories).each(function(){s=true});a.plots.trajectories.transition().duration(t).style("opacity",1).on("end",function(){s=false});a.plots.positions=a.plots.trajectories.selectAll(".position").data(function(t){return t.values},function(t){return t.t});a.plots.positions.exit().attr("r",1).transition().duration(t).style("opacity",0).remove();a.plots.positions.enter().append("circle").attr("class",function(t){return"position position-"+t.t}).attr("cx",function(t){return a.scale.x(t.x)}).attr("cy",function(t){return a.scale.y(t.y)}).attr("r",r.attr.animate?10:1).style("stroke","none").style("fill","currentColor").merge(a.plots.positions).transition().duration(t).attr("r",function(t){return t.last?5:1}).style("opacity",function(t){return t.last?1:t.r});a.plots.movements=a.plots.trajectories.selectAll(".movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});a.plots.movements.exit().transition().duration(t).attr("x1",function(t){return a.scale.x(t[1].x)}).attr("y1",function(t){return a.scale.y(t[1].y)}).style("opacity",0).remove();a.plots.movements.enter().append("line").attr("class",function(t){return"movement movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","2px").style("stroke","currentColor").style("fill","none").attr("x1",function(t){return a.scale.x(t[0].x)}).attr("y1",function(t){return a.scale.y(t[0].y)}).attr("x2",function(t){return a.scale.x(t[0].x)}).attr("y2",function(t){return a.scale.y(t[0].y)}).merge(a.plots.movements).transition().duration(t).attr("x2",function(t){return a.scale.x(t[1].x)}).attr("y2",function(t){return a.scale.y(t[1].y)}).style("opacity",function(t){return(t[0].r+t[1].r)/2});a.plots.fakeMovements=a.plots.trajectories.selectAll(".fake-movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});a.plots.fakeMovements.exit().remove();a.plots.fakeMovements.enter().append("line").attr("class",function(t){return"fake-movement fake-movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","8px").style("stroke","transparent").style("fill","none").attr("x1",function(t){return a.scale.x(t[0].x)}).attr("y1",function(t){return a.scale.y(t[0].y)}).attr("x2",function(t){return a.scale.x(t[1].x)}).attr("y2",function(t){return a.scale.y(t[1].y)}).merge(a.plots.fakeMovements).on("mouseover",function(t){o={name:t[0].name,type:"movement",data:t};r.attr.mouseover&&r.attr.mouseover(t[0].name)}).on("mouseleave",function(t){o=null;r.attr.mouseleave&&r.attr.mouseleave(t[0].name)}).on("click",function(t){r.attr.click&&r.attr.click(t[0].name)});a.plots.fakePositions=a.plots.trajectories.selectAll(".fake-position").data(function(t){return t.values},function(t){return t.t});a.plots.fakePositions.exit().remove();a.plots.fakePositions.enter().append("circle").attr("class",function(t){return"fake-position fake-position-"+t.t}).attr("cx",function(t){return a.scale.x(t.x)}).attr("cy",function(t){return a.scale.y(t.y)}).attr("r",5).style("stroke","none").style("fill","transparent").merge(a.plots.fakePositions).on("mouseover",function(t){o={name:t.name,type:"position",data:t};r.attr.mouseover&&r.attr.mouseover(t.name)}).on("mouseleave",function(t){o=null;r.attr.mouseleave&&r.attr.mouseleave(t.name)}).on("click",function(t){r.attr.click&&r.attr.click(t.name)})};r.render.style=function(){a.g.attr("width",r.attr.innerWidth+"px").attr("height",r.attr.innerHeight+"px").attr("transform","translate("+r.attr.margins.left+","+r.attr.margins.top+")").style("pointer-events","all");a.axisFn.x.tickFormat(r.attr.xTickFormat);a.axes.x.attr("transform","translate(0,"+r.attr.innerHeight+")");a.axisFn.y.tickFormat(r.attr.yTickFormat);a.axes.y.attr("transform","translate(0,"+1+")");a.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");a.labels.x.attr("x",r.attr.innerWidth+"px").attr("y",r.attr.innerHeight+2.2*r.attr.fontSize+"px").attr("fill",r.attr.fontColor).style("font-size",r.attr.fontSize+"px").text(r.attr.xLabel);a.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",r.attr.fontColor).style("font-size",r.attr.fontSize+"px").text(r.attr.yLabel);a.backgroundPattern.attr("width",r.attr.innerWidth).attr("height",r.attr.innerHeight);a.backgroundImage.attr("width",r.attr.innerWidth+"px").attr("height",r.attr.innerHeight+"px");a.background.attr("width",r.attr.innerWidth+"px").attr("height",r.attr.innerHeight+"px").attr("fill",r.attr.background.path?"url(#"+"trajectory-background-"+r.utils.encode(t)+")":"none").style("opacity",r.attr.background.opacity?r.attr.background.opacity:null)}}e.prototype=Object.create(l.prototype);return e});