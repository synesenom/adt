(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","d3-contour","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.TrajectoryPlot=e(t.d3,t.du.Widget)}})(this,function(t,r){"use strict";function e(t,e){var c=r.call(this,t,"trajectoryplot","svg",e);c.attr.add(this,"boundary",[0,1,0,1]);c.attr.add(this,"maxLength",10);c.attr.add(this,"background",{});c.attr.add(this,"fadeExp",0);c.attr.add(this,"animate",false);var p={};var n=[];var d=null;var m=null;var a=false;var f={};this.data=function(t){n=t.map(function(n){return{name:n.name,values:n.values.sort(function(t,e){return t.t-e.t}).filter(function(t,e){return e>=n.values.length-c.attr.maxLength}).map(function(t,e,r){return{name:n.name,t:t.t,x:t.x,y:t.y,r:Math.exp(-c.attr.fadeExp*(1-e/r.length)),last:e===r.length-1}})}});return this};this.highlight=function(t,e){if(!a)c.utils.highlight(this,p,".trajectory",t,e);return this};this.addMarker=function(t,e,r,n,a,i){if(f.hasOwnProperty(t)){return null}var o=a?a/2:7;var s=p.g.append("g").attr("class","marker "+c.utils.encode(r));var l=s.append("circle").attr("cx",p.scale.x(n[0])+2).attr("cy",p.scale.y(n[1])).attr("r",c.attr.animate?1.5*o:o).style("stroke-width","2px").style("stroke","white").style("fill",m[r]);if(c.attr.animate){l.transition().duration(700).attr("r",o)}var u={key:r,g:s,update:function(t){s.select("circle").on("mouseover",function(){d={name:e,type:"marker",info:i||"Information not available."};c.attr.mouseover&&c.attr.mouseover(r)}).on("mouseleave",function(){d=null;c.attr.mouseleave&&c.attr.mouseleave(r)}).on("click",function(){c.attr.click&&c.attr.click(r)}).transition().duration(t).attr("cx",p.scale.x(n[0])+2).attr("cy",p.scale.y(n[1])).style("fill",m[this.key])}};f[t]=u;return u};this.removeMarker=function(t){if(f.hasOwnProperty(t)){f[t].g.remove();delete f[t];return true}return false};c.utils.tooltip=function(t){if(!t||d===null){this.pm&&this.pm.remove();this.pm=null;this.mm&&this.mm.remove();this.mm=null;d=null;return null}switch(d.type){case"marker":this.pm&&this.pm.remove();this.pm=null;this.mm&&this.mm.remove();this.mm=null;return{title:c.attr.tooltipTitleFormat(d.name+" (marker)"),stripe:m[d.name],content:{type:"metrics",data:[{label:d.info}]}};default:return null}};c.render.build=function(){p=c.utils.standardAxis();p.plots={};p.backgroundPattern=p.g.append("defs").append("pattern").attr("id","trajectory-background-"+c.utils.encode(t)).attr("patternUnits","userSpaceOnUse").attr("width",c.attr.innerWidth).attr("height",c.attr.innerHeight);p.backgroundImage=p.backgroundPattern.append("image").attr("xlink:href",c.attr.background.path?c.attr.background.path:null).attr("preserveAspectRatio","none").attr("x",1).attr("y",0).attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px");p.background=p.g.append("rect").attr("x",1).attr("y",0).attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px").attr("stroke","none").attr("fill",c.attr.background.path?"url(#"+"trajectory-background-"+c.utils.encode(t)+")":"none").style("opacity",c.attr.background.opacity?c.attr.background.opacity:null)};c.render.update=function(t){p.scale={x:c.utils.scale([c.attr.boundary[0],c.attr.boundary[1]],[0,c.attr.innerWidth]),y:c.utils.scale([c.attr.boundary[2],c.attr.boundary[3]],[c.attr.innerHeight,0])};p.axes.x.transition().duration(t).call(p.axisFn.x.tickValues(c.attr.xTicks).scale(p.scale.x));p.axes.y.transition().duration(t).call(p.axisFn.y.tickValues(c.attr.yTicks).scale(p.scale.y));m=c.utils.colors(n?n.map(function(t){return t.name}):null);p.plots.trajectories=p.g.selectAll(".trajectory").data(n,function(t){return t.name});p.plots.trajectories.exit().transition().duration(t).style("opacity",0).remove();var e=p.plots.trajectories.enter().append("g").attr("class",function(t){return"trajectory "+c.utils.encode(t.name)}).style("shape-rendering","geometricPrecision").style("color",function(t){return m[t.name]});p.plots.trajectories=e.merge(p.plots.trajectories).each(function(){a=true});p.plots.trajectories.transition().duration(t).style("opacity",1).on("end",function(){a=false});p.plots.positions=p.plots.trajectories.selectAll(".position").data(function(t){return t.values},function(t){return t.t});p.plots.positions.exit().remove();p.plots.positions.enter().append("circle").attr("class",function(t){return"position position-"+t.t}).attr("cx",function(t){return p.scale.x(t.x)}).attr("cy",function(t){return p.scale.y(t.y)}).attr("r",c.attr.animate?10:1).style("stroke","none").style("fill","currentColor").merge(p.plots.positions).transition().duration(t).attr("r",1).style("opacity",function(t){return t.r});p.plots.movements=p.plots.trajectories.selectAll(".movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});p.plots.movements.exit().transition().duration(t).attr("x1",function(t){return p.scale.x(t[1].x)}).attr("y1",function(t){return p.scale.y(t[1].y)}).style("opacity",0).remove();p.plots.movements.enter().append("line").attr("class",function(t){return"movement movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","2px").style("stroke","currentColor").style("fill","none").attr("x1",function(t){return p.scale.x(t[0].x)}).attr("y1",function(t){return p.scale.y(t[0].y)}).attr("x2",function(t){return p.scale.x(t[0].x)}).attr("y2",function(t){return p.scale.y(t[0].y)}).merge(p.plots.movements).transition().duration(t).attr("x2",function(t){return p.scale.x(t[1].x)}).attr("y2",function(t){return p.scale.y(t[1].y)}).style("opacity",function(t){return(t[0].r+t[1].r)/2});p.plots.fakeMovements=p.plots.trajectories.selectAll(".fake-movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});p.plots.fakeMovements.exit().remove();p.plots.fakeMovements.enter().append("line").attr("class",function(t){return"fake-movement fake-movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","8px").style("stroke","transparent").style("fill","none").attr("x1",function(t){return p.scale.x(t[0].x)}).attr("y1",function(t){return p.scale.y(t[0].y)}).attr("x2",function(t){return p.scale.x(t[1].x)}).attr("y2",function(t){return p.scale.y(t[1].y)}).merge(p.plots.fakeMovements).on("mouseover",function(t){d={name:t[0].name,type:"movement",data:t};c.attr.mouseover&&c.attr.mouseover(t[0].name)}).on("mouseleave",function(t){d=null;c.attr.mouseleave&&c.attr.mouseleave(t[0].name)}).on("click",function(t){c.attr.click&&c.attr.click(t[0].name)});p.plots.fakePositions=p.plots.trajectories.selectAll(".fake-position").data(function(t){return t.values},function(t){return t.t});p.plots.fakePositions.exit().remove();p.plots.fakePositions.enter().append("circle").attr("class",function(t){return"fake-position fake-position-"+t.t}).attr("cx",function(t){return p.scale.x(t.x)}).attr("cy",function(t){return p.scale.y(t.y)}).attr("r",5).style("stroke","none").style("fill","transparent").merge(p.plots.fakePositions).on("mouseover",function(t){d={name:t.name,type:"position",data:t};c.attr.mouseover&&c.attr.mouseover(t.name)}).on("mouseleave",function(t){d=null;c.attr.mouseleave&&c.attr.mouseleave(t.name)}).on("click",function(t){c.attr.click&&c.attr.click(t.name)});for(var r in f){if(f.hasOwnProperty(r)){f[r].update(t)}}p.backgroundImage.attr("xlink:href",c.attr.background.path?c.attr.background.path:null)};c.render.style=function(){p.g.attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px").attr("transform","translate("+c.attr.margins.left+","+c.attr.margins.top+")").style("pointer-events","all");p.axisFn.x.tickFormat(c.attr.xTickFormat);p.axes.x.attr("transform","translate(0,"+c.attr.innerHeight+")");p.axisFn.y.tickFormat(c.attr.yTickFormat);p.axes.y.attr("transform","translate(0,"+1+")");p.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");p.labels.x.attr("x",c.attr.innerWidth+"px").attr("y",c.attr.innerHeight+2.2*c.attr.fontSize+"px").attr("fill",c.attr.fontColor).style("font-size",c.attr.fontSize+"px").text(c.attr.xLabel);p.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",c.attr.fontColor).style("font-size",c.attr.fontSize+"px").text(c.attr.yLabel);p.backgroundPattern.attr("width",c.attr.innerWidth).attr("height",c.attr.innerHeight);p.backgroundImage.attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px");p.background.attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px").attr("fill",c.attr.background.path?"url(#"+"trajectory-background-"+c.utils.encode(t)+")":"none").style("opacity",c.attr.background.opacity?c.attr.background.opacity:null)}}e.prototype=Object.create(r.prototype);return e});