(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"),exports)}else if(typeof define==="function"&&define.amd){define(["d3","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.PieChart=e(t.d3,t.du.Widget)}})(this,function(v,r){"use strict";function t(t,e){var u=r.call(this,t,"piechart","svg",e);u.attr.add(this,"innerRadius",0,"dim");u.attr.add(this,"outerRadius",50,"dim");u.attr.add(this,"ticks",false);var l={};var o=[];var s={};var d=null;var c=false;function f(t){return t.data?t.data.name:""}function h(t,e,r,a){var n;return(n=i(t,e,r,a))?{startAngle:n.endAngle,endAngle:n.endAngle}:(n=m(t,e,r,a))?{startAngle:n.startAngle,endAngle:n.startAngle}:null}function i(t,e,r,a){var n=e.length;while(--t>=0){var i=a(r[t]);for(var u=0;u<n;++u){if(a(e[u])===i)return e[u]}}}function m(t,e,r,a){var n=r.length,i=e.length;while(++t<n){var u=a(r[t]);for(var l=0;l<i;++l){if(a(e[l])===u)return e[l]}}}function g(t){var e=v.interpolate(this._current,t);this._current=e(0);return function(t){return l.arc(e(t))}}function p(t){var e=v.interpolate(this._current,t);this._current=e(0);return function(t){return"translate("+l.arcLabel.centroid(e(t))+")"}}this.data=function(t){o=t;return this};this.highlight=function(t,e){if(!c){u.utils.highlight(this,l,"path",t,e);u.utils.highlight(this,l,"text",t,e)}return this};u.utils.tooltip=function(){return d?{title:d.name,stripe:u.attr.colors[d.name],content:{type:"metrics",data:[{label:"value:",value:u.attr.tooltipYFormat(d.value)},{label:"fraction:",value:(100*d.value/v.sum(o,function(t){return t.value})).toFixed(1)+"%"}]}}:null};u.render.build=function(){l.g=u.widget.append("g");l.label=l.g.append("text").attr("text-anchor","middle").attr("stroke-width","0px").style("fill","white")};u.render.update=function(t){l.arc=v.arc().outerRadius(u.attr.outerRadius-u.attr.margins.left).innerRadius(u.attr.innerRadius);l.arcLabel=v.arc().outerRadius(.5*(u.attr.innerRadius+u.attr.outerRadius-u.attr.margins.left)).innerRadius(.5*(u.attr.innerRadius+u.attr.outerRadius-u.attr.margins.left));var e=v.pie().value(function(t){return t.value}).sort(null);s=u.utils.colors(o?o.map(function(t){return t.name}):null);var r=l.g.selectAll(".slice");var a=l.g.selectAll(".label");var n=r.data(),i=e(o);r=r.data(i,f);r.exit().datum(function(t,e){return h(e,i,n,f)||t}).transition().duration(t).attrTween("d",g).remove();r.enter().append("path").attr("class",function(t){return"slice "+u.utils.encode(t.data.name)}).each(function(t,e){this._current=h(e,n,i,f)||t}).style("pointer-events","all").style("fill",function(t){return s[t.data.name]}).merge(r).each(function(){c=true}).on("mouseover",function(t){d=t.data;u.attr.mouseover&&u.attr.mouseover(t.data.name)}).on("mouseleave",function(t){d=null;u.attr.mouseleave&&u.attr.mouseleave(t.data.name)}).on("click",function(t){u.attr.click&&u.attr.click(t.data.name)}).transition().duration(t).style("opacity",1).style("fill",function(t){return s[t.data.name]}).attrTween("d",g).on("end",function(){c=false});a=a.data(i,f);a.exit().datum(function(t,e){return h(e,i,n,f)||t}).transition().duration(t).style("opacity",0).attrTween("transform",p).remove();a.enter().append("text").attr("class",function(t){return"label "+u.utils.encode(t.data.name)}).each(function(t,e){this._current=h(e,n,i,f)||t}).merge(a).attr("dy","0.35em").style("text-anchor","middle").style("pointer-events","none").attr("fill",u.attr.fontColor).text(function(t){return u.attr.tickFormat(100*t.data.value/v.sum(i,function(t){return t.value}))}).transition().duration(t).attrTween("transform",p)};u.render.style=function(){u.attr.colors=u.utils.colors(o?o.map(function(t){return t.name}):null);var t=u.attr.outerRadius-u.attr.margins.left;u.attr.width=2*u.attr.outerRadius;u.attr.height=2*u.attr.outerRadius;u.widget.style("width",u.attr.width+"px").style("height",u.attr.height+"px");l.g.attr("transform","translate("+u.attr.outerRadius+","+u.attr.outerRadius+")");l.label.attr("transform","translate(0,"+u.attr.outerRadius+")").style("width",10+2*u.attr.outerRadius+"px").style("font-size",Math.min(16,u.attr.outerRadius*.4)+"px").style("fill",u.attr.fontColor).text(u.attr.label)}}t.prototype=Object.create(r.prototype);return t});