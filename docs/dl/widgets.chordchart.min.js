(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"),exports)}else if(typeof define==="function"&&define.amd){define(["d3","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.ChordChart=e(t.d3,t.du.Widget)}})(this,function(p,h){"use strict";function t(t,e){var n=h.call(this,t,"chordchart","svg",e);n.attr.add(this,"radius",100,"dim");n.attr.add(this,"thickness",10,"dim");n.attr.add(this,"ticks",false);n.attr.add(this,"invert",false);var l={};var o=[];var a=null;var s=p.map();var u=p.map();var r=10;var i=null;var c=false;this.data=function(t){s.clear();u.clear();o=[];var i=0,e=0;t.forEach(function(t){if(!s.has(e=t.source)){u.set(i,e);s.set(e,i++)}if(!s.has(e=t.target)){u.set(i,e);s.set(e,i++)}});t.forEach(function(t){var e=s.get(t.source),r=s.get(t.target),n=o[e];if(!n){n=o[e]=[];for(var a=0;a<i;a++)n[a]=0}n[r]=t.value;if(!o[r]){o[r]=[];for(a=0;a<i;a++)o[r][a]=0}});r=p.max(u.values(),function(t){return t.length});return this};function d(t){return t.source.index<t.target.index?t.source.index+"-"+t.target.index:t.target.index+"-"+t.source.index}function f(t){var a=p.map();if(t){t.groups.forEach(function(t){a.set(t.index,t)})}return function(t){var e;var r=a.get(t.index);if(r){e=p.interpolate(r,t)}else{var n={startAngle:t.startAngle,endAngle:t.startAngle};e=p.interpolate(n,t)}return function(t){return l.arc(e(t))}}}function g(s){var u=p.map();if(s){s.forEach(function(t){u.set(d(t),t)})}return function(e){var r;var t=u.get(d(e));if(t){if(e.source.index!==t.source.index){t={source:t.target,target:t.source}}r=p.interpolate(t,e)}else{if(s){var n=s.groups.filter(function(t){return t.index===e.source.index||t.index===e.target.index});t={source:n[0],target:n[1]||n[0]};if(t.source&&e.source.index!==t.source.index){t={source:t.target,target:t.source}}}else t=e;var a=t.source?t.source.startAngle:0;var i=t.target?t.target.startAngle:0;var o={source:{startAngle:a,endAngle:a},target:{startAngle:i,endAngle:i}};r=p.interpolate(o,e)}return function(t){return l.ribbonFn(r(t))}}}this.highlight=function(t,e){if(!c)n.utils.highlight(this,l,".ribbon",t,e);return this};n.utils.tooltip=function(){if(!a){return null}var r=o[s.get(a.name)];return a?{title:a.name,stripe:n.attr.colors[a.name],content:{type:"metrics",data:r.map(function(t,e){return{name:u.get(e),value:100*t/p.sum(r)}}).sort(function(t,e){return e.value-t.value}).map(function(t){return{label:t.name,value:t.value.toFixed(1)+"%"}})}}:null};n.render.build=function(){l.g=n.widget.append("g");l.chordFn=p.chord().padAngle(.05).sortGroups(p.descending).sortSubgroups(p.descending);l.arc=p.arc();l.ribbonFn=p.ribbon();l.label=l.g.append("text").attr("text-anchor","middle").attr("stroke-width","0px").style("fill","white")};n.render.update=function(t){n.attr.colors=n.utils.colors(s?s.keys():null);var e=n.attr.radius-n.attr.thickness-n.attr.margins.left,r=n.attr.radius-n.attr.margins.left;if(l.groups)l.groups.transition();if(l.newGroups)l.newGroups.transition();if(l.ribbons)l.ribbons.transition();if(l.newRibbons)l.newRibbons.transition();l.chord=l.chordFn(o);l.arc.innerRadius(e).outerRadius(r);l.groups=l.g.selectAll(".group").data(l.chord.groups,function(t){return t.index});l.groups.exit().transition().duration(t).style("opacity",0).remove();l.newGroups=l.groups.enter().append("g").each(function(t){t.name=u.get(t.index)}).attr("class","group").style("pointer-events","all");l.newGroups.merge(l.groups).on("mouseover",function(t){n.attr.mouseover&&n.attr.mouseover(t.name)}).on("mouseleave",function(t){a=null;n.attr.mouseleave&&n.attr.mouseleave(t.name)}).on("click",function(t){n.attr.click&&n.attr.click(t.name)}).on("mousemove",function(t){a=t});l.newGroups.append("path").attr("id",function(t){return"group"+t.index}).style("fill",function(t){return n.attr.colors[t.name]}).transition().duration(t).attrTween("d",f(i));if(n.attr.ticks){l.newGroups.append("text").attr("xlink:href",function(t){return"#group"+t.index}).attr("dy",".35em").text(function(t){return t.name}).attr("transform",function(t){t.angle=(t.startAngle+t.endAngle)/2;return"rotate("+(t.angle*180/Math.PI-90)+")"+" translate("+(n.attr.radius-n.attr.margins.left+5)+")"+(t.angle>Math.PI?" rotate(180)":" rotate(0)")}).attr("text-anchor",function(t){return t.angle>Math.PI?"end":"begin"})}l.groups.select("path").each(function(t){t.name=u.get(t.index)}).attr("d",l.arc).transition().duration(t).each(function(){c=true}).style("opacity",1).style("fill",function(t){return n.attr.colors[t.name]}).attrTween("d",f(i)).on("end",function(){c=false});if(n.attr.ticks){l.groups.select("text").transition().duration(t).attr("transform",function(t){t.angle=(t.startAngle+t.endAngle)/2;return"rotate("+(t.angle*180/Math.PI-90)+")"+" translate("+(n.attr.radius-n.attr.margins.left+5)+")"+(t.angle>Math.PI?" rotate(180)":" rotate(0)")}).attr("text-anchor",function(t){return t.angle>Math.PI?"end":"begin"})}l.ribbonFn.radius(e);l.ribbons=l.g.selectAll(".ribbon").data(l.chord,d);l.newRibbons=l.ribbons.enter().append("path").each(function(t){t.source.name=u.get(t.source.index);t.target.name=u.get(t.target.index)}).attr("class",function(t){return"ribbon "+n.utils.encode(t.source.name)}).style("pointer-events","all").style("fill",function(t){return n.attr.colors[n.attr.invert?t.source.name:t.target.name]}).style("stroke-width","1px").style("fill-opacity",.8).style("stroke-opacity",.8).style("stroke","white");l.newRibbons.transition().duration(t).attrTween("d",g(null));l.ribbons.exit().transition().duration(t).style("opacity",0).remove();l.ribbons.each(function(t){t.source.name=u.get(t.source.index);t.target.name=u.get(t.target.index)}).attr("class",function(t){return"ribbon "+n.utils.encode(t.source.name)}).transition().duration(t).style("opacity",1).style("fill",function(t){return n.attr.colors[n.attr.invert?t.source.name:t.target.name]}).attrTween("d",g(i));i=l.chord};n.render.style=function(){n.attr.width=2*n.attr.radius;n.attr.height=2*n.attr.radius;n.widget.style("width",n.attr.width+"px").style("height",n.attr.height+"px");l.g.attr("transform","translate("+n.attr.radius+","+n.attr.radius+")");if(n.attr.ticks){l.newGroups.selectAll("text").style("font-size",n.attr.fontSize*.8+"px").style("font-weight",n.attr.fontWeight).style("fill",n.attr.fontColor)}l.label.attr("transform","translate(0,"+n.attr.radius+")").style("width",2*(n.attr.radius+n.attr.thickness)+"px").attr("font-size",n.attr.fontSize+"px").style("fill",n.attr.fontColor).text(n.attr.label)}}t.prototype=Object.create(h.prototype);return t});