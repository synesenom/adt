(function(t,r){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=r(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","src/widget","exports"],r)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.MultiBarChart=r(t.d3,t.du.Widget)}})(this,function(p,a){"use strict";function t(t,r){var u=a.call(this,t,"multibarchart","svg",r);u.attr.add(this,"barWidth",false);u.attr.add(this,"sortByX",false);u.attr.add(this,"xDomain",null);var c={};var d=[];var l={};var f=null;var y=false;var x={};this.data=function(t){d=t?t.map(function(t){return{name:t.name,values:t.values.map(function(t){return{x:t.x,y:t.y,lo:t.lo||0,hi:t.hi||0}})}}):undefined;return this};this.highlight=function(t,r){if(!y)u.utils.highlight(this,c,".bar",t,r);return this};this.highlightRange=function(t,r){if(!y)u.utils.highlightRange(this,c,".bar",t,r);return this};function e(r,t){var e=d.filter(function(t){return t.name===r})[0];if(!e){return null}var a=p.bisector(function(t){return t.x}).left;var n=a(e.values,start);var i=a(e.values,end);if(n===null||i===null){return null}var s=e.values[n].x,o=e.values[n].y,l=e.values[i].x,u=e.values[i].y;var c=o<u?s:l;var f=o<u?u:o;return{start:{x:s,y:o},end:{x:l,y:u},corner:{x:c,y:f}}}this.addMarker=function(t,r,e,a,n,i){if(x.hasOwnProperty(t)){return null}var s=c.g.append("g").attr("class","marker");var o=i&&["start","middle","end"].indexOf(i)>-1?i:"start";s.append("line").attr("class","horizontal").attr("x1",c.scale.x.range()[0]).attr("y1",c.scale.y(r)).attr("x2",c.scale.x.range()[1]).attr("y2",c.scale.y(r)).style("stroke",n||u.attr.fontColor).style("stroke-dasharray","3 3").style("stroke-width",1);s.append("text").attr("x",c.scale.x.range()[0]+(a||0)*(c.scale.x.range()[1]-c.scale.x.range()[0])).attr("y",c.scale.y(r)).attr("dy",-5).attr("text-anchor","start").style("fill",n||u.attr.fontColor).style("font-family","inherit").style("font-size","0.9em").style("text-anchor",o).text(e);var l={g:s,update:function(t){s.select(".horizontal").transition().duration(t).attr("x1",c.scale.x.range()[0]).attr("y1",c.scale.y(r)).attr("x2",c.scale.x.range()[1]).attr("y2",c.scale.y(r));s.select("text").transition().duration(t).attr("x",c.scale.x.range()[0]+(a||0)*(c.scale.x.range()[1]-c.scale.x.range()[0])).attr("y",c.scale.y(r))}};x[t]=l;return l};this.removeMarker=function(t){if(x.hasOwnProperty(t)){x[t].g.remove();delete x[t];return true}return false};u.utils.tooltip=function(){if(!f){return null}var e=f.x;var t=d.map(function(t){var r=t.values.filter(function(t){return t.x===e});return{name:t.name,color:l[t.name],value:r.length>0?u.attr.tooltipYFormat(r[0].y):"n/a"}});return{title:u.attr.tooltipXFormat(e),content:{type:"plots",data:t}}};u.render.build=function(){c=u.utils.standardAxis();c.plots={}};u.render.update=function(t){var r=[];if(u.attr.xDomain){r=u.attr.xDomain}else if(typeof d!=="undefined"&&d.length>0){r=d.reduce(function(t,r){return t.concat(r.values)},[]).map(function(t){return t.x})}var e=[];if(typeof d!=="undefined"&&d.length>0){e=d.reduce(function(t,r){return t.concat(r.values)},[]).map(function(t){return t.y}).concat([0])}if(u.attr.sortByX){r.sort(function(t,r){return t.localeCompare(r)})}c.scale={x:u.utils.scale(r,[0,u.attr.innerWidth],"band"),y:u.utils.scale(e,[u.attr.innerHeight,0])};c.axisFn.x.tickFormat(u.attr.xTickFormat);c.axes.x.transition().duration(t).call(c.axisFn.x.tickValues(u.attr.xTicks).scale(c.scale.x));c.axisFn.y.tickFormat(u.attr.yTickFormat);c.axes.y.transition().duration(t).call(c.axisFn.y.tickValues(u.attr.yTicks).scale(c.scale.y));if(typeof d==="undefined"||d.length===0){return}l=u.utils.colors(d?d.map(function(t){return t.name}):null);c.plots.groups=c.g.selectAll(".bar-group").data(d,function(t){return t.name});c.plots.groups.exit().transition().duration(t).remove();var a=c.plots.groups.enter().append("g").attr("class",function(t){return"bar-group "+u.utils.encode(t.name)}).style("shape-rendering","geometricPrecision").style("stroke","none").style("fill","transparent");c.plots.groups=a.merge(c.plots.groups).each(function(){y=true});c.plots.groups.transition().duration(t).style("fill-opacity",u.attr.opacity).style("fill",function(t){return l[t.name]}).on("end",function(){y=false});var n=d.length>0?c.scale.x.bandwidth():1,i=n*u.attr.barWidth,s=n*(1-u.attr.barWidth)/2;c.plots.bars=c.plots.groups.selectAll(".bar").data(function(r,e){return r.values.map(function(t){return{name:r.name,n:d.length,i:e,x:t.x,y:t.y}})});c.plots.bars.exit().transition().duration(t).style("opacity",0).remove();c.plots.bars.enter().append("rect").attr("class",function(t){return"bar "+u.utils.encode(t.name)}).style("opacity",0).attr("x",function(t){return c.scale.x(t.x)+s+i*t.i/t.n}).attr("y",u.attr.height-u.attr.margins.top-u.attr.margins.bottom).attr("width",function(t){return i/t.n}).attr("height",0).merge(c.plots.bars).on("mouseover",function(t){f=t;u.attr.mouseover&&u.attr.mouseover(t.name)}).on("mouseleave",function(t){f=null;u.attr.mouseleave&&u.attr.mouseleave(t.name)}).on("click",function(t){u.attr.click&&u.attr.click(t.name)}).transition().duration(t).style("opacity",1).attr("x",function(t){return c.scale.x(t.x)+s+i*t.i/t.n}).attr("y",function(t){return c.scale.y(t.y)}).attr("width",function(t){return i/t.n}).attr("height",function(t){return u.attr.height-u.attr.margins.top-u.attr.margins.bottom-c.scale.y(t.y)});for(var o in x){if(x.hasOwnProperty(o)){x[o].update(t)}}};u.render.style=function(){c.g.attr("width",u.attr.innerWidth+"px").attr("height",u.attr.innerHeight+"px").attr("transform","translate("+u.attr.margins.left+","+u.attr.margins.top+")").style("pointer-events","all");c.axisFn.x.tickFormat(u.attr.xTickFormat);c.axes.x.attr("transform","translate(0,"+u.attr.innerHeight+")");c.axisFn.y.tickFormat(u.attr.yTickFormat);c.axes.y.attr("transform","translate(0,"+1+")");c.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");c.labels.x.attr("x",u.attr.innerWidth+"px").attr("y",u.attr.innerHeight+2.5*u.attr.fontSize+"px").style("fill",u.attr.fontColor).style("font-size",u.attr.fontSize+"px").text(u.attr.xLabel);c.labels.y.attr("x",5+"px").attr("y",-5+"px").style("fill",u.attr.fontColor).style("font-size",u.attr.fontSize+"px").text(u.attr.yLabel)}}t.prototype=Object.create(a.prototype);return t});