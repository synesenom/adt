(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("lodash"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","lodash","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.ViolinPlot=e(t.d3,t._,t.du.Widget)}})(this,function(t,e,n){"use strict";function a(e,a){var r=n.call(this,e,"violinplot","svg",a);function i(e,n){return function(a){return n.map(function(n){return{x:n,y:t.mean(a,function(t){return e(n-t)})}})}}function o(t){return function(e){return Math.abs(e/=t)<=1?.75*(1-e*e)/t:0}}var l={};var s=[];var u=null;var c=0;var m=1;var f={};var d=false;this.data=function(e){var n=e.reduce(function(t,e){return t.concat(e.data)},[]);c=t.min(n);m=t.max(n);s=e.map(function(e){var n=e.data.sort(t.ascending),a=t.min(n),l=t.max(n),s=t.quantile(n,.25),u=t.quantile(n,.75),f=.2*(l-a);var d=i(o(.05*(l-a)),t.range(21).map(function(t){return(l-a+2*f)*t/20+(a-f)}));var p=d(e.data);return{name:e.name,scale:{x:t.scaleLinear().domain([c,m]).range([r.attr.innerHeight,0]),y:t.scaleLinear().range([10,0]).domain([0,t.max(p,function(t){return t.y})])},values:{min:a,max:l,mean:t.mean(n),median:t.median(n),q1:s,q3:u,data:p}}});return this};this.highlight=function(t,e){if(!d)r.utils.highlight(this,l,".violin",t,e);return this};r.utils.tooltip=function(){return u?{title:u.name,stripe:r.attr.colors[u.name],content:{type:"metrics",data:[{label:"min/max:",value:u.values.min.toPrecision(3)+"/"+u.values.max.toPrecision(3)},{label:"mean:",value:u.values.mean.toPrecision(3)},{label:"median:",value:u.values.median.toPrecision(3)},{label:"Q1:",value:u.values.q1.toPrecision(3)},{label:"Q3:",value:u.values.q3.toPrecision(3)}]}}:null};r.render.build=function(){l=r.utils.standardAxis();l.plots={}};r.render.update=function(e){l.scale={x:r.utils.scale(s.map(function(t){return t.name}).reverse(),[r.attr.innerWidth,0],"point"),y:r.utils.scale(s.map(function(t){return[t.values.min-.1*(t.values.max-t.values.min),t.values.max+.1*(t.values.max-t.values.min)]}).reduce(function(t,e){return t.concat(e)},[]),[r.attr.innerHeight,0])};l.axes.x.transition().duration(e).call(l.axisFn.x.scale(l.scale.x));l.axes.y.transition().duration(e).call(l.axisFn.y.scale(l.scale.y));f=r.utils.colors(s?s.map(function(t){return t.name}):null);l.plots.groups=l.g.selectAll(".box-group").data(s,function(t){return t.name});l.plots.groups.exit().style("opacity",0).remove();var n=l.plots.groups.enter().append("g").attr("class",function(t){return"box-group "+r.utils.encode(t.name)}).style("shape-rendering","geometricPrecision").style("opacity",0).style("fill","transparent");var a=n.merge(l.plots.groups).each(function(){d=true}).on("mouseover",function(t){u=t;r.attr.mouseover&&r.attr.mouseover(t.name)}).on("mouseleave",function(t){u=null;r.attr.mouseleave&&r.attr.mouseleave(t.name)}).on("click",function(t){r.attr.click&&r.attr.click(t.name)}).attr("transform",function(t){return"translate("+l.scale.x(t.name)+",0)"});a.transition().duration(e).attr("transform",function(t){return"translate("+l.scale.x(t.name)+",0)"}).style("opacity",1).style("fill-opacity",.3).style("fill",function(t){return f[t.name]}).style("stroke",function(t){return f[t.name]}).on("end",function(){d=false});n.append("path").attr("transform","rotate(90) translate(0,-"+(10+.5)+")");a.select("path").transition().duration(e).attr("d",function(e){e.scale.x.range([r.attr.innerHeight,0]);var n=t.area().curve(t.curveBasis).x(function(t){return e.scale.x(Math.min(m,Math.max(c,t.x)))}).y0(function(t){return e.scale.y(-t.y)}).y1(function(t){return e.scale.y(t.y)});return n(e.values.data)}).attr("transform","rotate(90) translate(0,-"+(10+.5)+")")};r.render.style=function(){r.attr.colors=r.utils.colors(s?s.map(function(t){return t.name}):null);l.g.style("width",r.attr.innerWidth+"px").style("height",r.attr.innerHeight+"px").attr("transform","translate("+r.attr.margins.left+","+r.attr.margins.top+")").style("pointer-events","all");l.axes.x.attr("transform","translate(0,"+r.attr.innerHeight+")");l.axisFn.y.tickFormat(r.attr.yTickFormat);l.axes.y.attr("transform","translate(0,"+1+")");l.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");l.labels.x.attr("x",r.attr.innerWidth+"px").attr("y",r.attr.innerHeight+2.2*r.attr.fontSize+"px").attr("fill",r.attr.fontColor).style("font-size",r.attr.fontSize+"px").text(r.attr.xLabel);l.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",r.attr.fontColor).style("font-size",r.attr.fontSize+"px").text(r.attr.yLabel)}}a.prototype=Object.create(n.prototype);return a});