(function(t,a){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=a(require("d3"),require("lodash"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","lodash","src/widget","exports"],a)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.ViolinPlot=a(t.d3,t._,t.du.Widget)}})(this,function(t,a,e){"use strict";function n(n,r){var i=e.call(this,n,"violinplot","svg",r);function l(a,e){return function(n){return e.map(function(e){return{x:e,y:t.mean(n,function(t){return a(e-t)})}})}}function s(t){return function(a){return Math.abs(a/=t)<=1?.75*(1-a*a)/t:0}}var o={};var c=[];var u=null;var d=0;var f=1;this.data=function(a){var e=a.reduce(function(t,a){return t.concat(a.data)},[]);d=t.min(e);f=t.max(e);c=a.map(function(a){var e=a.data.sort(t.ascending),n=t.min(e),r=t.max(e),o=t.quantile(e,.25),c=t.quantile(e,.75),u=.2*(r-n);var m=l(s(.05*(r-n)),t.scaleLinear().domain([n-u,r+u]).ticks(20));var x=m(a.data);return{name:a.name,min:n,max:r,mean:t.mean(e),median:t.median(e),q1:o,q3:c,data:x,scale:{x:t.scaleLinear().domain([d,f]).range([i.attr.innerHeight,0]),y:t.scaleLinear().range([10,0]).domain([0,t.max(x,function(t){return t.y})])}}});return this};this.highlight=function(t,a){return i.utils.highlight(this,o,".violin",t,a)};i.utils.tooltip=function(){return u?{title:u.name,stripe:i.attr.colors[u.name],content:{type:"metrics",data:[{label:"min/max:",value:u.min.toPrecision(3)+"/"+u.max.toPrecision(3)},{label:"mean:",value:u.mean.toPrecision(3)},{label:"median:",value:u.median.toPrecision(3)},{label:"Q1:",value:u.q1.toPrecision(3)},{label:"Q3:",value:u.q3.toPrecision(3)}]}}:null};i.render.build=function(){o.g=i.widget.append("g");o.axisFn={x:t.axisBottom().ticks(5),y:t.axisLeft().ticks(5)};o.axes={x:o.g.append("g").attr("class","x axis"),y:o.g.append("g").attr("class","y axis")};o.labels={x:o.g.append("text").attr("class","x axis-label").attr("text-anchor","end").attr("stroke-width",0),y:o.g.append("text").attr("class","y axis-label").attr("text-anchor","begin").attr("stroke-width",0)}};i.render.update=function(a){o.scale={x:i.utils.scale(c.map(function(t){return t.name}).reverse(),[i.attr.innerWidth,0],"point"),y:i.utils.scale(c.map(function(t){return[t.min-.1*(t.max-t.min),t.max+.1*(t.max-t.min)]}).reduce(function(t,a){return t.concat(a)},[]),[i.attr.innerHeight,0])};o.axes.x.transition().duration(a).call(o.axisFn.x.scale(o.scale.x));o.axes.y.transition().duration(a).call(o.axisFn.y.scale(o.scale.y));if(c.length>0){if(o.violins===undefined){o.violins={};c.forEach(function(a){a.scale.x.range([i.attr.innerHeight,0]);var e=o.g.selectAll("."+i.utils.encode(a.name)).data([a]).enter().append("g").attr("class","violin "+i.utils.encode(a.name)).attr("transform","translate("+o.scale.x(a.name)+",0)");var n=t.area().curve(t.curveBasis).x(function(t){return a.scale.x(Math.min(f,Math.max(d,t.x)))}).y0(10).y1(function(t){return a.scale.y(t.y)});var r=t.line().curve(t.curveBasis).x(function(t){return a.scale.x(Math.min(f,Math.max(d,t.x)))}).y(function(t){return a.scale.y(t.y)});o.violins[a.name]={g:e,area:{fn:n,left:e.append("path").attr("class","leftarea").attr("d",n(a.data)).attr("transform","rotate(90) translate(0,"+(10-.5)+") scale(1,-1)").style("fill-opacity",.3).style("stroke","none"),right:e.append("path").attr("class","rightarea").attr("d",r(a.data)).attr("transform","rotate(90) translate(0,-"+(10+.5)+")").style("fill-opacity",.3).style("stroke","none")},line:{fn:r,left:e.append("path").attr("cladd","leftline").attr("d",r(a.data)).attr("transform","rotate(90) translate(0,"+(10-.5)+") scale(1,-1)").style("fill","none").style("stroke-width","1px"),right:e.append("path").attr("cladd","rightline").attr("d",r(a.data)).attr("transform","rotate(90) translate(0,-"+(10+.5)+")").style("fill","none").style("stroke-width","1px")}}})}c.forEach(function(t){t.scale.x.range([i.attr.innerHeight,0]);o.violins[t.name].g.transition().duration(a).attr("transform","translate("+o.scale.x(t.name)+",0)");o.violins[t.name].area.fn.x(function(a){return t.scale.x(Math.min(f,Math.max(d,a.x)))}).y1(function(a){return t.scale.y(a.y)});o.violins[t.name].area.left.transition().duration(a).attr("d",o.violins[t.name].area.fn(t.data));o.violins[t.name].area.right.transition().duration(a).attr("d",o.violins[t.name].area.fn(t.data));o.violins[t.name].line.fn.x(function(a){return t.scale.x(Math.min(f,Math.max(d,a.x)))}).y(function(a){return t.scale.y(a.y)});o.violins[t.name].line.left.transition().duration(a).attr("d",o.violins[t.name].line.fn(t.data));o.violins[t.name].line.right.transition().duration(a).attr("d",o.violins[t.name].line.fn(t.data))})}};i.render.style=function(){i.attr.colors=i.utils.colors(c?c.map(function(t){return t.name}):null);o.g.style("width",i.attr.innerWidth+"px").style("height",i.attr.innerHeight+"px").attr("transform","translate("+i.attr.margins.left+","+i.attr.margins.top+")").style("pointer-events","all");o.axes.x.attr("transform","translate(0,"+i.attr.innerHeight+")");o.axisFn.y.tickFormat(i.attr.yTickFormat);o.axes.y.attr("transform","translate(0,"+1+")");o.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");o.labels.x.attr("x",i.attr.innerWidth+"px").attr("y",i.attr.innerHeight+2.2*i.attr.fontSize+"px").attr("fill",i.attr.fontColor).style("font-size",i.attr.fontSize+"px").text(i.attr.xLabel);o.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",i.attr.fontColor).style("font-size",i.attr.fontSize+"px").text(i.attr.yLabel);a.forOwn(o.violins,function(t,a){t.line.left.style("stroke",i.attr.colors[a]);t.line.right.style("stroke",i.attr.colors[a]);t.area.left.style("fill",i.attr.colors[a]);t.area.right.style("fill",i.attr.colors[a]);t.g.on("mouseover",function(t){u=t;i.attr.mouseover&&i.attr.mouseover(a)}).on("mouseleave",function(){u=null;i.attr.mouseleave&&i.attr.mouseleave(a)}).on("click",function(){i.attr.click&&i.attr.click(a)})})}}n.prototype=Object.create(e.prototype);return n});