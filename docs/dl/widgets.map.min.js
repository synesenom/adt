(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("lodash"),require("topojson"),require("leaflet"),require("./math.la"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","_","topojson","leaflet","src/math.la","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.Map=e(t.d3,t._,t.topojson,t.L,t.du.math.la,t.du.Widget)}})(this,function(t,e,r,n,a,o){"use strict";function i(i,s){var l="du-widgets-map";var u=o.call(this,i,"map","div",s);var c=this;u.attr.add(this,"resource",null);u.attr.add(this,"centerX",0);u.attr.add(this,"centerY",0);u.attr.add(this,"backgroundColor","white");u.attr.add(this,"foregroundColor","black");u.attr.add(this,"borderColor","white");u.attr.add(this,"outClick",null);u.attr.add(this,"tiles",null);u.attr.add(this,"noZoom",false);u.attr.add(this,"ready",null);var f=function(){var e=null;var n=null;var a=t.map();function o(o){t.json(u.attr.resource,function(i,s){e=r.feature(s.paths,s.paths["objects"]["countries"]).features;e.filter(function(t){return s.info.some(function(e){if(t.id===e.id)return t.name=e.name})}).sort(function(t,e){return t.name.localeCompare(e.name)});n=t.map();s.info.forEach(function(t){n.set(t.name,{name:t.name,capital:t.capital,population:t.population})});e.forEach(function(t,e){a.set(t.name,e)});o&&o()})}function i(t){return a.has(t)?a.get(t):null}function s(){return e.map(function(t){return{id:t.id,name:t.name}})}function l(t){return t&&n.has(t)?n.get(t).capital:n.values().map(function(t){return{name:t.name,capital:t.capital}})}function c(t){return t&&n.has(t)?n.get(t).population:n.values().map(function(t){return{name:t.name,population:t.population}})}function h(t,e){var r,n,a,o,i,s=t[0],l=t[1],u=false;for(var c=0,f=e.length-1;c<e.length;f=c++){r=e[c][0];a=e[c][1];n=e[f][0];o=e[f][1];i=a>l!==o>l&&s<(n-r)*(l-a)/(o-a)+r;if(i)u=!u}return u}function d(t,e){var r=f._id(t);if(r){var n=p._project(e);var a=f._paths()[r].svg.areas;for(var o=0;o<a.length;o++){if(h(n,a[o])){return true}}}return false}return{_paths:function(){return e},_id:i,_build:o,get:s,capital:l,population:c,containsGeoLoc:d}}();this.countries={get:f.get,capital:f.capital,population:f.population,containsGeoLoc:f.containsGeoLoc};var h=function(){var t={};function r(t,e){return u.utils.encode(t)+"__"+u.utils.encode(e)}function n(e){if(e&&t.hasOwnProperty(e)){return Object.keys(t[e])}else{return Object.keys(t)}}function a(e,r){if(!t.hasOwnProperty(e)){t[e]=r;return true}else{return false}}function o(n){if(t.hasOwnProperty(n)){e.forOwn(t[n],function(t,e){var a=r(n,e);t.forEach(function(t){if(typeof f._id(t)==="number"){p._select(t).classed(a,false)}})});return true}else{return false}}function i(){e.forOwn(t,function(t,n){e.forOwn(t,function(t,e){var a=r(n,e);t.forEach(function(t){if(typeof f._id(t)==="number"){p._select(t).classed(a,true)}})})})}return{get:n,add:a,remove:o,selector:r,_mark:i}}();this.clustering={get:h.get,add:h.add,remove:h.remove,selector:h.selector};var d=function(){var e=128;var r=.3;var n={};var a=t.zoomIdentity;var o=1;var i=t.zoom().scaleExtent([1,e]).on("zoom",d);function s(t){return a.apply(t)}function l(t){return a.invert(t)}function c(){return o}function f(){i.translateExtent([[-r*u.attr.width,-r*u.attr.height],[(1+r)*u.attr.width,(1+r)*u.attr.height]])}function h(t,e){n[t]=e}function d(){if(u.attr.noZoom){return}var e=t.event.transform.k;n.map.paths.style("stroke-width",.5/e+"px");n.map.paths.attr("transform",t.event.transform);y._zoom(t.event.transform);v._zoom(t.event.transform);g._zoom(t.event.transform);m._zoom(t.event.transform);if(t.event&&t.event.transform){a=t.zoomIdentity.translate(t.event.transform.x,t.event.transform.y).scale(t.event.transform.k);o=t.event.transform.k}}function p(){n.map.svg.transition().duration(1e3).call(i.transform,t.zoomIdentity)}function w(r){var a=r[1][0]-r[0][0],o=r[1][1]-r[0][1],s=(r[0][0]+r[1][0])/2,l=(r[0][1]+r[1][1])/2,c=Math.max(1,Math.min(e,.8/Math.max(a/u.attr.width,o/u.attr.height))),f=[u.attr.width/2-c*s,u.attr.height/2-c*l];n.map.svg.transition().duration(1e3).call(i.transform,t.zoomIdentity.translate(f[0],f[1]).scale(c))}function b(){return a}return{init:f,setLayer:h,zoom:i,reset:p,click:w,transform:s,invert:l,level:c,current:b}}();var p=function(){var e=u.widget.append("svg").attr("id",l+"-map-layer").style("position","absolute").call(d.zoom);var r=e.append("rect").attr("id","water").style("position","absolute").style("width","100%").style("height","100%").style("fill","transparent").style("top",0).style("left",0);var n=e.append("g").attr("id","land");var a=null;var o=t.geoMercator().precision(.1);var i=t.geoPath().projection(o);var s=null;function h(t){return o([t[1],t[0]])}function p(t){return o.invert(t).reverse()}function v(){f._paths().forEach(function(t){t.svg.center=i.centroid(t)})}function y(){f._paths().forEach(function(e){var r=[];var n=[];var a=e.geometry.coordinates;if(a.length===1){a[0].forEach(function(t){var a=o(t);r.push(Math.abs(a[0]-e.svg.center[0]));n.push(Math.abs(a[1]-e.svg.center[1]))})}else{a.forEach(function(t){t[0].forEach(function(t){var a=o(t);r.push(Math.abs(a[0]-e.svg.center[0]));n.push(Math.abs(a[1]-e.svg.center[1]))});if(t.length>1){t.forEach(function(t){var a=o(t);r.push(Math.abs(a[0]-e.svg.center[0]));n.push(Math.abs(a[1]-e.svg.center[1]))})}})}e.svg.width=t.max(r)*2;e.svg.height=t.max(n)*2})}function g(){f._paths().forEach(function(t){t.svg.areas=null;if(t.geometry.coordinates.length===1){var e=[];t.geometry.coordinates[0].forEach(function(t){e.push(o(t))});t.svg.areas=[e]}else{t.svg.areas=[];t.geometry.coordinates.forEach(function(e){var r=[];if(e.length>1){e.forEach(function(t){r.push(o(t))})}else{e[0].forEach(function(t){r.push(o(t))})}t.svg.areas.push(r)})}})}function m(){a=n.selectAll("path").data(f._paths()).enter().append("path").attr("class",function(t){return"country-"+f._id(t.name)}).style("stroke-width","0.5px").style("cursor","pointer");w();b()}function w(){if(a===null){return}o.scale(u.attr.width/(2*Math.PI)).translate([u.attr.width/2+u.attr.centerX,u.attr.height/2+u.attr.centerY]);i=t.geoPath().projection(o);f._paths().forEach(function(t){t.svg={}});v();y();g()}function b(){if(a===null){return}e.attr("width",u.attr.width+"px").attr("height",u.attr.height+"px");r.style("fill",u.attr.backgroundColor).style("width",u.attr.width+"px").style("height",u.attr.height+"px").on("click",function(){d.reset();a.classed("focus",false).style("fill",function(t){return u.attr.colors&&u.attr.colors[t.name]?u.attr.colors[t.name]:u.attr.foregroundColor});if(u.attr.outClick)u.attr.outClick()});a.attr("d",i).style("fill",function(t){return u.attr.colors&&u.attr.colors[t.name]?u.attr.colors[t.name]:u.attr.foregroundColor}).style("stroke",u.attr.borderColor).style("cursor","pointer").on("mouseover",function(e,r){t.select(this).style("fill",t.color(u.attr.colors&&u.attr.colors[e.name]?u.attr.colors[e.name]:u.attr.foregroundColor).brighter());u.attr.mouseover&&u.attr.mouseover(e.name)}).on("mouseleave",function(e,r){var n=t.select(this);var a=t.color(u.attr.colors&&u.attr.colors[e.name]?u.attr.colors[e.name]:u.attr.foregroundColor);n.style("fill",n.classed("focus")?a.brighter():a);u.attr.mouseleave&&u.attr.mouseleave(e.name)}).on("click",function(e,r){var n=t.select(this);var o=n.classed("focus");if(o)d.reset();else{d.click(i.bounds(e))}a.classed("focus",function(t){return t===e?!o:false}).style("fill",function(t){return u.attr.colors&&u.attr.colors[t.name]?u.attr.colors[t.name]:u.attr.foregroundColor});var s=t.color(u.attr.colors&&u.attr.colors[e.name]?u.attr.colors[e.name]:u.attr.foregroundColor);n.style("fill",!o?s.brighter():s);u.attr.click&&u.attr.click(e.name)});d.setLayer("map",{svg:e,paths:a,labels:s})}function _(t){if(typeof t==="string"){return f._id(t)?n.select("path.country-"+f._id(t)):n.selectAll("path."+u.utils.encode(t))}else{return a}}function x(t){a.style("opacity",t?t:1);return c}function k(e,r,n){_(e).transition().duration(n?n:0).style("fill",function(n){var a=u.attr.colors&&u.attr.colors[n.name]?u.attr.colors[n.name]:u.attr.foregroundColor;return typeof r==="string"?r:typeof e==="string"?t.color(a).brighter():a});return c}return{_select:_,_project:h,_invert:p,_build:m,_update:w,_style:b,dim:x,highlight:k}}();this.dim=p.dim;this.highlight=p.highlight;var v=function(){var t=u.widget.append("div").attr("id",l+"-static-layers").style("position","absolute").style("pointer-events","none").style("width",u.attr.width+"px").style("height",u.attr.height+"px");var r={};function n(t,e,r){return[e[0]*t[0]+r[0],e[1]*t[1]+r[1]]}function o(){return Object.keys(r)}function i(e){var o=u.utils.encode(e);if(!r.hasOwnProperty(o)){r[o]=function(){var e=t.append("canvas").attr("id",l+"-static-layer-"+o).attr("width",u.attr.width+"px").attr("height",u.attr.height+"px").style("position","absolute").style("pointer-events","none");var r=e.node().getContext("2d");var i=[];function s(t,e){h[t](e);i.push({type:t,params:e});return true}function c(t,e){var r=[1/t,1/t],o=[u.attr.centerX*(t-1)/t,(u.attr.height*(t-e)/2+u.attr.centerY*(t-1))/t];i.forEach(function(t){switch(t.type){case"dot":case"circle":t.params.pos=n(t.params.pos,r,o);break;case"arrow":for(var e=0;e<t.params.segments.length;e++){t.params.segments[e]=new a.Vector2(n(t.params.segments[e].toArray(),r,o))}break}})}function f(){i=[]}var h={dot:function(t,e){if(t.color)r.fillStyle=t.color;var n=t.size/(e?d.level():1);var a=!e?d.transform(t.pos):t.pos;r.fillRect(a[0]-n/2,a[1]-n/2,n,n)},circle:function(t,e){if(t.color)r.fillStyle=t.color;var n=t.radius/(e?d.level():1);var a=!e?d.transform(t.pos):t.pos;r.beginPath();r.arc(a[0],a[1],n,0,2*Math.PI,false);r.fill()},arrow:function(t,e){if(t.color)r.strokeStyle=t.color;var n=t.width/(e?d.level():1);var a=[];t.segments.forEach(function(t){a.push(!e?t.map(d.transform):t)});var o=n*2;var i=n*5;var s=a[a.length-2];var l=a[a.length-1];var c=l.sub(s).length(i);r.beginPath();r.lineWidth=n;r.lineJoin="round";r.moveTo(a[0].x(),a[0].y());for(var f=1;f<a.length-1;f++){if(a[f].sub(a[f-1]).length()<.6*u.attr.width)r.lineTo(a[f].x(),a[f].y());else r.moveTo(a[f].x(),a[f].y())}var h=l.sub(c.length(.5*i));r.lineTo(h.x(),h.y());r.stroke();var p=c.angle(c.angle()+Math.PI/2).length(o);var v=l.sub(c).sub(p);var y=l.sub(c).add(p);r.beginPath();r.moveTo(v.x(),v.y());r.lineTo(y.x(),y.y());r.lineTo(l.x(),l.y());r.closePath();r.fillStyle=t.color;r.fill()}};function p(){var t=d.invert([0,0]);var e=d.invert([u.attr.width,u.attr.height]);var r={xMin:t[0],xMax:e[0],yMin:t[1],yMax:e[1]};i.forEach(function(t){if(t.params.pos&&(t.params.pos[0]<r.xMin||t.params.pos[0]>r.xMax||t.params.pos[1]<r.yMin||t.params.pos[1]>r.yMax)){return}h[t.type](t.params,true)})}return{g:e,canvas:r,rescaleContent:c,clearContent:f,append:s,render:p}}();return true}else{return false}}function s(){var n=parseFloat(t.style("width"))/u.attr.width;var a=parseFloat(t.style("height"))/u.attr.height;t.style("width",u.attr.width+"px").style("height",u.attr.height+"px");e.forOwn(r,function(t){t.g.attr("width",u.attr.width+"px").attr("height",u.attr.height+"px");t.rescaleContent(n,a);t.render()});b(d.current())}function f(t){var e=u.utils.encode(t);if(r.hasOwnProperty(e)){r[e].canvas.clearRect(0,0,u.attr.width,u.attr.height);r[e].clearContent();return true}else{return false}}function h(){e.forOwn(r,function(t){t.canvas.save();t.canvas.clearRect(0,0,u.attr.width,u.attr.height)})}function y(t){var n=u.utils.encode(t);if(n&&r.hasOwnProperty(n)){e.forOwn(r,function(t,e){t.g.transition().duration(100).style("opacity",n===e?1:0)})}else{e.forOwn(r,function(t){t.g.transition().duration(100).style("opacity",1)})}return c}function g(t){e.forOwn(r,function(e){e.render(t)})}function m(){e.forOwn(r,function(t){t.canvas.restore()})}var w={dot:function(t,e,n,a){if(!e||e.length<2||typeof e[0]!=="number"||typeof e[1]!=="number")return false;var o=u.utils.encode(t);return r.hasOwnProperty(o)&&r[o].append("dot",{pos:p._project(e),size:n,color:a})},circle:function(t,e,n,a){if(!e||e.length<2||typeof e[0]!=="number"||typeof e[1]!=="number")return false;if(typeof n!=="number"||isNaN(n)||n<=0)return false;var o=u.utils.encode(t);return r.hasOwnProperty(o)&&r[o].append("circle",{pos:p._project(e),radius:n,color:a})},arrow:function(t,e,n,o,i){if(!e||e.length<2||typeof e[0]!=="number"||typeof e[1]!=="number")return false;if(!n||n.length<2||typeof n[0]!=="number"||typeof n[1]!=="number")return false;if(typeof o!=="number")return false;var s=u.utils.encode(t);if(r.hasOwnProperty(s)){var l=new a.LatLon(e).toVec(),c=new a.LatLon(n).toVec(),f=l.cross(c).cross(l).length(1),h=Math.acos(l.dot(c));var d=1,v=100,y=o*5,g=new a.Vector2(p._project(e)),m=new a.Vector2(p._project(n)),w=g,b=[w];do{var _=new a.Vector2(p._project(l.multiply(Math.cos((d+1)*h/v)).add(f.multiply(Math.sin((d+1)*h/v))).toLatLon().toArray()));d++;w=_;b.push(_)}while(d<v&&_.sub(m).length()>y);b.push(m);r[s].append("arrow",{segments:b,width:o,color:i});return true}else{return false}}};function b(t){v._clear();e.forOwn(r,function(e){e.canvas.translate(t.x,t.y);e.canvas.scale(t.k,t.k)});v._render(t.k);v._restore()}return{_style:s,_zoom:b,_clear:h,_restore:m,_render:g,get:o,add:i,highlight:y,erase:f,draw:w}}();this.staticLayer={get:v.get,add:v.add,erase:v.erase,highlight:v.highlight,draw:v.draw};var y=function(){var e=u.widget.append("div").attr("id",l+"-tiles-layer").style("position","absolute").style("pointer-events","none").style("z-index",99).style("opacity",.5).style("width",u.attr.width+"px").style("height",u.attr.height+"px");var r=null;function a(t){return p._invert([t[0]-.5*u.attr.width,t[1]+.5*u.attr.height])}function o(t){return Math.log(.00391382924*t*u.attr.width)/Math.log(2)}function i(){if(u.attr.tiles===null){return}if(!this.headerAdded){t.select("head").append("link").attr("rel","stylesheet").attr("href","https://unpkg.com/leaflet@1.3.1/dist/leaflet.css").attr("integrity","sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==").attr("crossorigin","");this.headerAdded=true}r=n.map(l+"-tiles-layer",{attributionControl:false,zoomSnap:0,zoomControl:false}).setView(a([0,0]),o(d.level()));var e=null,i=null;switch(u.attr.tiles){case"cartodb-positron":e="https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png";i="abcd";break}if(e&&i){n.tileLayer(e,{subdomains:i}).addTo(r)}}function s(){if(r===null){return}e.style("width",u.attr.width+"px").style("height",u.attr.height+"px");r.invalidateSize()}function c(t){if(r===null){return}r.setView(a([-t.x/t.k-.5*(t.k-1)*u.attr.width/t.k,-t.y/t.k-.5*(t.k-1)*u.attr.height/t.k]),o(t.k),true)}return{_build:i,_style:s,_getLatLon:a,_getZoom:o,_zoom:c}}();var g=function(){var r=u.widget.append("div").attr("id",l+"-dynamic-layers").style("position","absolute").style("pointer-events","none");var n={};function o(){return Object.keys(n)}function i(e){var a=u.utils.encode(e);if(!n.hasOwnProperty(a)){n[a]=function(){var e=r.append("svg").attr("id",l+"-dynamic-layer-"+a).attr("width",u.attr.width+"px").attr("height",u.attr.height+"px").style("position","absolute").style("pointer-events","none").append("g");var n=[];function o(t){n.push({elem:t,birth:(new Date).getTime()/1e3})}setInterval(function(){var e=(new Date).getTime()/1e3;var r=[];n.forEach(function(n){if(e-n.birth>10){n.elem.transition().duration(700).style("opacity",0).on("end",function(){t.select(this).remove()})}else{r.push(n)}});n=r},2e3);return{g:e,append:o}}();return true}else{return false}}function s(){r.style("width",u.attr.width+"px").style("height",u.attr.height+"px");e.forOwn(n,function(t){t.g.attr("width",u.attr.width+"px").attr("height",u.attr.height+"px")})}function f(t){var e=u.utils.encode(t);if(n.hasOwnProperty(e)){n[e].g.html("");return true}else{return false}}function h(t){var r=u.utils.encode(t);if(r&&n.hasOwnProperty(r)){e.forOwn(n,function(t,e){t.g.transition().duration(200).style("opacity",r===e?1:0)})}else{e.forOwn(n,function(t){t.g.transition().duration(200).style("opacity",1)})}return c}var v={circle:function(e,r,a,o,i,s){if(!r||r.length<2||typeof r[0]!=="number"||typeof r[1]!=="number")return false;if(typeof a!=="number"||isNaN(a)||a<=0)return false;var l=u.utils.encode(e);if(n.hasOwnProperty(l)){var c=a/d.level();var f=p._project(r);var h=n[l].g.append("circle").attr("class","circle").attr("cx",f[0]).attr("cy",f[1]).attr("r",c).style("fill",o);n[l].append(h);h.transition().duration(i?i:700).ease(t.easeExp).attr("r",0).on("end",function(){s&&s();t.select(this).remove()});return true}else{return false}},arrow:function(e,r,o,i,s,l,c){if(!r||r.length<2||typeof r[0]!=="number"||typeof r[1]!=="number")return false;if(!o||o.length<2||typeof o[0]!=="number"||typeof o[1]!=="number")return false;if(typeof i!=="number")return false;var f=u.utils.encode(e);if(n.hasOwnProperty(f)){var h=100;var v=null;var y=null;var g=new a.Vector2(p._project(r));var m=new a.Vector2(p._project(o));var w=i/d.level();var b=w*2;var _=w*5;v=n[f].g.append("path").style("fill","none").style("stroke",s).style("stroke-width",w).attr("d","M"+g.x()+","+g.y());y=n[f].g.append("path").style("fill",s).style("stroke","none");var x=new a.LatLon(r).toVec();var k=new a.LatLon(o).toVec();var O=x.cross(k).cross(x).length(1);var M=Math.acos(x.dot(k));var L=1;var j=g;var E=(typeof l==="number"?l:700)/h;var P=setInterval(function(){var e=new a.Vector2(p._project(x.multiply(Math.cos((L+1)*M/h)).add(O.multiply(Math.sin((L+1)*M/h))).toLatLon().toArray()));v.attr("d",v.attr("d")+(e.sub(j).length()<.5*u.attr.width?"L":"M")+e.x()+","+e.y());if(e.sub(j).length()<.5*u.attr.width){var r=e.sub(j).length(1);var n=r.angle(r.angle()+Math.PI/2).multiply(b);var o=e.sub(n);var i=e.add(n);var s=e.add(r.multiply(_));y.attr("d","M"+o.x()+","+o.y()+"L"+i.x()+","+i.y()+"L"+s.x()+","+s.y()+"Z")}if(e.sub(m).length()>_){L++;j=e}else{clearInterval(P);r=m.sub(e).length(1);n=r.angle(r.angle()+Math.PI/2).multiply(b);o=m.sub(r.multiply(_)).sub(n);i=m.sub(r.multiply(_)).add(n);y.transition().duration(E).attr("d","M"+o.x()+","+o.y()+"L"+i.x()+","+i.y()+"L"+m.x()+","+m.y()+"Z").on("end",function(){c&&c();v.transition().duration(1e3).style("opacity",0).on("end",function(){t.select(this).remove()});t.select(this).transition().duration(1e3).style("opacity",0).on("end",function(){t.select(this).remove()})})}},E);return true}else{return false}}};function y(t){e.forOwn(n,function(e){e.g.attr("transform",t)})}return{_style:s,_zoom:y,get:o,add:i,highlight:h,erase:f,draw:v}}();this.dynamicLayer={get:g.get,add:g.add,highlight:g.highlight,erase:g.erase,draw:g.draw};var m=function(){var t=u.widget.append("svg").attr("id",l+"-touch-layer").attr("width",u.attr.width+"px").attr("height",u.attr.height+"px").style("position","absolute").style("pointer-events","none");var e=t.append("g");function r(t,r,n,a,o,i){if(!r||r.length<2||typeof r[0]!=="number"||typeof r[1]!=="number")return false;var s=n/d.level();var u=p._project(r);e.append("circle").attr("id",l+"-touch-layer-"+t).attr("cx",u[0]).attr("cy",u[1]).attr("r",s).style("fill",null).style("opacity",0).style("pointer-events","all").on("mouseover",function(t,e){if(a)a(t,e)}).on("mouseleave",function(t,e){if(o)o(t,e)}).on("click",function(t,e){if(i)i(t,e)});return true}function n(t){var r=e.select("#"+t);if(r.empty())return false;else{r.remove();return true}}function a(){t.style("width",u.attr.width+"px").style("height",u.attr.height+"px");e.style("width",u.attr.width+"px").style("height",u.attr.height+"px")}function o(t){e.attr("transform",t)}function i(){e.html("")}return{_style:a,_zoom:o,add:r,remove:n,erase:i}}();this.touchLayer={add:m.add,remove:m.remove,erase:m.erase};u.render.build=function(){f._build(function(){p._build();y._build();u.attr.ready&&u.attr.ready()})};u.render.update=function(){p._update()};u.render.style=function(){u.widget.style("background-color",u.attr.backgroundColor).style("pointer-events",null);d.init();p._style();v._style();g._style();y._style();m._style();h._mark()}}i.prototype=Object.create(o.prototype);return i});