(function(t,a){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=a(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","d3-contour","src/widget","exports"],a)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.HeatMap=a(t.d3,t.du.Widget)}})(this,function(y,r){"use strict";function t(t,a){var g=r.call(this,t,"heatmap","svg",a);g.attr.add(this,"grid",[40,40]);g.attr.add(this,"smooth",false);var u={};var l=[];var x=null;var s=false;this.data=function(t){l={xDomain:y.extent(t,function(t){return t.x}),yDomain:y.extent(t,function(t){return t.y}),values:new Array((1+g.attr.grid[0])*(1+g.attr.grid[1])).fill(0)};var e=(l.xDomain[1]-l.xDomain[0])/g.attr.grid[0],i=(l.yDomain[1]-l.yDomain[0])/g.attr.grid[1];t.forEach(function(t){var a=Math.floor((t.x-l.xDomain[0])/e),r=Math.floor((t.y-l.yDomain[0])/i);l.values[a+r*g.attr.grid[0]]+=t.value||1});return this};g.utils.tooltip=function(t){if(!t){return null}var a=u.scale.x.invert(t[0]),r=u.scale.y.invert(t[1]);var e=(l.xDomain[1]-l.xDomain[0])/g.attr.grid[0],i=(l.yDomain[1]-l.yDomain[0])/g.attr.grid[1];var n=Math.floor((a-l.xDomain[0])/e),s=g.attr.grid[1]-Math.ceil((r-l.yDomain[0])/i);var o=l.values[n+g.attr.grid[0]*s];if(typeof o==="undefined"){return null}return{title:"Value: "+o.toPrecision(3),stripe:x(o),content:{type:"metrics",data:[{label:g.attr.xLabel+":",value:g.attr.tooltipXFormat(a)},{label:g.attr.yLabel+":",value:g.attr.tooltipYFormat(r)}]}}};function o(t,a,r){var e=u.canvas.ctx.createImageData(g.attr.grid[0],g.attr.grid[1]);for(var i=0,n=0,s=0;i<g.attr.grid[1];i++){for(var o=0;o<g.attr.grid[0];o++,n++,s+=4){var l=y.rgb(t[s],t[s+1],t[s+2],t[s+3]/255),c=x(a[n]),d=y.rgb(y.interpolateHsl(l,c)(r));e.data[s]=d.r;e.data[s+1]=d.g;e.data[s+2]=d.b;e.data[s+3]=255*d.opacity}}u.canvas.ctx.putImageData(e,0,0);return e}g.render.build=function(){u=g.utils.standardAxis();u.plots={};u.canvas={};u.canvas.container=g.widget.append("foreignObject").attr("x",g.attr.margins.left+1).attr("y",g.attr.margins.top).attr("width",g.attr.innerWidth).attr("height",g.attr.innerHeight);u.canvas.canvas=u.canvas.container.append("xhtml:body").style("margin",0).style("padding",0).style("background-color","none").style("width","100%").style("height","100%").style("background-color","transparent").append("canvas").attr("x",0).attr("y",0).attr("width",g.attr.grid[0]).attr("height",g.attr.grid[1]).style("width",g.attr.innerWidth+"px").style("height",g.attr.innerHeight+"px");u.canvas.ctx=u.canvas.canvas.node().getContext("2d");u.canvas.img=u.canvas.ctx.createImageData(g.attr.grid[0],g.attr.grid[1]).data};g.render.update=function(e){u.scale={x:g.utils.scale(l.xDomain,[0,g.attr.innerWidth]),y:g.utils.scale(l.yDomain,[g.attr.innerHeight,0])};var a=y.interpolateHsl(g.attr.colors?g.attr.colors[0]:"transparent",g.attr.colors?g.attr.colors[1]:"grey"),r=y.interpolateHsl(g.attr.colors?g.attr.colors[1]:"grey",g.attr.colors?g.attr.colors[2]:"black"),t=function(t){return t<.5?a(t*2):r((t-.5)*2)};x=y.scaleSequential(t).domain(y.extent(l.values));u.axes.x.transition().duration(e).call(u.axisFn.x.tickValues(g.attr.xTicks).scale(u.scale.x));u.axes.y.transition().duration(e).call(u.axisFn.y.tickValues(g.attr.yTicks).scale(u.scale.y));s=true;var i=u.canvas.ctx.createImageData(g.attr.grid[0],g.attr.grid[1]);var n=y.timer(function(t){var a=t/e;o(u.canvas.img,l.values,a);if(a>=1){var r=o(u.canvas.img,l.values,1);u.canvas.img=r.data.slice();s=false;n.stop()}})};g.render.style=function(){u.g.attr("width",g.attr.innerWidth+"px").attr("height",g.attr.innerHeight+"px").attr("transform","translate("+g.attr.margins.left+","+g.attr.margins.top+")").style("pointer-events","all");u.canvas.container.attr("x",g.attr.margins.left+1).attr("y",g.attr.margins.top).attr("width",g.attr.innerWidth).attr("height",g.attr.innerHeight);u.canvas.canvas.style("width",g.attr.innerWidth+"px").style("height",g.attr.innerHeight+"px").style("image-rendering",g.attr.smooth?null:"crisp-edges").style("image-rendering",g.attr.smooth?null:"pixelated");u.axisFn.x.tickFormat(g.attr.xTickFormat);u.axes.x.attr("transform","translate(0,"+g.attr.innerHeight+")");u.axisFn.y.tickFormat(g.attr.yTickFormat);u.axes.y.attr("transform","translate(0,"+1+")");u.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");u.labels.x.attr("x",g.attr.innerWidth+"px").attr("y",g.attr.innerHeight+2.2*g.attr.fontSize+"px").attr("fill",g.attr.fontColor).style("font-size",g.attr.fontSize+"px").text(g.attr.xLabel);u.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",g.attr.fontColor).style("font-size",g.attr.fontSize+"px").text(g.attr.yLabel)}}t.prototype=Object.create(r.prototype);return t});