(function(t,r){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=r(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","src/widget","exports"],r)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.MultiBarChart=r(t.d3,t.du.Widget)}})(this,function(x,a){"use strict";function t(t,r){var o=a.call(this,t,"multibarchart","svg",r);o.attr.add(this,"barWidth",false);o.attr.add(this,"sortByX",false);var u={};var d=[];var c={};var f=null;var p=false;var y={};this.data=function(t){d=t.map(function(t){return{name:t.name,values:t.values.map(function(t){return{x:t.x,y:t.y,lo:t.lo||0,hi:t.hi||0}})}});return this};this.highlight=function(t,r){if(!p)o.utils.highlight(this,u,".bar",t,r);return this};this.highlightRange=function(t,r){if(!p)o.utils.highlightRange(this,u,".bar",t,r);return this};function e(r,t){var e=d.filter(function(t){return t.name===r})[0];if(!e){return null}var a=x.bisector(function(t){return t.x}).left;var n=a(e.values,start);var i=a(e.values,end);if(n===null||i===null){return null}var s=e.values[n].x,l=e.values[n].y,o=e.values[i].x,u=e.values[i].y;var c=l<u?s:o;var f=l<u?u:l;return{start:{x:s,y:l},end:{x:o,y:u},corner:{x:c,y:f}}}this.addMarker=function(t,r,e,a,n){if(y.hasOwnProperty(t)){return null}var i=u.g.append("g").attr("class","marker");i.append("line").attr("class","horizontal").attr("x1",u.scale.x.range()[0]).attr("y1",u.scale.y(r)).attr("x2",u.scale.x.range()[1]).attr("y2",u.scale.y(r)).style("stroke",n||o.attr.fontColor).style("stroke-dasharray","3 3").style("stroke-width",1);i.append("text").attr("x",u.scale.x.range()[0]+(a||0)*(u.scale.x.range()[1]-u.scale.x.range()[0])).attr("y",u.scale.y(r)).attr("dx",5).attr("dy",-5).attr("text-anchor","start").style("fill",n||o.attr.fontColor).style("font-family","inherit").style("font-size","0.9em").text(e);var s={g:i,update:function(t){i.select(".horizontal").transition().duration(t).attr("x1",u.scale.x.range()[0]).attr("y1",u.scale.y(r)).attr("x2",u.scale.x.range()[1]).attr("y2",u.scale.y(r));i.select("text").transition().duration(t).attr("x",u.scale.x.range()[0]+(a||0)*(u.scale.x.range()[1]-u.scale.x.range()[0])).attr("y",u.scale.y(r))}};y[t]=s;return s};this.removeMarker=function(t){if(y.hasOwnProperty(t)){y[t].g.remove();delete y[t];return true}return false};o.utils.tooltip=function(){if(!f){return null}var e=f.x;var t=d.map(function(t){var r=t.values.filter(function(t){return t.x===e});return{name:t.name,color:c[t.name],value:r.length>0?o.attr.tooltipYFormat(r[0].y):"n/a"}});return{title:o.attr.tooltipXFormat(e),content:{type:"plots",data:t}}};o.render.build=function(){u=o.utils.standardAxis();u.plots={}};o.render.update=function(t){var a=d.slice();var r=a.reduce(function(t,r){return t.concat(r.values)},[]).map(function(t){return t.x});if(o.attr.sortByX){r.sort(function(t,r){return t.localeCompare(r)})}u.scale={x:o.utils.scale(r,[0,o.attr.innerWidth],"band"),y:o.utils.scale(a.reduce(function(t,r){return t.concat(r.values)},[]).map(function(t){return t.y}).concat([0]),[o.attr.innerHeight,0])};u.axes.x.transition().duration(t).call(u.axisFn.x.scale(u.scale.x));u.axes.y.transition().duration(t).call(u.axisFn.y.scale(u.scale.y));c=o.utils.colors(d?d.map(function(t){return t.name}):null);u.plots.groups=u.g.selectAll(".bar-group").data(d,function(t){return t.name});u.plots.groups.exit().transition().duration(t).remove();var e=u.plots.groups.enter().append("g").attr("class",function(t){return"bar-group "+o.utils.encode(t.name)}).style("shape-rendering","geometricPrecision").style("stroke","none").style("fill","transparent");u.plots.groups=e.merge(u.plots.groups).each(function(){p=true});u.plots.groups.transition().duration(t).style("fill-opacity",o.attr.opacity).style("fill",function(t){return c[t.name]}).on("end",function(){p=false});var n=d.length>0?u.scale.x.bandwidth():1,i=n*o.attr.barWidth,s=n*(1-o.attr.barWidth)/2;u.plots.bars=u.plots.groups.selectAll(".bar").data(function(r,e){return r.values.map(function(t){return{name:r.name,n:a.length,i:e,x:t.x,y:t.y}})});u.plots.bars.exit().transition().duration(t).style("opacity",0).remove();u.plots.bars.enter().append("rect").attr("class",function(t){return"bar "+o.utils.encode(t.name)}).style("opacity",0).attr("x",function(t){return u.scale.x(t.x)+s+i*t.i/t.n}).attr("y",o.attr.height-o.attr.margins.top-o.attr.margins.bottom).attr("width",function(t){return i/t.n}).attr("height",0).merge(u.plots.bars).on("mouseover",function(t){f=t;o.attr.mouseover&&o.attr.mouseover(t.name)}).on("mouseleave",function(t){f=null;o.attr.mouseleave&&o.attr.mouseleave(t.name)}).on("click",function(t){o.attr.click&&o.attr.click(t.name)}).transition().duration(t).style("opacity",1).attr("x",function(t){return u.scale.x(t.x)+s+i*t.i/t.n}).attr("y",function(t){return u.scale.y(t.y)}).attr("width",function(t){return i/t.n}).attr("height",function(t){return o.attr.height-o.attr.margins.top-o.attr.margins.bottom-u.scale.y(t.y)});for(var l in y){if(y.hasOwnProperty(l)){y[l].update(t)}}};o.render.style=function(){u.g.attr("width",o.attr.innerWidth+"px").attr("height",o.attr.innerHeight+"px").attr("transform","translate("+o.attr.margins.left+","+o.attr.margins.top+")").style("pointer-events","all");u.axisFn.x.tickFormat(o.attr.xTickFormat);u.axes.x.attr("transform","translate(0,"+o.attr.innerHeight+")");u.axisFn.y.tickFormat(o.attr.yTickFormat);u.axes.y.attr("transform","translate(0,"+1+")");u.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");u.labels.x.attr("x",o.attr.innerWidth+"px").attr("y",o.attr.innerHeight+2.2*o.attr.fontSize+"px").style("fill",o.attr.fontColor).style("font-size",o.attr.fontSize+"px").text(o.attr.xLabel);u.labels.y.attr("x",5+"px").attr("y",-5+"px").style("fill",o.attr.fontColor).style("font-size",o.attr.fontSize+"px").text(o.attr.yLabel)}}t.prototype=Object.create(a.prototype);return t});