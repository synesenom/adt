(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"),exports)}else if(typeof define==="function"&&define.amd){define(["d3","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.ChordChart=e(t.d3,t.du.Widget)}})(this,function(t,e){"use strict";function r(r,n){var a=e.call(this,r,"chordchart","svg",n);a.attr.add(this,"radius",100,"dim");a.attr.add(this,"thickness",10,"dim");a.attr.add(this,"ticks",false);a.attr.add(this,"invert",false);var i={};var o=[];var s=t.map();var u=t.map();var c=10;var l=null;this.data=function(e){s.clear();u.clear();o=[];var r=0,n=0;e.forEach(function(t){if(!s.has(n=t.source)){u.set(r,n);s.set(n,r++)}if(!s.has(n=t.target)){u.set(r,n);s.set(n,r++)}});e.forEach(function(t){var e=s.get(t.source),n=s.get(t.target),a=o[e];if(!a){a=o[e]=[];for(var i=0;i<r;i++)a[i]=0}a[n]=t.value;if(!o[n]){o[n]=[];for(i=0;i<r;i++)o[n][i]=0}});c=t.max(u.values(),function(t){return t.length});return this};function d(e){var r={};var n=t.scaleOrdinal(t.schemeCategory10);e.forEach(function(t){r[u.get(t.index)]=n(t.index)});return r}function f(t){return t.source.index<t.target.index?t.source.index+"-"+t.target.index:t.target.index+"-"+t.source.index}function g(e){var r=t.map();if(e){e.groups.forEach(function(t){r.set(t.index,t)})}return function(e){var n;var a=r.get(e.index);if(a){n=t.interpolate(a,e)}else{var o={startAngle:e.startAngle,endAngle:e.startAngle};n=t.interpolate(o,e)}return function(t){return i.arc(n(t))}}}function h(e){var r=t.map();if(e){e.forEach(function(t){r.set(f(t),t)})}return function(n){var a;var o=r.get(f(n));if(o){if(n.source.index!==o.source.index){o={source:o.target,target:o.source}}a=t.interpolate(o,n)}else{if(e){var s=e.groups.filter(function(t){return t.index===n.source.index||t.index===n.target.index});o={source:s[0],target:s[1]||s[0]};if(o.source&&n.source.index!==o.source.index){o={source:o.target,target:o.source}}}else o=n;var u=o.source?o.source.startAngle:0;var c=o.target?o.target.startAngle:0;var l={source:{startAngle:u,endAngle:u},target:{startAngle:c,endAngle:c}};a=t.interpolate(l,n)}return function(t){return i.ribbonFn(a(t))}}}this.highlight=function(t,e){return a.utils.highlight(this,i,".ribbon",t,e)};a.render.build=function(){i.g=a.widget.append("g");i.chordFn=t.chord().padAngle(.05).sortGroups(t.descending).sortSubgroups(t.descending);i.arc=t.arc();i.ribbonFn=t.ribbon();i.label=i.g.append("text").attr("text-anchor","middle").attr("stroke-width","0px").style("fill","white")};a.render.update=function(t){var e=a.attr.radius-a.attr.thickness-a.attr.margins.left,r=a.attr.radius-a.attr.margins.left;if(i.groups)i.groups.transition();if(i.newGroups)i.newGroups.transition();if(i.ribbons)i.ribbons.transition();if(i.newRibbons)i.newRibbons.transition();i.chord=i.chordFn(o);if(a.attr.colors===null){a.attr.colors=d(i.chord.groups)}i.arc.innerRadius(e).outerRadius(r);i.groups=i.g.selectAll(".group").data(i.chord.groups,function(t){return t.index});i.newGroups=i.groups.enter().append("g").each(function(t){t.name=u.get(t.index)}).attr("class","group").style("pointer-events","all").on("mouseover",function(t){a.attr.mouseover&&a.attr.mouseover(t.name)}).on("mouseleave",function(t){a.attr.mouseleave&&a.attr.mouseleave(t.name)}).on("click",function(t){a.attr.click&&a.attr.click(t.name)});i.newGroups.append("path").attr("id",function(t){return"group"+t.index}).style("fill",function(t){return a.attr.colors[t.name]}).transition().duration(t).attrTween("d",g(l));if(a.attr.ticks){i.newGroups.append("text").attr("xlink:href",function(t){return"#group"+t.index}).attr("dy",".35em").text(function(t){return t.name}).attr("transform",function(t){t.angle=(t.startAngle+t.endAngle)/2;return"rotate("+(t.angle*180/Math.PI-90)+")"+" translate("+(a.attr.radius-a.attr.margins.left+5)+")"+(t.angle>Math.PI?" rotate(180)":" rotate(0)")}).attr("text-anchor",function(t){return t.angle>Math.PI?"end":"begin"})}i.groups.exit().transition().duration(t).style("opacity",0).remove();i.groups.select("path").each(function(t){t.name=u.get(t.index)}).attr("d",i.arc).transition().duration(t).style("fill",function(t){return a.attr.colors[t.name]}).attrTween("d",g(l));if(a.attr.ticks){i.groups.select("text").transition().duration(t).attr("transform",function(t){t.angle=(t.startAngle+t.endAngle)/2;return"rotate("+(t.angle*180/Math.PI-90)+")"+" translate("+(a.attr.radius-a.attr.margins.left+5)+")"+(t.angle>Math.PI?" rotate(180)":" rotate(0)")}).attr("text-anchor",function(t){return t.angle>Math.PI?"end":"begin"})}i.ribbonFn.radius(e);i.ribbons=i.g.selectAll(".ribbon").data(i.chord,f);i.newRibbons=i.ribbons.enter().append("path").each(function(t){t.source.name=u.get(t.source.index);t.target.name=u.get(t.target.index)}).attr("class",function(t){return"ribbon "+a.utils.encode(t.source.name)}).style("pointer-events","all").style("fill",function(t){return a.attr.colors[a.attr.invert?t.source.name:t.target.name]}).style("stroke-width","1px").style("fill-opacity",.8).style("stroke-opacity",.8).style("stroke","white");i.newRibbons.transition().duration(t).attrTween("d",h(null));i.ribbons.exit().transition().duration(t).style("opacity",0).remove();i.ribbons.each(function(t){t.source.name=u.get(t.source.index);t.target.name=u.get(t.target.index)}).attr("class",function(t){return"ribbon "+a.utils.encode(t.source.name)}).transition().duration(t).style("fill",function(t){return a.attr.colors[a.attr.invert?t.source.name:t.target.name]}).attrTween("d",h(l));l=i.chord};a.render.style=function(){a.attr.width=2*a.attr.radius;a.attr.height=2*a.attr.radius;a.widget.style("width",a.attr.width+"px").style("height",a.attr.height+"px");i.g.attr("transform","translate("+a.attr.radius+","+a.attr.radius+")");if(a.attr.ticks){i.newGroups.selectAll("text").style("font-size",a.attr.fontSize*.8+"px").style("font-weight",a.attr.fontWeight).style("fill",a.attr.fontColor)}i.label.attr("transform","translate(0,"+a.attr.radius+")").style("width",2*(a.attr.radius+a.attr.thickness)+"px").attr("font-size",a.attr.fontSize+"px").style("fill",a.attr.fontColor).text(a.attr.label)}}r.prototype=Object.create(e.prototype);return r});