(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.ViolinPlot=e(t.d3,t.du.Widget)}})(this,function(p,n){"use strict";function t(t,e){var u=n.call(this,t,"violinplot","svg",e);function c(n,e){return function(t){return e.map(function(e){return{x:e,y:p.mean(t,function(t){return n(e-t)})}})}}function m(e){return function(t){return Math.abs(t/=e)<=1?.75*(1-t*t)/e:0}}var a={};var r=[];var i=null;var f=0;var d=1;var o={};var s=false;this.data=function(t){var e=t.reduce(function(t,e){return t.concat(e.values)},[]);f=p.min(e);d=p.max(e);r=t.map(function(t){var e=t.values.sort(p.ascending),n=p.min(e),a=p.max(e),r=p.quantile(e,.25),i=p.quantile(e,.75),o=.2*(a-n);var s=c(m(.05*(a-n)),p.range(21).map(function(t){return(a-n+2*o)*t/20+(n-o)}));var l=s(t.values);return{name:t.name,scale:{x:p.scaleLinear().domain([f,d]).range([u.attr.innerHeight,0]),y:p.scaleLinear().range([10,0]).domain([0,p.max(l,function(t){return t.y})])},values:{min:n,max:a,mean:p.mean(e),median:p.median(e),q1:r,q3:i,data:l}}});return this};this.highlight=function(t,e){if(!s)u.utils.highlight(this,a,".violin",t,e);return this};u.utils.tooltip=function(){return i?{title:i.name,stripe:o[i.name],content:{type:"metrics",data:[{label:"min/max:",value:i.values.min.toPrecision(3)+"/"+i.values.max.toPrecision(3)},{label:"mean:",value:i.values.mean.toPrecision(3)},{label:"median:",value:i.values.median.toPrecision(3)},{label:"Q1:",value:i.values.q1.toPrecision(3)},{label:"Q3:",value:i.values.q3.toPrecision(3)}]}}:null};u.render.build=function(){a=u.utils.standardAxis();a.plots={}};u.render.update=function(t){a.scale={x:u.utils.scale(r.map(function(t){return t.name}).reverse(),[u.attr.innerWidth,0],"point"),y:u.utils.scale(r.map(function(t){return[t.values.min-.1*(t.values.max-t.values.min),t.values.max+.1*(t.values.max-t.values.min)]}).reduce(function(t,e){return t.concat(e)},[]),[u.attr.innerHeight,0])};a.axes.x.transition().duration(t).call(a.axisFn.x.scale(a.scale.x));a.axes.y.transition().duration(t).call(a.axisFn.y.scale(a.scale.y));o=u.utils.colors(r?r.map(function(t){return t.name}):null);a.plots.groups=a.g.selectAll(".box-group").data(r,function(t){return t.name});a.plots.groups.exit().style("opacity",0).remove();var e=a.plots.groups.enter().append("g").attr("class",function(t){return"box-group "+u.utils.encode(t.name)}).style("shape-rendering","geometricPrecision").style("opacity",0).style("fill","transparent");var n=e.merge(a.plots.groups).each(function(){s=true}).attr("transform",function(t){return"translate("+a.scale.x(t.name)+",0)"}).on("mouseover",function(t){i=t;u.attr.mouseover&&u.attr.mouseover(t.name)}).on("mouseleave",function(t){i=null;u.attr.mouseleave&&u.attr.mouseleave(t.name)}).on("click",function(t){u.attr.click&&u.attr.click(t.name)});n.transition().duration(t).attr("transform",function(t){return"translate("+a.scale.x(t.name)+",0)"}).style("opacity",1).style("fill-opacity",.3).style("fill",function(t){return o[t.name]}).style("stroke",function(t){return o[t.name]}).on("end",function(){s=false});e.append("path").attr("transform","rotate(90) translate(0,-"+(10+.5)+")");n.select("path").transition().duration(t).attr("d",function(e){e.scale.x.range([u.attr.innerHeight,0]);var t=p.area().curve(p.curveBasis).x(function(t){return e.scale.x(Math.min(d,Math.max(f,t.x)))}).y0(function(t){return e.scale.y(-t.y)}).y1(function(t){return e.scale.y(t.y)});return t(e.values.data)}).attr("transform","rotate(90) translate(0,-"+(10+.5)+")")};u.render.style=function(){a.g.style("width",u.attr.innerWidth+"px").style("height",u.attr.innerHeight+"px").attr("transform","translate("+u.attr.margins.left+","+u.attr.margins.top+")").style("pointer-events","all");a.axes.x.attr("transform","translate(0,"+u.attr.innerHeight+")");a.axisFn.y.tickFormat(u.attr.yTickFormat);a.axes.y.attr("transform","translate(0,"+1+")");a.labels.x.attr("x",u.attr.innerWidth+"px").attr("y",u.attr.innerHeight+2.2*u.attr.fontSize+"px").attr("fill",u.attr.fontColor).style("font-size",u.attr.fontSize+"px").text(u.attr.xLabel);a.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",u.attr.fontColor).style("font-size",u.attr.fontSize+"px").text(u.attr.yLabel)}}t.prototype=Object.create(n.prototype);return t});