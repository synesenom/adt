(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","d3-contour","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.TrajectoryPlot=e(t.d3,t.du.Widget)}})(this,function(t,r){"use strict";function e(t,e){var u=r.call(this,t,"trajectoryplot","svg",e);u.attr.add(this,"boundary",[0,1,0,1]);u.attr.add(this,"maxLength",10);u.attr.add(this,"background",{});u.attr.add(this,"fadeExp",0);u.attr.add(this,"animate",false);var p={};var a=[];var m=null;var d=null;var n=false;var y={};this.data=function(t){a=t.map(function(a){return{name:a.name,values:a.values.sort(function(t,e){return t.t-e.t}).filter(function(t,e){return e>=a.values.length-u.attr.maxLength}).map(function(t,e,r){return{name:a.name,t:t.t,x:t.x,y:t.y,r:Math.exp(-u.attr.fadeExp*(1-e/r.length)),last:e===r.length-1}})}});return this};this.highlight=function(t,e){if(!n)u.utils.highlight(this,p,".trajectory",t,e);return this};this.addMarker=function(t,e,r,a,n,o){if(y.hasOwnProperty(t)){return null}var i=n?n/2:7;var s=p.g.append("g").attr("class","marker "+u.utils.encode(r));var l=s.append("circle").attr("cx",p.scale.x(a[0])+2).attr("cy",p.scale.y(a[1])).attr("r",u.attr.animate?1.5*i:i).style("stroke-width","2px").style("stroke","white").style("fill",d[r]);if(u.attr.animate){l.transition().duration(700).attr("r",i)}var c={key:r,g:s,update:function(t){s.select("circle").on("mouseover",function(){m={name:e,type:"marker",info:o||"Information not available."};u.attr.mouseover&&u.attr.mouseover(r)}).on("mouseleave",function(){m=null;u.attr.mouseleave&&u.attr.mouseleave(r)}).on("click",function(){u.attr.click&&u.attr.click(r)}).transition().duration(t).attr("cx",p.scale.x(a[0])+2).attr("cy",p.scale.y(a[1])).style("fill",d[this.key])}};y[t]=c;return c};this.removeMarker=function(t){if(y.hasOwnProperty(t)){y[t].g.remove();delete y[t];return true}return false};u.utils.tooltip=function(t){if(!t||m===null){this.pm&&this.pm.remove();this.pm=null;this.mm&&this.mm.remove();this.mm=null;m=null;return null}switch(m.type){case"marker":this.pm&&this.pm.remove();this.pm=null;this.mm&&this.mm.remove();this.mm=null;return{title:u.attr.tooltipTitleFormat(m.name+" (marker)"),stripe:d[m.name],content:{type:"metrics",data:[{label:m.info}]}};case"movement":this.mm=this.mm||p.g.append("line");this.mm.attr("x1",p.scale.x(m.data[0].x)).attr("y1",p.scale.y(m.data[0].y)).attr("x2",p.scale.x(m.data[1].x)).attr("y2",p.scale.y(m.data[1].y)).style("pointer-events","none").style("stroke-width","2px").style("stroke","black").style("fill","none").style("display",null);this.pm&&this.pm.remove();this.pm=null;return{title:u.attr.tooltipTitleFormat(m.name+" (movement)"),stripe:d[m.name],content:{type:"metrics",data:[{label:"from: "+u.attr.tooltipZFormat(m.data[0].t)+", ("+u.attr.tooltipXFormat(m.data[0].x)+", "+u.attr.tooltipYFormat(m.data[0].y)+")"},{label:"to: &nbsp;&nbsp;"+u.attr.tooltipZFormat(m.data[1].t)+", ("+u.attr.tooltipXFormat(m.data[1].x)+", "+u.attr.tooltipYFormat(m.data[1].y)+")"}]}};case"position":this.pm=this.pm||p.g.append("circle");this.pm.attr("r",6).attr("cx",p.scale.x(m.data.x)).attr("cy",p.scale.y(m.data.y)).style("pointer-events","none").style("stroke-width","2px").style("stroke","white").style("fill","black").style("display",null);this.mm&&this.mm.remove();this.mm=null;return{title:u.attr.tooltipTitleFormat(m.name+" (position)"),stripe:d[m.name],content:{type:"metrics",data:[{label:"location: ("+u.attr.tooltipXFormat(m.data.x)+", "+u.attr.tooltipYFormat(m.data.y)+")"},{label:"time: &nbsp;&nbsp;&nbsp;&nbsp;"+u.attr.tooltipZFormat(m.data.t)}]}};default:return null}};u.render.build=function(){p=u.utils.standardAxis();p.plots={};p.backgroundPattern=p.g.append("defs").append("pattern").attr("id","trajectory-background-"+u.utils.encode(t)).attr("patternUnits","userSpaceOnUse").attr("width",u.attr.innerWidth).attr("height",u.attr.innerHeight);p.backgroundImage=p.backgroundPattern.append("image").attr("xlink:href",u.attr.background.path?u.attr.background.path:null).attr("preserveAspectRatio","none").attr("x",1).attr("y",0).attr("width",u.attr.innerWidth+"px").attr("height",u.attr.innerHeight+"px");p.background=p.g.append("rect").attr("x",1).attr("y",0).attr("width",u.attr.innerWidth+"px").attr("height",u.attr.innerHeight+"px").attr("stroke","none").attr("fill",u.attr.background.path?"url(#"+"trajectory-background-"+u.utils.encode(t)+")":"none").style("opacity",u.attr.background.opacity?u.attr.background.opacity:null)};u.render.update=function(t){p.scale={x:u.utils.scale([u.attr.boundary[0],u.attr.boundary[1]],[0,u.attr.innerWidth]),y:u.utils.scale([u.attr.boundary[2],u.attr.boundary[3]],[u.attr.innerHeight,0])};p.axes.x.transition().duration(t).call(p.axisFn.x.tickValues(u.attr.xTicks).scale(p.scale.x));p.axes.y.transition().duration(t).call(p.axisFn.y.tickValues(u.attr.yTicks).scale(p.scale.y));d=u.utils.colors(a?a.map(function(t){return t.name}):null);p.plots.trajectories=p.g.selectAll(".trajectory").data(a,function(t){return t.name});p.plots.trajectories.exit().transition().duration(t).style("opacity",0).remove();var e=p.plots.trajectories.enter().append("g").attr("class",function(t){return"trajectory "+u.utils.encode(t.name)}).style("shape-rendering","geometricPrecision").style("color",function(t){return d[t.name]});p.plots.trajectories=e.merge(p.plots.trajectories).each(function(){n=true});p.plots.trajectories.transition().duration(t).style("opacity",1).on("end",function(){n=false});p.plots.positions=p.plots.trajectories.selectAll(".position").data(function(t){return t.values},function(t){return t.t});p.plots.positions.exit().remove();p.plots.positions.enter().append("circle").attr("class",function(t){return"position position-"+t.t}).attr("cx",function(t){return p.scale.x(t.x)}).attr("cy",function(t){return p.scale.y(t.y)}).attr("r",u.attr.animate?10:1).style("stroke","none").style("fill","currentColor").merge(p.plots.positions).transition().duration(t).attr("r",1).style("opacity",function(t){return t.r});p.plots.movements=p.plots.trajectories.selectAll(".movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});p.plots.movements.exit().transition().duration(t).attr("x1",function(t){return p.scale.x(t[1].x)}).attr("y1",function(t){return p.scale.y(t[1].y)}).style("opacity",0).remove();p.plots.movements.enter().append("line").attr("class",function(t){return"movement movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","2px").style("stroke","currentColor").style("fill","none").attr("x1",function(t){return p.scale.x(t[0].x)}).attr("y1",function(t){return p.scale.y(t[0].y)}).attr("x2",function(t){return p.scale.x(t[0].x)}).attr("y2",function(t){return p.scale.y(t[0].y)}).merge(p.plots.movements).transition().duration(t).attr("x2",function(t){return p.scale.x(t[1].x)}).attr("y2",function(t){return p.scale.y(t[1].y)}).style("opacity",function(t){return(t[0].r+t[1].r)/2});p.plots.fakeMovements=p.plots.trajectories.selectAll(".fake-movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});p.plots.fakeMovements.exit().remove();p.plots.fakeMovements.enter().append("line").attr("class",function(t){return"fake-movement fake-movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","8px").style("stroke","transparent").style("fill","none").attr("x1",function(t){return p.scale.x(t[0].x)}).attr("y1",function(t){return p.scale.y(t[0].y)}).attr("x2",function(t){return p.scale.x(t[1].x)}).attr("y2",function(t){return p.scale.y(t[1].y)}).merge(p.plots.fakeMovements).on("mouseover",function(t){m={name:t[0].name,type:"movement",data:t};u.attr.mouseover&&u.attr.mouseover(t[0].name)}).on("mouseleave",function(t){m=null;u.attr.mouseleave&&u.attr.mouseleave(t[0].name)}).on("click",function(t){u.attr.click&&u.attr.click(t[0].name)});p.plots.fakePositions=p.plots.trajectories.selectAll(".fake-position").data(function(t){return t.values},function(t){return t.t});p.plots.fakePositions.exit().remove();p.plots.fakePositions.enter().append("circle").attr("class",function(t){return"fake-position fake-position-"+t.t}).attr("cx",function(t){return p.scale.x(t.x)}).attr("cy",function(t){return p.scale.y(t.y)}).attr("r",5).style("stroke","none").style("fill","transparent").merge(p.plots.fakePositions).on("mouseover",function(t){m={name:t.name,type:"position",data:t};u.attr.mouseover&&u.attr.mouseover(t.name)}).on("mouseleave",function(t){m=null;u.attr.mouseleave&&u.attr.mouseleave(t.name)}).on("click",function(t){u.attr.click&&u.attr.click(t.name)});for(var r in y){if(y.hasOwnProperty(r)){y[r].update(t)}}p.backgroundImage.attr("xlink:href",u.attr.background.path?u.attr.background.path:null)};u.render.style=function(){p.g.attr("width",u.attr.innerWidth+"px").attr("height",u.attr.innerHeight+"px").attr("transform","translate("+u.attr.margins.left+","+u.attr.margins.top+")").style("pointer-events","all");p.axisFn.x.tickFormat(u.attr.xTickFormat);p.axes.x.attr("transform","translate(0,"+u.attr.innerHeight+")");p.axisFn.y.tickFormat(u.attr.yTickFormat);p.axes.y.attr("transform","translate(0,"+1+")");p.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");p.labels.x.attr("x",u.attr.innerWidth+"px").attr("y",u.attr.innerHeight+2.2*u.attr.fontSize+"px").attr("fill",u.attr.fontColor).style("font-size",u.attr.fontSize+"px").text(u.attr.xLabel);p.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",u.attr.fontColor).style("font-size",u.attr.fontSize+"px").text(u.attr.yLabel);p.backgroundPattern.attr("width",u.attr.innerWidth).attr("height",u.attr.innerHeight);p.backgroundImage.attr("width",u.attr.innerWidth+"px").attr("height",u.attr.innerHeight+"px");p.background.attr("width",u.attr.innerWidth+"px").attr("height",u.attr.innerHeight+"px").attr("fill",u.attr.background.path?"url(#"+"trajectory-background-"+u.utils.encode(t)+")":"none").style("opacity",u.attr.background.opacity?u.attr.background.opacity:null)}}e.prototype=Object.create(r.prototype);return e});