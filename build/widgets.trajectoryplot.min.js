(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","d3-contour","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.TrajectoryPlot=e(t.d3,t.du.Widget)}})(this,function(t,r){"use strict";function e(t,e){var l=r.call(this,t,"trajectoryplot","svg",e);l.attr.add(this,"boundary",[0,1,0,1]);l.attr.add(this,"maxLength",10);l.attr.add(this,"background",{});l.attr.add(this,"animate",false);var c={};var a=[];var u=null;var p=null;var n=false;var m={};this.data=function(t){a=t.map(function(a){return{name:a.name,values:a.values.sort(function(t,e){return t.t-e.t}).filter(function(t,e){return e>=a.values.length-l.attr.maxLength}).map(function(t,e,r){return{name:a.name,t:t.t,x:t.x,y:t.y,r:Math.min(1,e/r.length),last:e===r.length-1}})}});return this};this.highlight=function(t,e){if(!n)l.utils.highlight(this,c,".trajectory",t,e);return this};this.addMarker=function(t,e,r,a,n){if(m.hasOwnProperty(t)){return null}var i=c.g.append("g").attr("class","marker "+l.utils.encode(r));var o=i.append("circle").attr("cx",c.scale.x(a[0])+2).attr("cy",c.scale.y(a[1])).attr("r",l.attr.animate?10:7).style("stroke-width","2px").style("stroke","white").style("fill",p[r]);if(l.attr.animate){o.transition().duration(700).attr("r",7)}var s={key:r,g:i,update:function(t){i.select("circle").on("mouseover",function(){u={name:e,type:"marker",data:n};l.attr.mouseover&&l.attr.mouseover(r)}).on("mouseleave",function(){u=null;l.attr.mouseleave&&l.attr.mouseleave(r)}).on("click",function(){l.attr.click&&l.attr.click(r)}).transition().duration(t).attr("cx",c.scale.x(a[0])+2).attr("cy",c.scale.y(a[1])).style("fill",p[this.key])}};m[t]=s;return s};this.removeMarker=function(t){if(m.hasOwnProperty(t)){m[t].g.remove();delete m[t];return true}return false};l.utils.tooltip=function(t){if(!t||u===null){this.pm&&this.pm.remove();this.pm=null;this.mm&&this.mm.remove();this.mm=null;u=null;return null}switch(u.type){case"marker":this.pm&&this.pm.remove();this.pm=null;this.mm&&this.mm.remove();this.mm=null;return{title:l.attr.tooltipTitleFormat(u.name+" (marker)"),stripe:p[u.name],content:{type:"metrics",data:[{label:"data: "+JSON.stringify(u.data)}]}};case"movement":this.mm=this.mm||c.g.append("line");this.mm.attr("x1",c.scale.x(u.data[0].x)).attr("y1",c.scale.y(u.data[0].y)).attr("x2",c.scale.x(u.data[1].x)).attr("y2",c.scale.y(u.data[1].y)).style("pointer-events","none").style("stroke-width","2px").style("stroke","black").style("fill","none").style("display",null);this.pm&&this.pm.remove();this.pm=null;return{title:l.attr.tooltipTitleFormat(u.name+" (movement)"),stripe:p[u.name],content:{type:"metrics",data:[{label:"from: "+l.attr.tooltipZFormat(u.data[0].t)+", ("+l.attr.tooltipXFormat(u.data[0].x)+", "+l.attr.tooltipYFormat(u.data[0].y)+")"},{label:"to: &nbsp;&nbsp;"+l.attr.tooltipZFormat(u.data[1].t)+", ("+l.attr.tooltipXFormat(u.data[1].x)+", "+l.attr.tooltipYFormat(u.data[1].y)+")"}]}};case"position":this.pm=this.pm||c.g.append("circle");this.pm.attr("r",6).attr("cx",c.scale.x(u.data.x)).attr("cy",c.scale.y(u.data.y)).style("pointer-events","none").style("stroke-width","2px").style("stroke","white").style("fill","black").style("display",null);this.mm&&this.mm.remove();this.mm=null;return{title:l.attr.tooltipTitleFormat(u.name+" (position)"),stripe:p[u.name],content:{type:"metrics",data:[{label:"location: ("+l.attr.tooltipXFormat(u.data.x)+", "+l.attr.tooltipYFormat(u.data.y)+")"},{label:"time: &nbsp;&nbsp;&nbsp;&nbsp;"+l.attr.tooltipZFormat(u.data.t)}]}};default:return null}};l.render.build=function(){c=l.utils.standardAxis();c.plots={};c.backgroundPattern=c.g.append("defs").append("pattern").attr("id","trajectory-background-"+l.utils.encode(t)).attr("patternUnits","userSpaceOnUse").attr("width",l.attr.innerWidth).attr("height",l.attr.innerHeight);c.backgroundImage=c.backgroundPattern.append("image").attr("xlink:href",l.attr.background.path?l.attr.background.path:null).attr("preserveAspectRatio","none").attr("x",1).attr("y",0).attr("width",l.attr.innerWidth+"px").attr("height",l.attr.innerHeight+"px");c.background=c.g.append("rect").attr("x",1).attr("y",0).attr("width",l.attr.innerWidth+"px").attr("height",l.attr.innerHeight+"px").attr("stroke","none").attr("fill",l.attr.background.path?"url(#"+"trajectory-background-"+l.utils.encode(t)+")":"none").style("opacity",l.attr.background.opacity?l.attr.background.opacity:null)};l.render.update=function(t){c.scale={x:l.utils.scale([l.attr.boundary[0],l.attr.boundary[1]],[0,l.attr.innerWidth]),y:l.utils.scale([l.attr.boundary[2],l.attr.boundary[3]],[l.attr.innerHeight,0])};c.axes.x.transition().duration(t).call(c.axisFn.x.tickValues(l.attr.xTicks).scale(c.scale.x));c.axes.y.transition().duration(t).call(c.axisFn.y.tickValues(l.attr.yTicks).scale(c.scale.y));p=l.utils.colors(a?a.map(function(t){return t.name}):null);c.plots.trajectories=c.g.selectAll(".trajectory").data(a,function(t){return t.name});c.plots.trajectories.exit().transition().duration(t).style("opacity",0).remove();var e=c.plots.trajectories.enter().append("g").attr("class",function(t){return"trajectory "+l.utils.encode(t.name)}).style("shape-rendering","geometricPrecision").style("color",function(t){return p[t.name]});c.plots.trajectories=e.merge(c.plots.trajectories).each(function(){n=true});c.plots.trajectories.transition().duration(t).style("opacity",1).on("end",function(){n=false});c.plots.positions=c.plots.trajectories.selectAll(".position").data(function(t){return t.values},function(t){return t.t});c.plots.positions.exit().attr("r",1).transition().duration(t).style("opacity",0).remove();c.plots.positions.enter().append("circle").attr("class",function(t){return"position position-"+t.t}).attr("cx",function(t){return c.scale.x(t.x)}).attr("cy",function(t){return c.scale.y(t.y)}).attr("r",l.attr.animate?10:1).style("stroke","none").style("fill","currentColor").merge(c.plots.positions).transition().duration(t).attr("r",function(t){return t.last?5:1}).style("opacity",function(t){return t.last?1:t.r});c.plots.movements=c.plots.trajectories.selectAll(".movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});c.plots.movements.exit().transition().duration(t).attr("x1",function(t){return c.scale.x(t[1].x)}).attr("y1",function(t){return c.scale.y(t[1].y)}).style("opacity",0).remove();c.plots.movements.enter().append("line").attr("class",function(t){return"movement movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","2px").style("stroke","currentColor").style("fill","none").attr("x1",function(t){return c.scale.x(t[0].x)}).attr("y1",function(t){return c.scale.y(t[0].y)}).attr("x2",function(t){return c.scale.x(t[0].x)}).attr("y2",function(t){return c.scale.y(t[0].y)}).merge(c.plots.movements).transition().duration(t).attr("x2",function(t){return c.scale.x(t[1].x)}).attr("y2",function(t){return c.scale.y(t[1].y)}).style("opacity",function(t){return(t[0].r+t[1].r)/2});c.plots.fakeMovements=c.plots.trajectories.selectAll(".fake-movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});c.plots.fakeMovements.exit().remove();c.plots.fakeMovements.enter().append("line").attr("class",function(t){return"fake-movement fake-movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","8px").style("stroke","transparent").style("fill","none").attr("x1",function(t){return c.scale.x(t[0].x)}).attr("y1",function(t){return c.scale.y(t[0].y)}).attr("x2",function(t){return c.scale.x(t[1].x)}).attr("y2",function(t){return c.scale.y(t[1].y)}).merge(c.plots.fakeMovements).on("mouseover",function(t){u={name:t[0].name,type:"movement",data:t};l.attr.mouseover&&l.attr.mouseover(t[0].name)}).on("mouseleave",function(t){u=null;l.attr.mouseleave&&l.attr.mouseleave(t[0].name)}).on("click",function(t){l.attr.click&&l.attr.click(t[0].name)});c.plots.fakePositions=c.plots.trajectories.selectAll(".fake-position").data(function(t){return t.values},function(t){return t.t});c.plots.fakePositions.exit().remove();c.plots.fakePositions.enter().append("circle").attr("class",function(t){return"fake-position fake-position-"+t.t}).attr("cx",function(t){return c.scale.x(t.x)}).attr("cy",function(t){return c.scale.y(t.y)}).attr("r",5).style("stroke","none").style("fill","transparent").merge(c.plots.fakePositions).on("mouseover",function(t){u={name:t.name,type:"position",data:t};l.attr.mouseover&&l.attr.mouseover(t.name)}).on("mouseleave",function(t){u=null;l.attr.mouseleave&&l.attr.mouseleave(t.name)}).on("click",function(t){l.attr.click&&l.attr.click(t.name)});for(var r in m){if(m.hasOwnProperty(r)){m[r].update(t)}}};l.render.style=function(){c.g.attr("width",l.attr.innerWidth+"px").attr("height",l.attr.innerHeight+"px").attr("transform","translate("+l.attr.margins.left+","+l.attr.margins.top+")").style("pointer-events","all");c.axisFn.x.tickFormat(l.attr.xTickFormat);c.axes.x.attr("transform","translate(0,"+l.attr.innerHeight+")");c.axisFn.y.tickFormat(l.attr.yTickFormat);c.axes.y.attr("transform","translate(0,"+1+")");c.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");c.labels.x.attr("x",l.attr.innerWidth+"px").attr("y",l.attr.innerHeight+2.2*l.attr.fontSize+"px").attr("fill",l.attr.fontColor).style("font-size",l.attr.fontSize+"px").text(l.attr.xLabel);c.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",l.attr.fontColor).style("font-size",l.attr.fontSize+"px").text(l.attr.yLabel);c.backgroundPattern.attr("width",l.attr.innerWidth).attr("height",l.attr.innerHeight);c.backgroundImage.attr("width",l.attr.innerWidth+"px").attr("height",l.attr.innerHeight+"px");c.background.attr("width",l.attr.innerWidth+"px").attr("height",l.attr.innerHeight+"px").attr("fill",l.attr.background.path?"url(#"+"trajectory-background-"+l.utils.encode(t)+")":"none").style("opacity",l.attr.background.opacity?l.attr.background.opacity:null)}}e.prototype=Object.create(r.prototype);return e});