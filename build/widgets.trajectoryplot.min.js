(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","d3-contour","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.TrajectoryPlot=e(t.d3,t.du.Widget)}})(this,function(t,e){"use strict";function r(n,t){var c=e.call(this,n,"trajectoryplot","svg",t);c.attr.add(this,"boundary",[0,1,0,1]);c.attr.add(this,"maxLength",10);c.attr.add(this,"fadeExp",0);c.attr.add(this,"animate",false);c.attr.add(this,"showHead",false);var d={};var a=[];var p=null;var f=null;var i=false;var y={};var o={};this.background=function(t){o=t;return this};this.data=function(t){a=t.map(function(n){return{name:n.name,values:n.values.sort(function(t,e){return t.t-e.t}).filter(function(t,e){return e>=n.values.length-c.attr.maxLength}).map(function(t,e,r){return{name:n.name,t:t.t,x:t.x,y:t.y,r:Math.exp(-c.attr.fadeExp*(1-e/r.length)),last:e===r.length-1}})}});return this};this.highlight=function(t,e){if(!i)c.utils.highlight(this,d,".trajectory",t,e);return this};this.addMarker=function(e,r,n,t,a){var i="marker-"+c.utils.encode(e);if(y.hasOwnProperty(i)){return null}var o=t?t/2:7;var l=d.g.select(".trajectory."+r).append("g").attr("class","marker marker-"+i+" "+c.utils.encode(r));var s=l.append("circle").attr("cx",d.scale.x(n[0])+2).attr("cy",d.scale.y(n[1])).attr("r",c.attr.animate?1.5*o:o).style("stroke-width","2px").style("stroke","white").style("fill",f[r]).style("pointer-events","all").on("mouseover",function(){p={key:r,name:e,type:"marker",info:a};c.attr.mouseover&&c.attr.mouseover(r)}).on("mouseleave",function(){p=null;c.attr.mouseleave&&c.attr.mouseleave(r)}).on("click",function(){c.attr.click&&c.attr.click(r)});if(c.attr.animate){s.transition().duration(700).attr("r",o)}var u={name:e,key:r,g:l,update:function(t){s.on("mouseover",function(){p={key:r,name:e,type:"marker",info:a};c.attr.mouseover&&c.attr.mouseover(r)}).on("mouseleave",function(){p=null;c.attr.mouseleave&&c.attr.mouseleave(r)}).on("click",function(){c.attr.click&&c.attr.click(r)}).transition().duration(t).attr("cx",d.scale.x(n[0])+2).attr("cy",d.scale.y(n[1])).style("fill",f[this.key])}};y[i]=u;return u};this.removeMarker=function(t){var e="marker-"+c.utils.encode(t);if(y.hasOwnProperty(e)){y[e].g.remove();delete y[e];return true}return false};this.getMarkers=function(){return Object.values(y).map(function(t){return t.name})};c.utils.tooltip=function(t){if(!t||p===null){p=null;return null}switch(p.type){case"marker":return{title:p.info.title,stripe:f[p.key],content:{type:"metrics",data:[{label:p.info.content}]}};default:return null}};c.render.build=function(){d=c.utils.standardAxis();d.plots={};d.backgroundPattern=d.g.append("defs").append("pattern").attr("id","trajectory-background-"+c.utils.encode(n)).attr("patternUnits","userSpaceOnUse").attr("width",c.attr.innerWidth).attr("height",c.attr.innerHeight);d.backgroundImage=d.backgroundPattern.append("image").attr("xlink:href",o!==null?o.path:null).attr("preserveAspectRatio","none").attr("x",1).attr("y",0).attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px");d.background=d.g.append("rect").attr("x",1).attr("y",0).attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px").attr("stroke","none").attr("fill",o.path?"url(#"+"trajectory-background-"+c.utils.encode(n)+")":"none").style("opacity",o!==null?o.opacity:null)};c.render.update=function(t){d.scale={x:c.utils.scale([c.attr.boundary[0],c.attr.boundary[1]],[0,c.attr.innerWidth]),y:c.utils.scale([c.attr.boundary[2],c.attr.boundary[3]],[c.attr.innerHeight,0])};d.axes.x.transition().duration(t).call(d.axisFn.x.tickValues(c.attr.xTicks).scale(d.scale.x));d.axes.y.transition().duration(t).call(d.axisFn.y.tickValues(c.attr.yTicks).scale(d.scale.y));f=c.utils.colors(a?a.map(function(t){return t.name}):null);d.plots.trajectories=d.g.selectAll(".trajectory").data(a,function(t){return t.name});d.plots.trajectories.exit().transition().duration(t).style("opacity",0).remove();var e=d.plots.trajectories.enter().append("g").attr("class",function(t){return"trajectory "+c.utils.encode(t.name)}).style("shape-rendering","geometricPrecision").style("stroke-linecap","round").style("color",function(t){return f[t.name]});d.plots.trajectories=e.merge(d.plots.trajectories).each(function(){i=true});d.plots.trajectories.transition().duration(t).style("opacity",1).on("end",function(){i=false});if(c.attr.showHead){d.plots.position=d.plots.trajectories.selectAll(".position").data(function(t){return t.values.slice(-1)},function(){return 0});d.plots.position.exit().transition().duration(t).style("opacity",0).remove();d.plots.position.enter().append("circle").attr("class","position").attr("cx",function(t){return d.scale.x(t.x)}).attr("cy",function(t){return d.scale.y(t.y)}).attr("r",c.attr.animate?10:1).style("stroke","none").style("fill","currentColor").style("pointer-events","none").merge(d.plots.position).transition().duration(t).attr("r",3).attr("cx",function(t){return d.scale.x(t.x)}).attr("cy",function(t){return d.scale.y(t.y)})}d.plots.movements=d.plots.trajectories.selectAll(".movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});d.plots.movements.exit().transition().duration(t).attr("x1",function(t){return d.scale.x(t[1].x)}).attr("y1",function(t){return d.scale.y(t[1].y)}).style("opacity",0).remove();d.plots.movements.enter().append("line").attr("class",function(t){return"movement movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","2px").style("stroke","currentColor").style("fill","none").attr("x1",function(t){return d.scale.x(t[0].x)}).attr("y1",function(t){return d.scale.y(t[0].y)}).attr("x2",function(t){return d.scale.x(t[0].x)}).attr("y2",function(t){return d.scale.y(t[0].y)}).style("pointer-events","none").merge(d.plots.movements).transition().duration(t).attr("x2",function(t){return d.scale.x(t[1].x)}).attr("y2",function(t){return d.scale.y(t[1].y)}).style("opacity",function(t){return(t[0].r+t[1].r)/2});d.plots.fakeMovements=d.plots.trajectories.selectAll(".fake-movement").data(function(r){return r.values.map(function(t,e){return e>0?[r.values[e-1],t]:null}).filter(function(t){return t!==null})},function(t){return t[0].t});d.plots.fakeMovements.exit().remove();d.plots.fakeMovements.enter().append("line").attr("class",function(t){return"fake-movement fake-movement-"+t[0].t+"-"+t[1].t}).style("stroke-width","8px").style("stroke","transparent").style("fill","none").attr("x1",function(t){return d.scale.x(t[0].x)}).attr("y1",function(t){return d.scale.y(t[0].y)}).attr("x2",function(t){return d.scale.x(t[1].x)}).attr("y2",function(t){return d.scale.y(t[1].y)});for(var r in y){if(y.hasOwnProperty(r)){y[r].update(t)}}if(o!==null){d.backgroundImage.attr("xlink:href",o.path?o.path:null);d.background.attr("fill",o.path?"url(#"+"trajectory-background-"+c.utils.encode(n)+")":"none").style("opacity",o.opacity?o.opacity:null);o=null}};c.render.style=function(){d.g.attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px").attr("transform","translate("+c.attr.margins.left+","+c.attr.margins.top+")").style("pointer-events","all");d.axisFn.x.tickFormat(c.attr.xTickFormat);d.axes.x.attr("transform","translate(0,"+c.attr.innerHeight+")");d.axisFn.y.tickFormat(c.attr.yTickFormat);d.axes.y.attr("transform","translate(0,"+1+")");d.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");d.labels.x.attr("x",c.attr.innerWidth+"px").attr("y",c.attr.innerHeight+2.5*c.attr.fontSize+"px").attr("fill",c.attr.fontColor).style("font-size",c.attr.fontSize+"px").text(c.attr.xLabel);d.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",c.attr.fontColor).style("font-size",c.attr.fontSize+"px").text(c.attr.yLabel);d.backgroundPattern.attr("width",c.attr.innerWidth).attr("height",c.attr.innerHeight);d.backgroundImage.attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px");d.background.attr("width",c.attr.innerWidth+"px").attr("height",c.attr.innerHeight+"px")}}r.prototype=Object.create(e.prototype);return r});