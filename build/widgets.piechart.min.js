(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("./widget"),exports)}else if(typeof define==="function"&&define.amd){define(["d3","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.PieChart=e(t.d3,t.du.Widget)}})(this,function(t,e){"use strict";function r(r,a){var n=e.call(this,r,"piechart","svg",a);n.attr.add(this,"innerRadius",0,"dim");n.attr.add(this,"outerRadius",50,"dim");n.attr.add(this,"ticks",false);var i={};var u=[];var l={};var o=null;var s=false;function d(t){return t.data?t.data.name:""}function c(t,e,r,a){var n;return(n=f(t,e,r,a))?{startAngle:n.endAngle,endAngle:n.endAngle}:(n=h(t,e,r,a))?{startAngle:n.startAngle,endAngle:n.startAngle}:null}function f(t,e,r,a){var n=e.length;while(--t>=0){var i=a(r[t]);for(var u=0;u<n;++u){if(a(e[u])===i)return e[u]}}}function h(t,e,r,a){var n=r.length,i=e.length;while(++t<n){var u=a(r[t]);for(var l=0;l<i;++l){if(a(e[l])===u)return e[l]}}}function m(e){var r=t.interpolate(this._current,e);this._current=r(0);return function(t){return i.arc(r(t))}}function g(e){var r=t.interpolate(this._current,e);this._current=r(0);return function(t){return"translate("+i.arcLabel.centroid(r(t))+")"}}this.data=function(t){u=t;return this};this.highlight=function(t,e){if(!s){n.utils.highlight(this,i,"path",t,e);n.utils.highlight(this,i,"text",t,e)}return this};n.utils.tooltip=function(){return o?{title:o.name,stripe:n.attr.colors[o.name],content:{type:"metrics",data:[{label:"value:",value:o.value.toFixed(6)},{label:"fraction:",value:(100*o.value/t.sum(u,function(t){return t.value})).toFixed(1)+"%"}]}}:null};n.render.build=function(){i.g=n.widget.append("g");i.label=i.g.append("text").attr("text-anchor","middle").attr("stroke-width","0px").style("fill","white")};n.render.update=function(e){i.arc=t.arc().outerRadius(n.attr.outerRadius-n.attr.margins.left).innerRadius(n.attr.innerRadius);i.arcLabel=t.arc().outerRadius(.5*(n.attr.innerRadius+n.attr.outerRadius-n.attr.margins.left)).innerRadius(.5*(n.attr.innerRadius+n.attr.outerRadius-n.attr.margins.left));var r=t.pie().value(function(t){return t.value}).sort(null);l=n.utils.colors(u?u.map(function(t){return t.name}):null);var a=i.g.selectAll(".slice");var f=i.g.selectAll(".label");var h=a.data(),v=r(u);a=a.data(v,d);a.exit().datum(function(t,e){return c(e,v,h,d)||t}).transition().duration(e).attrTween("d",m).remove();a.enter().append("path").attr("class",function(t){return"slice "+n.utils.encode(t.data.name)}).each(function(t,e){this._current=c(e,h,v,d)||t}).style("pointer-events","all").merge(a).each(function(){s=true}).attr("fill",function(t){return l[t.data.name]}).on("mouseover",function(t){o=t.data;n.attr.mouseover&&n.attr.mouseover(t.data.name)}).on("mouseleave",function(t){o=null;n.attr.mouseleave&&n.attr.mouseleave(t.data.name)}).on("click",function(t){n.attr.click&&n.attr.click(t.data.name)}).transition().duration(e).style("opacity",1).attrTween("d",m).on("end",function(){s=false});f=f.data(v,d);f.exit().datum(function(t,e){return c(e,v,h,d)||t}).transition().duration(e).style("opacity",0).attrTween("transform",g).remove();f.enter().append("text").attr("class",function(t){return"label "+n.utils.encode(t.data.name)}).each(function(t,e){this._current=c(e,h,v,d)||t}).merge(f).attr("dy","0.35em").style("text-anchor","middle").style("pointer-events","none").attr("fill",n.attr.fontColor).text(function(e){return n.attr.tickFormat(100*e.data.value/t.sum(v,function(t){return t.value}))}).transition().duration(e).attrTween("transform",g)};n.render.style=function(){n.attr.colors=n.utils.colors(u?u.map(function(t){return t.name}):null);var t=n.attr.outerRadius-n.attr.margins.left;n.attr.width=2*n.attr.outerRadius;n.attr.height=2*n.attr.outerRadius;n.widget.style("width",n.attr.width+"px").style("height",n.attr.height+"px");i.g.attr("transform","translate("+n.attr.outerRadius+","+n.attr.outerRadius+")");i.label.attr("transform","translate(0,"+n.attr.outerRadius+")").style("width",10+2*n.attr.outerRadius+"px").style("font-size",Math.min(16,n.attr.outerRadius*.4)+"px").style("fill",n.attr.fontColor).text(n.attr.label)}}r.prototype=Object.create(e.prototype);return r});