(function(t,r){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=r(require("d3"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","d3-contour","src/widget","exports"],r)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.ContourPlot=r(t.d3,t.du.Widget)}})(this,function(x,a){"use strict";function t(t,r){var s=a.call(this,t,"contourplot","svg",r);s.attr.add(this,"layers",20);s.attr.add(this,"grid",[40,40]);s.attr.add(this,"borders",false);var u={};var c=[];var d=null;var f=null;var o=false;this.data=function(t){c={xDomain:x.extent(t,function(t){return t.x}),yDomain:x.extent(t,function(t){return t.y}),values:new Array(s.attr.grid[0]*s.attr.grid[1]).fill(0)};var a=(c.xDomain[1]-c.xDomain[0])/s.attr.grid[0],n=(c.yDomain[1]-c.yDomain[0])/s.attr.grid[1];t.forEach(function(t){var r=Math.floor((t.x-c.xDomain[0])/a),e=Math.floor((t.y-c.yDomain[0])/n);c.values[r+e*s.attr.grid[0]]+=t.value||1});return this};this.highlight=function(t,r){if(!o)s.utils.highlight(this,u,".contour",t,r);return this};s.utils.tooltip=function(t){if(f===null||!t){return null}var r=u.scale.x.invert(t[0]),e=u.scale.y.invert(t[1]);var a=(c.xDomain[1]-c.xDomain[0])/s.attr.grid[0],n=(c.yDomain[1]-c.yDomain[0])/s.attr.grid[1];var o=Math.floor((r-c.xDomain[0])/a),i=s.attr.grid[1]-Math.floor((e-c.yDomain[0])/n);var l=c.values[o+s.attr.grid[0]*i];if(typeof l==="undefined"){return null}return{title:s.attr.tooltipTitleFormat(l),stripe:d(f.value),content:{type:"metrics",data:[{label:s.attr.xLabel+":",value:s.attr.tooltipXFormat(r)},{label:s.attr.yLabel+":",value:s.attr.tooltipYFormat(e)}]}}};function e(s,u,c){return function(){var a=x.select(".contour-"+u).node(),n=a.cloneNode(),o=a.getTotalLength(),i=(n.setAttribute("d",s),n).getTotalLength();var t=[0],r=0,e=c/Math.max(o,i);while((r+=e)<1){t.push(r)}var l=t.map(function(t){var r=a.getPointAtLength(t*o),e=n.getPointAtLength(t*i);return x.interpolate([r.x,r.y],[e.x,e.y])});return function(r){return r<1?"M"+l.map(function(t){return t(r)}).join("L"):s}}}s.render.build=function(){u=s.utils.standardAxis();u.plots={}};s.render.update=function(t){u.scale={x:s.utils.scale(c.xDomain,[0,s.attr.innerWidth]),y:s.utils.scale(c.yDomain,[s.attr.innerHeight,0])};var r=x.interpolateHsl(s.attr.colors?s.attr.colors[0]:"transparent",s.attr.colors?s.attr.colors[1]:"grey"),e=x.interpolateHsl(s.attr.colors?s.attr.colors[1]:"grey",s.attr.colors?s.attr.colors[2]:"black"),a=function(t){return t<.5?r(t*2):e((t-.5)*2)};d=x.scaleSequential(a).domain(x.extent(c.values));var n=x.contours().size([s.attr.grid[0],s.attr.grid[1]]).thresholds(s.attr.layers)(c.values);u.axes.x.transition().duration(t).call(u.axisFn.x.tickValues(s.attr.xTicks).scale(u.scale.x));u.axes.y.transition().duration(t).call(u.axisFn.y.tickValues(s.attr.yTicks).scale(u.scale.y));u.plots.contours=u.g.selectAll(".contour").data(n,function(t,r){return r});u.plots.contours.exit().remove();u.plots.contours.enter().append("path").attr("class",function(t,r){return"contour contour-"+r}).attr("d",x.geoPath()).attr("transform","translate(1, 0) scale("+s.attr.innerWidth/s.attr.grid[0]+","+s.attr.innerHeight/s.attr.grid[1]+")").attr("fill",function(t){return d(t.value)}).attr("stroke",s.attr.borders?"#fff":"none").attr("stroke-width",function(t,r){return s.attr.borders&&r!==0?"0.1px":"0px"}).style("opacity",0).merge(u.plots.contours).each(function(){o=true}).on("mouseover",function(t,r){f=t;s.attr.mouseover&&s.attr.mouseover("contour-"+r)}).on("mouseleave",function(t,r){f=null;s.attr.mouseleave&&s.attr.mouseleave("contour-"+r)}).on("click",function(t,r){s.attr.click&&s.attr.click("contour-"+r)}).transition().duration(t).style("opacity",1).attr("d",x.geoPath()).style("fill",function(t){return d(t.value)}).on("end",function(){o=false})};s.render.style=function(){u.g.attr("width",s.attr.innerWidth+"px").attr("height",s.attr.innerHeight+"px").attr("transform","translate("+s.attr.margins.left+","+s.attr.margins.top+")").style("pointer-events","all");u.axisFn.x.tickFormat(s.attr.xTickFormat);u.axes.x.attr("transform","translate(0,"+s.attr.innerHeight+")");u.axisFn.y.tickFormat(s.attr.yTickFormat);u.axes.y.attr("transform","translate(0,"+1+")");u.g.selectAll(".tick > line").style("shape-rendering","geometricPrecision").style("stroke-width","1px");u.labels.x.attr("x",s.attr.innerWidth+"px").attr("y",s.attr.innerHeight+2.8*s.attr.fontSize+"px").attr("fill",s.attr.fontColor).style("font-size",s.attr.fontSize+"px").text(s.attr.xLabel);u.labels.y.attr("x",5+"px").attr("y",-5+"px").attr("fill",s.attr.fontColor).style("font-size",s.attr.fontSize+"px").text(s.attr.yLabel)}}t.prototype=Object.create(a.prototype);return t});