(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e(require("d3"),require("lodash"),require("topojson"),require("leaflet"),require("./widget"))}else if(typeof define==="function"&&define.amd){define(["d3","_","topojson","leaflet","src/widget","exports"],e)}else{t.du=t.du||{};t.du.widgets=t.du.widgets||{};t.du.widgets.Map=e(t.d3,t._,t.topojson,t.L,t.du.Widget)}})(this,function(t,e,r,n,a){"use strict";var o=function(t){var e=t||[1,0];this.x=function(){return e[0]};this.y=function(){return e[1]};this.length=function(t){var r=Math.sqrt(e[0]*e[0]+e[1]*e[1]);if(typeof t==="number"){var n=t/r;return new o(e.map(function(t){return t*n}))}return r};this.angle=function(t){var r=Math.atan2(e[1],e[0]);if(typeof t==="number"){var n=Math.sqrt(e[0]*e[0]+e[1]*e[1]);return new o([n*Math.cos(t),n*Math.sin(t)])}return r};this.toArray=function(){return[e[0],e[1]]};this.map=function(t){return new o(t(e))};this.add=function(t){return new o([e[0]+t.x(),e[1]+t.y()])};this.sub=function(t){return new o([e[0]-t.x(),e[1]-t.y()])};this.mult=function(t){return new o(e.map(function(e){return e*t}))}};var i=function(t){var e=t||[1,0,0];this.x=function(){return e[0]};this.y=function(){return e[1]};this.z=function(){return e[2]};this.length=function(t){var r=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);if(typeof t==="number"){return new i(e.map(function(e){return e*t/r}))}return r};this.toLatLon=function(){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return new s([Math.asin(e[2]/t),Math.atan2(e[1],e[0])].map(function(t){return t*180/Math.PI}))};this.add=function(t){return new i([e[0]+t.x(),e[1]+t.y(),e[2]+t.z()])};this.mult=function(t){return new i(e.map(function(e){return e*t}))};this.dot=function(t){return e[0]*t.x()+e[1]*t.y()+e[2]*t.z()};this.cross=function(t){return new i([e[1]*t.z()-e[2]*t.y(),e[2]*t.x()-e[0]*t.z(),e[0]*t.y()-e[1]*t.x()])}};var s=function(t){var e=t||[0,0];this.toArray=function(){return[e[0],e[1]]};this.toVec=function(){var t=e[0]*Math.PI/180,r=e[1]*Math.PI/180;var n=Math.cos(t);return new i([n*Math.cos(r),n*Math.sin(r),Math.sin(t)])}};function l(i,l){var u="du-widgets-map";var c=a.call(this,i,"map","div",l);var f=this;c.attr.add(this,"resource",null);c.attr.add(this,"centerX",0);c.attr.add(this,"centerY",0);c.attr.add(this,"backgroundColor","white");c.attr.add(this,"foregroundColor","black");c.attr.add(this,"borderColor","white");c.attr.add(this,"outClick",null);c.attr.add(this,"tiles",null);c.attr.add(this,"noZoom",false);c.attr.add(this,"ready",null);var h=function(){var e=null;var n=null;var a=t.map();function o(o){t.json(c.attr.resource,function(i,s){e=r.feature(s.paths,s.paths["objects"]["countries"]).features;e.filter(function(t){return s.info.some(function(e){if(t.id===e.id)return t.name=e.name})}).sort(function(t,e){return t.name.localeCompare(e.name)});n=t.map();s.info.forEach(function(t){n.set(t.name,{name:t.name,capital:t.capital,population:t.population})});e.forEach(function(t,e){a.set(t.name,e)});o&&o()})}function i(t){return a.has(t)?a.get(t):null}function s(){return e.map(function(t){return{id:t.id,name:t.name}})}function l(t){return t&&n.has(t)?n.get(t).capital:n.values().map(function(t){return{name:t.name,capital:t.capital}})}function u(t){return t&&n.has(t)?n.get(t).population:n.values().map(function(t){return{name:t.name,population:t.population}})}function f(t,e){var r,n,a,o,i,s=t[0],l=t[1],u=false;for(var c=0,f=e.length-1;c<e.length;f=c++){r=e[c][0];a=e[c][1];n=e[f][0];o=e[f][1];i=a>l!==o>l&&s<(n-r)*(l-a)/(o-a)+r;if(i)u=!u}return u}function d(t,e){var r=h._id(t);if(r){var n=v._project(e);var a=h._paths()[r].svg.areas;for(var o=0;o<a.length;o++){if(f(n,a[o])){return true}}}return false}return{_paths:function(){return e},_id:i,_build:o,get:s,capital:l,population:u,containsGeoLoc:d}}();this.countries={get:h.get,capital:h.capital,population:h.population,containsGeoLoc:h.containsGeoLoc};var d=function(){var t={};function r(t,e){return c.utils.encode(t)+"__"+c.utils.encode(e)}function n(e){if(e&&t.hasOwnProperty(e)){return Object.keys(t[e])}else{return Object.keys(t)}}function a(e,r){if(!t.hasOwnProperty(e)){t[e]=r;return true}else{return false}}function o(n){if(t.hasOwnProperty(n)){e.forOwn(t[n],function(t,e){var a=r(n,e);t.forEach(function(t){if(typeof h._id(t)==="number"){v._select(t).classed(a,false)}})});return true}else{return false}}function i(){e.forOwn(t,function(t,n){e.forOwn(t,function(t,e){var a=r(n,e);t.forEach(function(t){if(typeof h._id(t)==="number"){v._select(t).classed(a,true)}})})})}return{get:n,add:a,remove:o,selector:r,_mark:i}}();this.clustering={get:d.get,add:d.add,remove:d.remove,selector:d.selector};var p=function(){var e=128;var r=.3;var n={};var a=t.zoomIdentity;var o=1;var i=t.zoom().scaleExtent([1,e]).on("zoom",d);function s(t){return a.apply(t)}function l(t){return a.invert(t)}function u(){return o}function f(){i.translateExtent([[-r*c.attr.width,-r*c.attr.height],[(1+r)*c.attr.width,(1+r)*c.attr.height]])}function h(t,e){n[t]=e}function d(){if(c.attr.noZoom){return}var e=t.event.transform.k;n.map.paths.style("stroke-width",.5/e+"px");n.map.paths.attr("transform",t.event.transform);g._zoom(t.event.transform);y._zoom(t.event.transform);m._zoom(t.event.transform);w._zoom(t.event.transform);if(t.event&&t.event.transform){a=t.zoomIdentity.translate(t.event.transform.x,t.event.transform.y).scale(t.event.transform.k);o=t.event.transform.k}}function p(){n.map.svg.transition().duration(1e3).call(i.transform,t.zoomIdentity)}function v(r){var a=r[1][0]-r[0][0],o=r[1][1]-r[0][1],s=(r[0][0]+r[1][0])/2,l=(r[0][1]+r[1][1])/2,u=Math.max(1,Math.min(e,.8/Math.max(a/c.attr.width,o/c.attr.height))),f=[c.attr.width/2-u*s,c.attr.height/2-u*l];n.map.svg.transition().duration(1e3).call(i.transform,t.zoomIdentity.translate(f[0],f[1]).scale(u))}function b(){return a}return{init:f,setLayer:h,zoom:i,reset:p,click:v,transform:s,invert:l,level:u,current:b}}();var v=function(){var e=c.widget.append("svg").attr("id",u+"-map-layer").style("position","absolute").call(p.zoom);var r=e.append("rect").attr("id","water").style("position","absolute").style("width","100%").style("height","100%").style("fill","transparent").style("top",0).style("left",0);var n=e.append("g").attr("id","land");var a=null;var o=t.geoMercator().precision(.1);var i=t.geoPath().projection(o);var s=null;function l(t){return o([t[1],t[0]])}function d(t){return o.invert(t).reverse()}function v(){h._paths().forEach(function(t){t.svg.center=i.centroid(t)})}function y(){h._paths().forEach(function(e){var r=[];var n=[];var a=e.geometry.coordinates;if(a.length===1){a[0].forEach(function(t){var a=o(t);r.push(Math.abs(a[0]-e.svg.center[0]));n.push(Math.abs(a[1]-e.svg.center[1]))})}else{a.forEach(function(t){t[0].forEach(function(t){var a=o(t);r.push(Math.abs(a[0]-e.svg.center[0]));n.push(Math.abs(a[1]-e.svg.center[1]))});if(t.length>1){t.forEach(function(t){var a=o(t);r.push(Math.abs(a[0]-e.svg.center[0]));n.push(Math.abs(a[1]-e.svg.center[1]))})}})}e.svg.width=t.max(r)*2;e.svg.height=t.max(n)*2})}function g(){h._paths().forEach(function(t){t.svg.areas=null;if(t.geometry.coordinates.length===1){var e=[];t.geometry.coordinates[0].forEach(function(t){e.push(o(t))});t.svg.areas=[e]}else{t.svg.areas=[];t.geometry.coordinates.forEach(function(e){var r=[];if(e.length>1){e.forEach(function(t){r.push(o(t))})}else{e[0].forEach(function(t){r.push(o(t))})}t.svg.areas.push(r)})}})}function m(t){if(t.geometry.coordinates.length===1){return i.centroid(t)}else{var e={type:"Feature",geometry:{type:"Polygon",coordinates:t.geometry.coordinates[0]}};for(var r=1;r<t.geometry.coordinates.length;r++){var n={type:"Feature",geometry:{type:"Polygon",coordinates:t.geometry.coordinates[r]}};if(i.area(n)>i.area(e)){e=n}}var a=i.centroid(e);if(isNaN(a[0])||isNaN(a[1]))return i.centroid(t);else return a}}function w(){a=n.selectAll("path").data(h._paths()).enter().append("path").attr("class",function(t){return"country-"+h._id(t.name)}).style("stroke-width","0.5px").style("cursor","pointer");b();x()}function b(){if(a===null){return}o.scale(c.attr.width/(2*Math.PI)).translate([c.attr.width/2+c.attr.centerX,c.attr.height/2+c.attr.centerY]);i=t.geoPath().projection(o);h._paths().forEach(function(t){t.svg={}});v();y();g()}function x(){if(a===null){return}e.attr("width",c.attr.width+"px").attr("height",c.attr.height+"px");r.style("fill",c.attr.backgroundColor).style("width",c.attr.width+"px").style("height",c.attr.height+"px").on("click",function(){p.reset();a.classed("focus",false).style("fill",function(t){return c.attr.colors&&c.attr.colors[t.name]?c.attr.colors[t.name]:c.attr.foregroundColor});if(c.attr.outClick)c.attr.outClick()});a.attr("d",i).style("fill",function(t){return c.attr.colors&&c.attr.colors[t.name]?c.attr.colors[t.name]:c.attr.foregroundColor}).style("stroke",c.attr.borderColor).style("cursor","pointer").on("mouseover",function(e,r){t.select(this).style("fill",t.color(c.attr.colors&&c.attr.colors[e.name]?c.attr.colors[e.name]:c.attr.foregroundColor).brighter());c.attr.mouseover&&c.attr.mouseover(e.name)}).on("mouseleave",function(e,r){var n=t.select(this);var a=t.color(c.attr.colors&&c.attr.colors[e.name]?c.attr.colors[e.name]:c.attr.foregroundColor);n.style("fill",n.classed("focus")?a.brighter():a);c.attr.mouseleave&&c.attr.mouseleave(e.name)}).on("click",function(e,r){var n=t.select(this);var o=n.classed("focus");if(o)p.reset();else{p.click(i.bounds(e))}a.classed("focus",function(t){return t===e?!o:false}).style("fill",function(t){return c.attr.colors&&c.attr.colors[t.name]?c.attr.colors[t.name]:c.attr.foregroundColor});var s=t.color(c.attr.colors&&c.attr.colors[e.name]?c.attr.colors[e.name]:c.attr.foregroundColor);n.style("fill",!o?s.brighter():s);c.attr.click&&c.attr.click(e.name)});p.setLayer("map",{svg:e,paths:a,labels:s})}function _(t){if(typeof t==="string"){return h._id(t)?n.select("path.country-"+h._id(t)):n.selectAll("path."+c.utils.encode(t))}else{return a}}function M(t){a.style("opacity",t?t:1);return f}function k(e,r,n){_(e).transition().duration(n?n:0).style("fill",function(n){var a=c.attr.colors&&c.attr.colors[n.name]?c.attr.colors[n.name]:c.attr.foregroundColor;return typeof r==="string"?r:typeof e==="string"?t.color(a).brighter():a});return f}return{_select:_,_project:l,_invert:d,_build:w,_update:b,_style:x,dim:M,highlight:k}}();this.dim=v.dim;this.highlight=v.highlight;var y=function(){var t=c.widget.append("div").attr("id",u+"-static-layers").style("position","absolute").style("pointer-events","none").style("width",c.attr.width+"px").style("height",c.attr.height+"px");var r={};function n(t,e,r){return[e[0]*t[0]+r[0],e[1]*t[1]+r[1]]}function a(){return Object.keys(r)}function i(e){var a=c.utils.encode(e);if(!r.hasOwnProperty(a)){r[a]=function(){var e=t.append("canvas").attr("id",u+"-static-layer-"+a).attr("width",c.attr.width+"px").attr("height",c.attr.height+"px").style("position","absolute").style("pointer-events","none");var r=e.node().getContext("2d");var i=[];function s(t,e){h[t](e);i.push({type:t,params:e});return true}function l(t,e){var r=[1/t,1/t],a=[c.attr.centerX*(t-1)/t,(c.attr.height*(t-e)/2+c.attr.centerY*(t-1))/t];i.forEach(function(t){switch(t.type){case"dot":case"circle":t.params.pos=n(t.params.pos,r,a);break;case"arrow":for(var e=0;e<t.params.segments.length;e++){t.params.segments[e]=new o(n(t.params.segments[e].toArray(),r,a))}break}})}function f(){i=[]}var h={dot:function(t,e){if(t.color)r.fillStyle=t.color;var n=t.size/(e?p.level():1);var a=!e?p.transform(t.pos):t.pos;r.fillRect(a[0]-n/2,a[1]-n/2,n,n)},circle:function(t,e){if(t.color)r.fillStyle=t.color;var n=t.radius/(e?p.level():1);var a=!e?p.transform(t.pos):t.pos;r.beginPath();r.arc(a[0],a[1],n,0,2*Math.PI,false);r.fill()},arrow:function(t,e){if(t.color)r.strokeStyle=t.color;var n=t.width/(e?p.level():1);var a=[];t.segments.forEach(function(t){a.push(!e?t.map(p.transform):t)});var o=n*2;var i=n*5;var s=a[a.length-2];var l=a[a.length-1];var u=l.sub(s).length(i);r.beginPath();r.lineWidth=n;r.lineJoin="round";r.moveTo(a[0].x(),a[0].y());for(var f=1;f<a.length-1;f++){if(a[f].sub(a[f-1]).length()<.6*c.attr.width)r.lineTo(a[f].x(),a[f].y());else r.moveTo(a[f].x(),a[f].y())}var h=l.sub(u.length(.5*i));r.lineTo(h.x(),h.y());r.stroke();var d=u.angle(u.angle()+Math.PI/2).length(o);var v=l.sub(u).sub(d);var y=l.sub(u).add(d);r.beginPath();r.moveTo(v.x(),v.y());r.lineTo(y.x(),y.y());r.lineTo(l.x(),l.y());r.closePath();r.fillStyle=t.color;r.fill()}};function d(){var t=p.invert([0,0]);var e=p.invert([c.attr.width,c.attr.height]);var r={xMin:t[0],xMax:e[0],yMin:t[1],yMax:e[1]};i.forEach(function(t){if(t.params.pos&&(t.params.pos[0]<r.xMin||t.params.pos[0]>r.xMax||t.params.pos[1]<r.yMin||t.params.pos[1]>r.yMax)){return}h[t.type](t.params,true)})}return{g:e,canvas:r,rescaleContent:l,clearContent:f,append:s,render:d}}();return true}else{return false}}function l(){var n=parseFloat(t.style("width"))/c.attr.width;var a=parseFloat(t.style("height"))/c.attr.height;t.style("width",c.attr.width+"px").style("height",c.attr.height+"px");e.forOwn(r,function(t){t.g.attr("width",c.attr.width+"px").attr("height",c.attr.height+"px");t.rescaleContent(n,a);t.render()});x(p.current())}function h(t){var e=c.utils.encode(t);if(r.hasOwnProperty(e)){r[e].canvas.clearRect(0,0,c.attr.width,c.attr.height);r[e].clearContent();return true}else{return false}}function d(){e.forOwn(r,function(t){t.canvas.save();t.canvas.clearRect(0,0,c.attr.width,c.attr.height)})}function g(t){var n=c.utils.encode(t);if(n&&r.hasOwnProperty(n)){e.forOwn(r,function(t,e){t.g.transition().duration(100).style("opacity",n===e?1:0)})}else{e.forOwn(r,function(t){t.g.transition().duration(100).style("opacity",1)})}return f}function m(t){e.forOwn(r,function(e){e.render(t)})}function w(){e.forOwn(r,function(t){t.canvas.restore()})}var b={dot:function(t,e,n,a){if(!e||e.length<2||typeof e[0]!=="number"||typeof e[1]!=="number")return false;var o=c.utils.encode(t);return r.hasOwnProperty(o)&&r[o].append("dot",{pos:v._project(e),size:n,color:a})},circle:function(t,e,n,a){if(!e||e.length<2||typeof e[0]!=="number"||typeof e[1]!=="number")return false;if(typeof n!=="number"||isNaN(n)||n<=0)return false;var o=c.utils.encode(t);return r.hasOwnProperty(o)&&r[o].append("circle",{pos:v._project(e),radius:n,color:a})},arrow:function(t,e,n,a,i){if(!e||e.length<2||typeof e[0]!=="number"||typeof e[1]!=="number")return false;if(!n||n.length<2||typeof n[0]!=="number"||typeof n[1]!=="number")return false;if(typeof a!=="number")return false;var l=c.utils.encode(t);if(r.hasOwnProperty(l)){var u=new s(e).toVec(),f=new s(n).toVec(),h=u.cross(f).cross(u).length(1),d=Math.acos(u.dot(f));var p=1,y=100,g=a*5,m=new o(v._project(e)),w=new o(v._project(n)),b=m,x=[b];do{var _=new o(v._project(u.mult(Math.cos((p+1)*d/y)).add(h.mult(Math.sin((p+1)*d/y))).toLatLon().toArray()));p++;b=_;x.push(_)}while(p<y&&_.sub(w).length()>g);x.push(w);r[l].append("arrow",{segments:x,width:a,color:i});return true}else{return false}}};function x(t){y._clear();e.forOwn(r,function(e){e.canvas.translate(t.x,t.y);e.canvas.scale(t.k,t.k)});y._render(t.k);y._restore()}return{_style:l,_zoom:x,_clear:d,_restore:w,_render:m,get:a,add:i,highlight:g,erase:h,draw:b}}();this.staticLayer={get:y.get,add:y.add,erase:y.erase,highlight:y.highlight,draw:y.draw};var g=function(){var t=c.widget.append("div").attr("id",u+"-tiles-layer").style("position","absolute").style("pointer-events","none").style("z-index",99).style("opacity",.5).style("width",c.attr.width+"px").style("height",c.attr.height+"px");var e=null;function r(t){return v._invert([t[0]-.5*c.attr.width,t[1]+.5*c.attr.height])}function a(t){return Math.log(.00391382924*t*c.attr.width)/Math.log(2)}function o(){if(c.attr.tiles===null){return}e=n.map(u+"-tiles-layer",{attributionControl:false,zoomSnap:0,zoomControl:false}).setView(r([0,0]),a(p.level()));var t=null,o=null;switch(c.attr.tiles){case"cartodb-positron":t="https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png";o="abcd";break}if(t&&o){n.tileLayer(t,{subdomains:o}).addTo(e)}}function i(){if(e===null){return}t.style("width",c.attr.width+"px").style("height",c.attr.height+"px");e.invalidateSize()}function s(t){if(e===null){return}e.setView(r([-t.x/t.k-.5*(t.k-1)*c.attr.width/t.k,-t.y/t.k-.5*(t.k-1)*c.attr.height/t.k]),a(t.k),true)}return{_build:o,_style:i,_getLatLon:r,_getZoom:a,_zoom:s}}();var m=function(){var r=c.widget.append("div").attr("id",u+"-dynamic-layers").style("position","absolute").style("pointer-events","none");var n={};function a(){return Object.keys(n)}function i(e){var a=c.utils.encode(e);if(!n.hasOwnProperty(a)){n[a]=function(){var e=r.append("svg").attr("id",u+"-dynamic-layer-"+a).attr("width",c.attr.width+"px").attr("height",c.attr.height+"px").style("position","absolute").style("pointer-events","none").append("g");var n=[];function o(t){n.push({elem:t,birth:(new Date).getTime()/1e3})}setInterval(function(){var e=(new Date).getTime()/1e3;var r=[];n.forEach(function(n){if(e-n.birth>10){n.elem.transition().duration(700).style("opacity",0).on("end",function(){t.select(this).remove()})}else{r.push(n)}});n=r},2e3);return{g:e,append:o}}();return true}else{return false}}function l(){r.style("width",c.attr.width+"px").style("height",c.attr.height+"px");e.forOwn(n,function(t){t.g.attr("width",c.attr.width+"px").attr("height",c.attr.height+"px")})}function h(t){var e=c.utils.encode(t);if(n.hasOwnProperty(e)){n[e].g.html("");return true}else{return false}}function d(t){var r=c.utils.encode(t);if(r&&n.hasOwnProperty(r)){e.forOwn(n,function(t,e){t.g.transition().duration(200).style("opacity",r===e?1:0)})}else{e.forOwn(n,function(t){t.g.transition().duration(200).style("opacity",1)})}return f}var y={circle:function(e,r,a,o,i,s){if(!r||r.length<2||typeof r[0]!=="number"||typeof r[1]!=="number")return false;if(typeof a!=="number"||isNaN(a)||a<=0)return false;var l=c.utils.encode(e);if(n.hasOwnProperty(l)){var u=a/p.level();var f=v._project(r);var h=n[l].g.append("circle").attr("class","circle").attr("cx",f[0]).attr("cy",f[1]).attr("r",u).style("fill",o);n[l].append(h);h.transition().duration(i?i:700).ease(t.easeExp).attr("r",0).on("end",function(){s&&s();t.select(this).remove()});return true}else{return false}},arrow:function(e,r,a,i,l,u,f){if(!r||r.length<2||typeof r[0]!=="number"||typeof r[1]!=="number")return false;if(!a||a.length<2||typeof a[0]!=="number"||typeof a[1]!=="number")return false;if(typeof i!=="number")return false;var h=c.utils.encode(e);if(n.hasOwnProperty(h)){var d=100;var y=null;var g=null;var m=new o(v._project(r));var w=new o(v._project(a));var b=i/p.level();var x=b*2;var _=b*5;y=n[h].g.append("path").style("fill","none").style("stroke",l).style("stroke-width",b).attr("d","M"+m.x()+","+m.y());g=n[h].g.append("path").style("fill",l).style("stroke","none");var M=new s(r).toVec();var k=new s(a).toVec();var O=M.cross(k).cross(M).length(1);var P=Math.acos(M.dot(k));var z=1;var j=m;var C=(typeof u==="number"?u:700)/d;var E=setInterval(function(){var e=new o(v._project(M.mult(Math.cos((z+1)*P/d)).add(O.mult(Math.sin((z+1)*P/d))).toLatLon().toArray()));y.attr("d",y.attr("d")+(e.sub(j).length()<.5*c.attr.width?"L":"M")+e.x()+","+e.y());if(e.sub(j).length()<.5*c.attr.width){var r=e.sub(j).length(1);var n=r.angle(r.angle()+Math.PI/2).mult(x);var a=e.sub(n);var i=e.add(n);var s=e.add(r.mult(_));g.attr("d","M"+a.x()+","+a.y()+"L"+i.x()+","+i.y()+"L"+s.x()+","+s.y()+"Z")}if(e.sub(w).length()>_){z++;j=e}else{clearInterval(E);r=w.sub(e).length(1);n=r.angle(r.angle()+Math.PI/2).mult(x);a=w.sub(r.mult(_)).sub(n);i=w.sub(r.mult(_)).add(n);g.transition().duration(C).attr("d","M"+a.x()+","+a.y()+"L"+i.x()+","+i.y()+"L"+w.x()+","+w.y()+"Z").on("end",function(){f&&f();y.transition().duration(1e3).style("opacity",0).on("end",function(){t.select(this).remove()});t.select(this).transition().duration(1e3).style("opacity",0).on("end",function(){t.select(this).remove()})})}},C);return true}else{return false}}};function g(t){e.forOwn(n,function(e){e.g.attr("transform",t)})}return{_style:l,_zoom:g,get:a,add:i,highlight:d,erase:h,draw:y}}();this.dynamicLayer={get:m.get,add:m.add,highlight:m.highlight,erase:m.erase,draw:m.draw};var w=function(){var t=c.widget.append("svg").attr("id",u+"-touch-layer").attr("width",c.attr.width+"px").attr("height",c.attr.height+"px").style("position","absolute").style("pointer-events","none");var e=t.append("g");function r(t,r,n,a,o,i){if(!r||r.length<2||typeof r[0]!=="number"||typeof r[1]!=="number")return false;var s=n/p.level();var l=v._project(r);e.append("circle").attr("id",u+"-touch-layer-"+t).attr("cx",l[0]).attr("cy",l[1]).attr("r",s).style("fill",null).style("opacity",0).style("pointer-events","all").on("mouseover",function(t,e){if(a)a(t,e)}).on("mouseleave",function(t,e){if(o)o(t,e)}).on("click",function(t,e){if(i)i(t,e)});return true}function n(t){var r=e.select("#"+t);if(r.empty())return false;else{r.remove();return true}}function a(){t.style("width",c.attr.width+"px").style("height",c.attr.height+"px");e.style("width",c.attr.width+"px").style("height",c.attr.height+"px")}function o(t){e.attr("transform",t)}function i(){e.html("")}return{_style:a,_zoom:o,add:r,remove:n,erase:i}}();this.touchLayer={add:w.add,remove:w.remove,erase:w.erase};c.render.build=function(){h._build(function(){v._build();g._build();c.attr.ready&&c.attr.ready()})};c.render.update=function(){v._update()};c.render.style=function(){c.widget.style("background-color",c.attr.backgroundColor).style("pointer-events",null);p.init();v._style();y._style();m._style();g._style();w._style();d._mark()}}l.prototype=Object.create(a.prototype);return l});